# –û—Ç—á–µ—Ç –æ–± –∞–Ω–∞–ª–∏–∑–µ –ø–æ–¥–ø–∏—Å–æ–∫

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚úÖ 1. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–ª –ø–æ–¥–ø–∏—Å–∫—É
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–ª–∞—Ç–µ–∂ –ø–æ–º–µ—á–∞–ª—Å—è –∫–∞–∫ `completed`, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –ù–ï –ø—Ä–æ–¥–ª–µ–≤–∞–ª–∞—Å—å. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏–ª, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–ª –ø—Ä–æ–¥–ª–µ–Ω–∏–µ.

**–ú–µ—Å—Ç–∞:**
- `payments/services/payment_service.py:514-523`
- `bot/services/background_tasks.py:858-864`
- `bot/services/key_creation.py:1165-1176` (2 –º–µ—Å—Ç–∞ - –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∏ –∫—Ä–∏–ø—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –≤—Å–µ—Ö –µ—ë –∫–ª—é—á–µ–π –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.

### ‚úÖ 2. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `subscription_service.py:364` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `max(existing[4], expires_at)` –≤–º–µ—Å—Ç–æ –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞.

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
- –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 2 –¥–Ω—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 1 –¥–µ–Ω—å
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–æ –º–∞–∫—Å–∏–º—É–º–∞ (2 –¥–Ω—è), –∞ –Ω–µ –¥–æ 3 –¥–Ω–µ–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ `existing_expires_at + duration_sec` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞.

### ‚úÖ 3. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: –ö–ª—é—á–∏ –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–ª–∏—Å—å –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–ª—Å—è —Ç–æ–ª—å–∫–æ `expires_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `subscriptions`, –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å `expiry_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `v2ray_keys`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `expiry_at` –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏.

### ‚úÖ 4. –£–ª—É—á—à–µ–Ω–æ: –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞", —á—Ç–æ –Ω–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π –¥–∞—Ç–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### üîß 1. –í—ã–Ω–µ—Å—Ç–∏ –æ–±—â—É—é –ª–æ–≥–∏–∫—É –ø—Ä–æ–¥–ª–µ–Ω–∏—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:** –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 4+ –º–µ—Å—Ç–∞—Ö.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `extend_subscription_with_payment()` –≤ `SubscriptionService`:

```python
async def extend_subscription_with_payment(
    self,
    user_id: int,
    tariff_id: int,
    duration_sec: int
) -> Optional[Dict[str, Any]]:
    """–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Å—Ä–æ–∫"""
    existing = self.repository.get_active_subscription(user_id)
    if not existing:
        return None
    
    subscription_id = existing[0]
    existing_expires_at = existing[4]
    new_expires_at = existing_expires_at + duration_sec
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    self.repository.extend_subscription(subscription_id, new_expires_at)
    
    # –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏
    with get_db_cursor(commit=True) as cursor:
        cursor.execute(
            """
            UPDATE v2ray_keys 
            SET expiry_at = ? 
            WHERE subscription_id = ? AND expiry_at > ?
            """,
            (new_expires_at, subscription_id, int(time.time()))
        )
    
    return {
        'id': subscription_id,
        'token': existing[2],
        'expires_at': new_expires_at,
        'extended': True,
    }
```

### üîß 2. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–±–µ—Ä–Ω—É—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∫–ª—é—á–µ–π –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏.

### üîß 3. –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–æ–≤–æ–π –¥–∞—Ç–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è.

### üîß 4. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.

### üîß 5. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–π –ø–æ–¥–ø–∏—Å–æ–∫
- –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏

### üîß 6. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫.

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `bot/services/subscription_service.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
2. `payments/services/payment_service.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–µ–π
3. `bot/services/background_tasks.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö
4. `bot/services/key_creation.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –ø–ª–∞—Ç–µ–∂–µ–π (2 –º–µ—Å—Ç–∞)

## –°—Ç–∞—Ç—É—Å

‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
‚úÖ –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –∏ –º–µ—Ç—Ä–∏–∫–∏


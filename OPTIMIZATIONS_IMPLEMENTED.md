# –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–î–∞—Ç–∞: 2025-11-05

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Connection Pool –¥–ª—è –ë–î ‚ö°
**–§–∞–π–ª**: `utils.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ö–ª–∞—Å—Å `SQLiteConnectionPool` —Å –ø—É–ª–æ–º –∏–∑ 5 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- Thread-safe —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: -30-50% –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –ë–î

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å `SQLiteConnectionPool`
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `get_db_connection()` –∏ `get_db_cursor()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—É–ª–∞
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ PRAGMA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

---

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é ‚ö°
**–§–∞–π–ª**: `bot.py`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `SimpleCache` –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ `get_protocol_selection_menu()` –Ω–∞ 5 –º–∏–Ω—É—Ç
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ `get_tariff_menu()` –Ω–∞ 5 –º–∏–Ω—É—Ç —Å —É—á–µ—Ç–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: -60-80% –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –¥–ª—è –º–µ–Ω—é

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `SimpleCache` –∏–∑ `app.infra.cache`
- –°–æ–∑–¥–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π `_menu_cache`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `get_protocol_selection_menu()`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `get_tariff_menu()` —Å –∫–ª—é—á–∞–º–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `invalidate_menu_cache()` –¥–ª—è —Ä—É—á–Ω–æ–π –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ö—ç—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ TTL (5 –º–∏–Ω—É—Ç). –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤/—Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å `invalidate_menu_cache()`.

---

### 3. –ë–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö ‚ö°
**–§–∞–π–ª**: `bot.py` - —Ñ—É–Ω–∫—Ü–∏—è `notify_expiring_keys()`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- –°–±–æ—Ä –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Å–ø–∏—Å–æ–∫ `updates`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `executemany()` –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏: —Å–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –∑–∞—Ç–µ–º –±–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç**: -80-90% –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `notify_expiring_keys()`
- –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `notified` —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫
- –û–¥–∏–Ω `executemany()` –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö `UPDATE`
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å: –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î (~10-20ms –Ω–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
- –ú–µ–Ω—é: 2 SQL –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
- –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏: N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö UPDATE –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ó–∞–ø—Ä–æ—Å—ã: –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏–∑ –ø—É–ª–∞ (~1-2ms)
- –ú–µ–Ω—é: –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ –∏–ª–∏ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL
- –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏: 1 –º–∞—Å—Å–æ–≤—ã–π UPDATE –≤–º–µ—Å—Ç–æ N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ foreign keys
**–§–∞–π–ª**: `bot.py` - —Ñ—É–Ω–∫—Ü–∏—è `auto_delete_expired_keys()`

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—à–∏–±–∫–∞ `foreign key mismatch` –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ `v2ray_keys`

**–†–µ—à–µ–Ω–∏–µ**: 
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ foreign keys –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:
- ‚úÖ Connection pool –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±—É–¥—É—â–µ–µ

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
   - Hit rate –∫—ç—à–∞ –º–µ–Ω—é
   - –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –ë–î
   - –†–∞–∑–º–µ—Ä –±–∞—Ç—á–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

2. **–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞**: –í—ã–∑—ã–≤–∞—Ç—å `invalidate_menu_cache()` –≤ –∞–¥–º–∏–Ω–∫–µ –ø—Ä–∏:
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —Ç–∞—Ä–∏—Ñ–æ–≤
   - –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ (active, available_for_purchase)

3. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –°–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω
   - –°–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞ (—É–∂–µ –µ—Å—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Connection Pool**: –ü—É–ª —Å–æ–∑–¥–∞–µ—Ç 5 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø—É–ª–∞.

2. **–ö—ç—à –º–µ–Ω—é**: TTL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç. –ï—Å–ª–∏ –º–µ–Ω—é –º–µ–Ω—è–µ—Ç—Å—è —á–∞—â–µ, —É–º–µ–Ω—å—à–∏—Ç–µ TTL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é.

3. **–ë–∞—Ç—á–∏–Ω–≥**: –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–ª—é—á–µ–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ü—Ä–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –±–∞—Ç—á–∞—Ö (>1000) –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞–Ω–∫–∏.

---

*–í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã. –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.*


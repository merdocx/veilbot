# –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#1-–º–µ—Ç—Ä–∏–∫–∏-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
2. [–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π](#2-–æ–±—Ä–∞–±–æ—Ç–∫–∞-—á–∞—Å—Ç–∏—á–Ω–æ-—É—Å–ø–µ—à–Ω–æ–≥–æ-—Å–æ–∑–¥–∞–Ω–∏—è-–∫–ª—é—á–µ–π)
3. [–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫](#3-–ª–æ–≥–∏–∫–∞-–ø—Ä–æ–¥–ª–µ–Ω–∏—è-–∏—Å—Ç–µ–∫—à–∏—Ö-–ø–æ–¥–ø–∏—Å–æ–∫)
4. [–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫](#4-—É–ª—É—á—à–µ–Ω–∏–µ-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–æ—à–∏–±–æ–∫)
5. [–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π](#5-–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å-–æ–ø–µ—Ä–∞—Ü–∏–π)
6. [–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö](#6-–≤–∞–ª–∏–¥–∞—Ü–∏—è-–¥–∞–Ω–Ω—ã—Ö)
7. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#7-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)

---

## 1. –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–±–ª–µ–º–∞

–°–µ–π—á–∞—Å –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- –í—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π
- –ß–∞—Å—Ç–æ—Ç—ã –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏.

#### 1.1. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å –¥–ª—è –º–µ—Ç—Ä–∏–∫

```python
# payments/utils/metrics.py
import time
import logging
from typing import Dict, Optional
from datetime import datetime

class SubscriptionMetrics:
    """–ö–ª–∞—Å—Å –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫"""
    
    def __init__(self):
        self.logger = logging.getLogger(__name__)
        self.metrics = {}
    
    def record_processing_time(self, operation: str, duration: float, success: bool):
        """–ó–∞–ø–∏—Å–∞—Ç—å –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏"""
        key = f"{operation}_{'success' if success else 'failed'}"
        if key not in self.metrics:
            self.metrics[key] = {
                'count': 0,
                'total_time': 0.0,
                'min_time': float('inf'),
                'max_time': 0.0
            }
        
        self.metrics[key]['count'] += 1
        self.metrics[key]['total_time'] += duration
        self.metrics[key]['min_time'] = min(self.metrics[key]['min_time'], duration)
        self.metrics[key]['max_time'] = max(self.metrics[key]['max_time'], duration)
        
        avg_time = self.metrics[key]['total_time'] / self.metrics[key]['count']
        
        self.logger.info(
            f"[METRICS] {operation}",
            extra={
                'operation': operation,
                'duration': duration,
                'success': success,
                'avg_duration': avg_time,
                'min_duration': self.metrics[key]['min_time'],
                'max_duration': self.metrics[key]['max_time'],
                'count': self.metrics[key]['count']
            }
        )
    
    def record_key_creation(self, subscription_id: int, created: int, failed: int, total_servers: int):
        """–ó–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π"""
        success_rate = (created / total_servers * 100) if total_servers > 0 else 0
        
        self.logger.info(
            f"[METRICS] Key creation for subscription {subscription_id}",
            extra={
                'subscription_id': subscription_id,
                'keys_created': created,
                'keys_failed': failed,
                'total_servers': total_servers,
                'success_rate': success_rate
            }
        )
        
        # –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å < 50%
        if success_rate < 50 and total_servers > 1:
            self.logger.warning(
                f"[METRICS] Low success rate for subscription {subscription_id}: {success_rate}%"
            )
    
    def get_metrics_summary(self) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –º–µ—Ç—Ä–∏–∫"""
        return {
            'timestamp': datetime.now().isoformat(),
            'metrics': self.metrics
        }

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
metrics = SubscriptionMetrics()
```

#### 1.2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –∫–æ–¥

```python
# –í subscription_purchase_service.py

from ..utils.metrics import metrics

async def process_subscription_purchase(self, payment_id: str) -> Tuple[bool, Optional[str]]:
    start_time = time.time()
    try:
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
        
        success = True
        return True, None
    except Exception as e:
        success = False
        # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ ...
        return False, error_msg
    finally:
        duration = time.time() - start_time
        metrics.record_processing_time('subscription_purchase', duration, success)

async def _create_subscription(self, payment, tariff, now):
    start_time = time.time()
    try:
        # ... —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ ...
        
        # –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π
        metrics.record_key_creation(
            subscription_id=subscription_id,
            created=created_keys,
            failed=len(failed_servers),
            total_servers=len(servers)
        )
        
        return True, None
    finally:
        duration = time.time() - start_time
        metrics.record_processing_time('create_subscription', duration, success)
```

#### 1.3. –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è –º–µ—Ç—Ä–∏–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
# admin/routes/metrics.py
from fastapi import APIRouter
from payments.utils.metrics import metrics

router = APIRouter()

@router.get("/metrics/subscriptions")
async def get_subscription_metrics():
    """–ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫"""
    return metrics.get_metrics_summary()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 4-6 —á–∞—Å–æ–≤  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: 
- –í–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π

### –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:
- –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–ª—é—á ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π
- –ï—Å–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω –Ω–∏ –æ–¥–∏–Ω –∫–ª—é—á ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è

**–†–∏—Å–∫**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —Å –∫–ª—é—á–∞–º–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —á–∞—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤.

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–∞—Å—Ç–∏—á–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è.

#### 2.1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–ª–∏—Ç–∏–∫–∏

```python
# payments/config.py
from dataclasses import dataclass

@dataclass
class SubscriptionConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫"""
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    MIN_SUCCESS_RATE: float = 0.5  # 50%
    
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    MIN_KEYS_REQUIRED: int = 1
    
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    MAX_FAILED_SERVERS: int = 3

config = SubscriptionConfig()
```

#### 2.2. –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
# –í _create_subscription

from ..config import config

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π
if created_keys == 0:
    error_msg = f"Failed to create any keys for subscription {subscription_id}"
    logger.error(f"[SUBSCRIPTION] {error_msg}")
    await self.subscription_repo.deactivate_subscription_async(subscription_id)
    return False, error_msg

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
total_servers = len(servers)
success_rate = created_keys / total_servers if total_servers > 0 else 0

if success_rate < config.MIN_SUCCESS_RATE:
    logger.warning(
        f"[SUBSCRIPTION] Low success rate for subscription {subscription_id}: "
        f"{success_rate:.2%} ({created_keys}/{total_servers}). "
        f"Minimum required: {config.MIN_SUCCESS_RATE:.2%}"
    )
    
    # –†–µ—à–µ–Ω–∏–µ: –æ—Ç–∫–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º?
    # –í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫–∞—Ç–∏—Ç—å (—Å—Ç—Ä–æ–≥–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞)
    if created_keys < config.MIN_KEYS_REQUIRED:
        logger.error(
            f"[SUBSCRIPTION] Too few keys created ({created_keys} < {config.MIN_KEYS_REQUIRED}), "
            f"deactivating subscription {subscription_id}"
        )
        await self.subscription_repo.deactivate_subscription_async(subscription_id)
        return False, f"Failed to create minimum required keys ({created_keys}/{config.MIN_KEYS_REQUIRED})"
    
    # –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Å—Ç–∞–≤–∏—Ç—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º (–º—è–≥–∫–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞)
    logger.warning(
        f"[SUBSCRIPTION] Subscription {subscription_id} created with low success rate, "
        f"but keeping it active ({created_keys} keys created)"
    )
    
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –≤ metadata –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    # –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

logger.info(
    f"[SUBSCRIPTION] Created subscription {subscription_id} for user {payment.user_id}: "
    f"{created_keys} keys created, {len(failed_servers)} failed, "
    f"success_rate={success_rate:.2%}"
)
```

#### 2.3. –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è failed —Å–µ—Ä–≤–µ—Ä–æ–≤

```python
async def _retry_failed_servers(
    self,
    subscription_id: int,
    payment: Payment,
    tariff: Dict[str, Any],
    failed_servers: List[int],
    now: int,
    expires_at: int,
    max_retries: int = 2
) -> Tuple[int, List[int]]:
    """–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π –Ω–∞ failed —Å–µ—Ä–≤–µ—Ä–∞—Ö"""
    if not failed_servers:
        return 0, []
    
    logger.info(
        f"[SUBSCRIPTION] Retrying key creation for {len(failed_servers)} failed servers "
        f"for subscription {subscription_id}"
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ failed —Å–µ—Ä–≤–µ—Ä–∞—Ö
    async with open_async_connection(self.db_path) as conn:
        async with conn.execute(
            """
            SELECT id, name, api_url, api_key, domain, v2ray_path
            FROM servers
            WHERE id IN ({})
            """.format(','.join('?' * len(failed_servers))),
            failed_servers
        ) as cursor:
            servers = await cursor.fetchall()
    
    retried_created = 0
    still_failed = []
    
    for server_id, server_name, api_url, api_key, domain, v2ray_path in servers:
        # ... –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞ (—Ç–∞ –∂–µ —á—Ç–æ –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ) ...
        try:
            # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞
            # ...
            retried_created += 1
        except Exception as e:
            logger.error(f"[SUBSCRIPTION] Retry failed for server {server_id}: {e}")
            still_failed.append(server_id)
    
    logger.info(
        f"[SUBSCRIPTION] Retry completed for subscription {subscription_id}: "
        f"{retried_created} created, {len(still_failed)} still failed"
    )
    
    return retried_created, still_failed
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 6-8 —á–∞—Å–æ–≤  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ì–∏–±–∫–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å retry –¥–ª—è failed —Å–µ—Ä–≤–µ—Ä–æ–≤

---

## 3. –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞:
```python
new_expires_at = existing_expires_at + tariff['duration_sec']
```

**–†–∏—Å–∫**: –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ –¥–∞–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ—Å—è—Ü –Ω–∞–∑–∞–¥), –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–∞—á–Ω–µ—Ç—Å—è —Å –ø—Ä–æ—à–ª–æ–π –¥–∞—Ç—ã, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–µ—Ç —á–∞—Å—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ grace_period, –Ω–∞—á–∏–Ω–∞—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

#### 3.1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è

```python
# –í _extend_subscription

from ..utils.renewal_detector import DEFAULT_GRACE_PERIOD

# –ü—Ä–æ–¥–ª–µ–Ω–∏–µ: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
if existing_expires_at <= now - DEFAULT_GRACE_PERIOD:
    # –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ –±–æ–ª–µ–µ —á–µ–º –Ω–∞ grace_period (24 —á–∞—Å–∞)
    # –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ—Ç–µ—Ä—è–ª –æ–ø–ª–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    logger.info(
        f"[SUBSCRIPTION] Subscription {subscription_id} expired more than {DEFAULT_GRACE_PERIOD}s ago "
        f"(expired at {existing_expires_at}, now={now}). "
        f"Starting renewal from current time instead of expired time."
    )
    new_expires_at = now + tariff['duration_sec']
else:
    # –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞ –Ω–µ–¥–∞–≤–Ω–æ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö grace_period)
    # –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
    new_expires_at = existing_expires_at + tariff['duration_sec']

logger.info(
    f"[SUBSCRIPTION] Extending subscription {subscription_id} for user {payment.user_id}: "
    f"{existing_expires_at} -> {new_expires_at} (+{tariff['duration_sec']}s)"
)
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç** (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π):

```python
# –í—Å–µ–≥–¥–∞ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞
if existing_expires_at < now:
    # –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ - –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    new_expires_at = now + tariff['duration_sec']
    logger.info(
        f"[SUBSCRIPTION] Subscription {subscription_id} expired, "
        f"starting renewal from current time: {now} -> {new_expires_at}"
    )
else:
    # –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –æ—Ç –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
    new_expires_at = existing_expires_at + tariff['duration_sec']
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 2-3 —á–∞—Å–∞  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–Ω—è—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## 4. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–∞–∑–æ–≤–∞—è. –ù–µ—Ç:
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- Retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –î–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–æ–∫

### –†–µ—à–µ–Ω–∏–µ

#### 4.1. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π

```python
# payments/exceptions.py

class SubscriptionError(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫"""
    def __init__(self, message: str, payment_id: str = None, subscription_id: int = None):
        self.message = message
        self.payment_id = payment_id
        self.subscription_id = subscription_id
        super().__init__(self.message)

class SubscriptionCreationError(SubscriptionError):
    """–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏"""
    pass

class KeyCreationError(SubscriptionError):
    """–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞"""
    def __init__(self, message: str, server_id: int = None, **kwargs):
        self.server_id = server_id
        super().__init__(message, **kwargs)

class NotificationError(SubscriptionError):
    """–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    pass

class RetryableError(SubscriptionError):
    """–û—à–∏–±–∫–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å"""
    def __init__(self, message: str, retry_after: int = 60, **kwargs):
        self.retry_after = retry_after  # —Å–µ–∫—É–Ω–¥—ã –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
        super().__init__(message, **kwargs)
```

#### 4.2. –î–æ–±–∞–≤–∏—Ç—å retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

```python
# payments/utils/retry.py

import asyncio
import logging
from functools import wraps
from typing import Type, Tuple, List

logger = logging.getLogger(__name__)

def async_retry(
    max_attempts: int = 3,
    delay: float = 1.0,
    backoff: float = 2.0,
    exceptions: Tuple[Type[Exception], ...] = (Exception,)
):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è async —Ñ—É–Ω–∫—Ü–∏–π"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            last_exception = None
            current_delay = delay
            
            for attempt in range(1, max_attempts + 1):
                try:
                    return await func(*args, **kwargs)
                except exceptions as e:
                    last_exception = e
                    if attempt < max_attempts:
                        logger.warning(
                            f"[RETRY] Attempt {attempt}/{max_attempts} failed for {func.__name__}: {e}. "
                            f"Retrying in {current_delay}s..."
                        )
                        await asyncio.sleep(current_delay)
                        current_delay *= backoff
                    else:
                        logger.error(
                            f"[RETRY] All {max_attempts} attempts failed for {func.__name__}: {e}"
                        )
            
            raise last_exception
        return wrapper
    return decorator
```

#### 4.3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–¥–µ

```python
# –í subscription_purchase_service.py

from ..exceptions import KeyCreationError, RetryableError, NotificationError
from ..utils.retry import async_retry

@async_retry(max_attempts=3, delay=2.0, exceptions=(RetryableError,))
async def _create_key_on_server(
    self,
    server_id: int,
    server_name: str,
    api_url: str,
    api_key: str,
    domain: str,
    payment: Payment,
    subscription_id: int,
    expires_at: int,
    now: int
) -> Tuple[bool, Optional[str]]:
    """–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å retry"""
    try:
        # ... –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞ ...
        return True, None
    except ConnectionError as e:
        # –í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ - –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
        raise RetryableError(
            f"Network error creating key on server {server_id}: {e}",
            payment_id=payment.payment_id,
            subscription_id=subscription_id,
            retry_after=30
        )
    except Exception as e:
        # –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º
        raise KeyCreationError(
            f"Failed to create key on server {server_id}: {e}",
            server_id=server_id,
            payment_id=payment.payment_id,
            subscription_id=subscription_id
        )
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 6-8 —á–∞—Å–æ–≤  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫

---

## 5. –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞

–ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ race condition, –µ—Å–ª–∏ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–¥–∏–Ω –ø–ª–∞—Ç–µ–∂.

### –†–µ—à–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞.

#### 5.1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```python
# –í payment_repository.py

async def try_mark_as_processing(
    self, 
    payment_id: str, 
    expected_status: PaymentStatus = PaymentStatus.PAID
) -> bool:
    """
    –ê—Ç–æ–º–∞—Ä–Ω–æ –ø–æ–º–µ—Ç–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π
    
    Returns:
        True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω, False –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
    """
    try:
        async with open_async_connection(self.db_path) as conn:
            cursor = await conn.execute(
                """
                UPDATE payments 
                SET status = 'processing', updated_at = ? 
                WHERE payment_id = ? AND status = ?
                """,
                (
                    int(datetime.now(timezone.utc).timestamp()),
                    payment_id,
                    expected_status.value
                )
            )
            await conn.commit()
            
            success = cursor.rowcount > 0
            if success:
                logger.info(f"Payment {payment_id} atomically marked as processing")
            return success
    except Exception as e:
        logger.error(f"Error atomically marking payment as processing: {e}")
        return False
```

#### 5.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–¥–µ

```python
# –í process_subscription_purchase

# –ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ paid
if payment.status != PaymentStatus.PAID:
    return False, error_msg

# –ê—Ç–æ–º–∞—Ä–Ω–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ processing
if not await self.payment_repo.try_mark_as_processing(payment_id, PaymentStatus.PAID):
    # –°—Ç–∞—Ç—É—Å —É–∂–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
    payment_check = await self.payment_repo.get_by_payment_id(payment_id)
    if payment_check and payment_check.status == PaymentStatus.COMPLETED:
        logger.info(f"Payment {payment_id} already completed by another process")
        return True, None
    return False, "Payment status changed by another process"

try:
    # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ ...
    # –í –∫–æ–Ω—Ü–µ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ completed
    payment.mark_as_completed()
    await self.payment_repo.update(payment)
finally:
    # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ paid
    # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å processing –¥–ª—è retry)
    pass
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–∏–∑–∫–∏–π (—Ç–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞)  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 3-4 —á–∞—Å–∞  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
- –ó–∞—â–∏—Ç–∞ –æ—Ç race condition
- –Ø–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å "processing"

---

## 6. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–±–ª–µ–º–∞

–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
- –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–∞
- –í–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞

### –†–µ—à–µ–Ω–∏–µ

#### 6.1. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

```python
# payments/utils/validation.py

from typing import Optional, Tuple

async def validate_subscription_payment(
    payment_repo: PaymentRepository,
    subscription_repo: SubscriptionRepository,
    tariff_repo: TariffRepository,
    payment_id: str
) -> Tuple[bool, Optional[str], Optional[Dict]]:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    
    Returns:
        (is_valid, error_message, validated_data)
    """
    # –ü–æ–ª—É—á–∞–µ–º –ø–ª–∞—Ç–µ–∂
    payment = await payment_repo.get_by_payment_id(payment_id)
    if not payment:
        return False, f"Payment {payment_id} not found", None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞
    if not (payment.metadata and payment.metadata.get('key_type') == 'subscription'):
        return False, f"Payment {payment_id} is not a subscription payment", None
    
    if payment.protocol != 'v2ray':
        return False, f"Payment {payment_id} protocol is not v2ray", None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    if payment.status != PaymentStatus.PAID:
        return False, f"Payment {payment_id} is not paid (status: {payment.status.value})", None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞—Ä–∏—Ñ
    tariff_row = tariff_repo.get_tariff(payment.tariff_id)
    if not tariff_row:
        return False, f"Tariff {payment.tariff_id} not found", None
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    
    validated_data = {
        'payment': payment,
        'tariff': {
            'id': tariff_row[0],
            'name': tariff_row[1],
            'duration_sec': tariff_row[2],
            'price_rub': tariff_row[3],
            'traffic_limit_mb': tariff_row[4] if len(tariff_row) > 4 else 0,
        }
    }
    
    return True, None, validated_data
```

#### 6.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–æ–¥–µ

```python
# –í process_subscription_purchase

from ..utils.validation import validate_subscription_payment

async def process_subscription_purchase(self, payment_id: str):
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    is_valid, error_msg, validated_data = await validate_subscription_payment(
        self.payment_repo,
        self.subscription_repo,
        self.tariff_repo,
        payment_id
    )
    
    if not is_valid:
        logger.error(f"[SUBSCRIPTION] Validation failed: {error_msg}")
        return False, error_msg
    
    payment = validated_data['payment']
    tariff = validated_data['tariff']
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°—Ä–µ–¥–Ω–∏–π  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 4-5 —á–∞—Å–æ–≤  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- –ß–∏—â–µ –∫–æ–¥
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è

---

## 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏:
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- –ù–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –æ–ø–µ—Ä–∞—Ü–∏–π

### –†–µ—à–µ–Ω–∏–µ

#### 7.1. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π

```python
# –í _create_subscription

import asyncio

async def _create_key_on_server_async(
    self,
    server: Tuple,
    payment: Payment,
    subscription_id: int,
    expires_at: int,
    now: int,
    tariff: Dict[str, Any]
) -> Tuple[int, bool, Optional[str]]:
    """–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ"""
    server_id, server_name, api_url, api_key, domain, v2ray_path = server
    try:
        # ... –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞ ...
        return server_id, True, None
    except Exception as e:
        return server_id, False, str(e)

# –í –æ—Å–Ω–æ–≤–Ω–æ–º –º–µ—Ç–æ–¥–µ
async def _create_subscription(self, payment, tariff, now):
    # ... –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ ...
    
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π
    tasks = [
        self._create_key_on_server_async(
            server, payment, subscription_id, expires_at, now, tariff
        )
        for server in servers
    ]
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    created_keys = 0
    failed_servers = []
    
    for result in results:
        if isinstance(result, Exception):
            logger.error(f"[SUBSCRIPTION] Task failed with exception: {result}")
            continue
        
        server_id, success, error = result
        if success:
            created_keys += 1
        else:
            failed_servers.append(server_id)
            logger.error(f"[SUBSCRIPTION] Failed to create key on server {server_id}: {error}")
```

#### 7.2. –ë–∞—Ç—á–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π –ë–î

```python
# –î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π

async def _extend_keys_batch(
    self,
    subscription_id: int,
    new_expires_at: int,
    batch_size: int = 100
):
    """–ü—Ä–æ–¥–ª–∏—Ç—å –∫–ª—é—á–∏ –±–∞—Ç—á–∞–º–∏"""
    async with open_async_connection(self.db_path) as conn:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –ø–æ–¥–ø–∏—Å–∫–∏
        async with conn.execute(
            "SELECT id FROM v2ray_keys WHERE subscription_id = ?",
            (subscription_id,)
        ) as cursor:
            key_ids = [row[0] for row in await cursor.fetchall()]
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞—Ç—á–∞–º–∏
        for i in range(0, len(key_ids), batch_size):
            batch = key_ids[i:i + batch_size]
            placeholders = ','.join('?' * len(batch))
            await conn.execute(
                f"""
                UPDATE v2ray_keys 
                SET expiry_at = ? 
                WHERE id IN ({placeholders})
                """,
                (new_expires_at,) + tuple(batch)
            )
        
        await conn.commit()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–∏–∑–∫–∏–π (–¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 8-10 —á–∞—Å–æ–≤  
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ë—ã—Å—Ç—Ä–µ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

## üìä –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å)
1. ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
2. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π** - –≤–ª–∏—è–µ—Ç –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–∞

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
3. ‚úÖ **–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫** - —É–ª—É—á—à–∞–µ—Ç UX
4. ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫** - –ø–æ–≤—ã—à–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
5. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** - —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)
6. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π** - —Ç–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞
7. ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - –¥–ª—è —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

---

## üéØ –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –ù–µ–¥–µ–ª—è 1: –ú–µ—Ç—Ä–∏–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –î–µ–Ω—å 1-2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å –º–µ—Ç—Ä–∏–∫
- –î–µ–Ω—å 3-4: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ –∫–æ–¥
- –î–µ–Ω—å 5: –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

### –ù–µ–¥–µ–ª—è 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- –î–µ–Ω—å 1-2: –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –î–µ–Ω—å 3-4: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–∞—Å—Ç–∏—á–Ω–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è
- –î–µ–Ω—å 5: –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º

### –ù–µ–¥–µ–ª—è 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –î–µ–Ω—å 1-3: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π
- –î–µ–Ω—å 4-5: –ë–∞—Ç—á–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π –ë–î

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞:
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: —É–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ edge cases
- **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å**: –º–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–ö–∞—á–µ—Å—Ç–≤–æ**: –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π —Å–¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –≥–æ—Ç–æ–≤–æ–π –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.






# üìä –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ VeilBot 2025

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: 2025-11-05  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞**: 2.2.0  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü—Ä–æ–µ–∫—Ç –≤ —Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üìà –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã
- **–í—Å–µ–≥–æ Python —Ñ–∞–π–ª–æ–≤**: 84 —Ñ–∞–π–ª–∞
- **–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª**: `bot.py` - **3430+ —Å—Ç—Ä–æ–∫** (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)
- **–ö—Ä—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏**: 
  - `vpn_protocols.py` - 1335+ —Å—Ç—Ä–æ–∫
  - `admin/main.py` - ~180 —Å—Ç—Ä–æ–∫ (—Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω)
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ß–∞—Å—Ç–∏—á–Ω–æ –º–æ–¥—É–ª—å–Ω–∞—è (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—á–∞—Ç)

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (—á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω)
- ‚úÖ –í—ã–Ω–µ—Å–µ–Ω—ã handlers –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ (`bot/handlers/`)
  - `start.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
  - `keys.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏
  - `purchase.py` - –ø–æ–∫—É–ø–∫–∞ –∫–ª—é—á–µ–π
  - `renewal.py` - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π
  - `key_management.py` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏
- ‚úÖ –í—ã–Ω–µ—Å–µ–Ω—ã keyboards –≤ `bot/keyboards/`
- ‚úÖ –í—ã–Ω–µ—Å–µ–Ω—ã formatters –≤ `bot/utils/formatters.py`
- ‚úÖ –í—ã–Ω–µ—Å–µ–Ω—ã key operations –≤ `bot/services/key_operations.py`
- ‚úÖ –ê–¥–º–∏–Ω–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–æ–¥—É–ª—å–Ω–∞—è (`admin/routes/`)

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ Connection Pool –¥–ª—è –ë–î (—Å–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –Ω–∞ 30-50%)
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é (—Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –Ω–∞ 60-80%)
- ‚úÖ –ë–∞—Ç—á–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö (—Å–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ 80-90%)
- ‚úÖ Lazy loading –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –º–æ–¥—É–ª–µ–π
- ‚úÖ Memory optimizer –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ CSRF –∑–∞—â–∏—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫–µ
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
- ‚úÖ Rate limiting –¥–ª—è –±–æ—Ç–∞
- ‚úÖ Security headers
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π `bot.py` (3430+ —Å—Ç—Ä–æ–∫) - –í –ü–†–û–¶–ï–°–°–ï –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ß–∞—Å—Ç—å handlers –≤—ã–Ω–µ—Å–µ–Ω–∞, –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—Å–µ –µ—â–µ –≤ `bot.py`
- –ú–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π (60+) –æ—Å—Ç–∞—é—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ–≤–æ–º —Ñ–∞–π–ª–µ
- –°–ª–æ–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- –ü–ª–æ—Ö–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞
- –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 1.1 –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–Ω–æ—Å handlers
```python
# bot/handlers/__init__.py
def register_all_handlers(dp, user_states, bot, ...):
    """–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö handlers"""
    register_start_handler(dp, user_states)
    register_keys_handler(dp)
    register_purchase_handlers(...)
    register_renewal_handlers(...)
    register_key_management_handlers(...)
```

#### 1.2 –í—ã–Ω–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ services
–°–æ–∑–¥–∞—Ç—å `bot/services/`:
- `key_service.py` - –≤—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏
- `payment_service.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- `notification_service.py` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `background_service.py` - —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

#### 1.3 –í—ã–Ω–µ—Å—Ç–∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
–°–æ–∑–¥–∞—Ç—å `bot/utils/`:
- `key_helpers.py` - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏
- `server_helpers.py` - –≤—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–æ–≤
- `payment_helpers.py` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ù–û  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 2-3 –¥–Ω—è  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏ –Ω–∞ 300%

---

### 2. –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–ª–æ–∂–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞**:
```python
# admin/routes/payments.py
import importlib.util
_bot_file = os.path.join(_root_dir, 'bot.py')
spec = importlib.util.spec_from_file_location("bot_module", _bot_file)
bot_module = importlib.util.module_from_spec(spec)
spec.loader.exec_module(bot_module)
bot = bot_module.bot
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `importlib.util` –¥–ª—è –æ–±—Ö–æ–¥–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 2.1 –°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è bot instance
```python
# bot/instance.py
"""–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –±–æ—Ç–∞"""
from aiogram import Bot
from config import TELEGRAM_BOT_TOKEN

_bot_instance: Bot | None = None

def get_bot() -> Bot:
    """–ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞"""
    global _bot_instance
    if _bot_instance is None:
        _bot_instance = Bot(token=TELEGRAM_BOT_TOKEN)
    return _bot_instance

def set_bot(bot: Bot):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
    global _bot_instance
    _bot_instance = bot
```

#### 2.2 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å dependency injection
```python
# admin/routes/payments.py
from bot.instance import get_bot

bot = get_bot()  # –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –∏–º–ø–æ—Ä—Ç
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°–†–ï–î–ù–ï  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 4-6 —á–∞—Å–æ–≤  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ 50%

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ú–Ω–æ–≥–æ `logging.debug()` –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤
- –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å flow –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 3.1 –í–Ω–µ–¥—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# bot/utils/logger.py
import logging
import json
from datetime import datetime

class StructuredLogger:
    def __init__(self, name: str):
        self.logger = logging.getLogger(name)
    
    def log_event(self, event_type: str, user_id: int = None, **kwargs):
        """–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π"""
        log_data = {
            'timestamp': datetime.utcnow().isoformat(),
            'event_type': event_type,
            'user_id': user_id,
            **kwargs
        }
        self.logger.info(json.dumps(log_data))
```

#### 3.2 –î–æ–±–∞–≤–∏—Ç—å correlation IDs
```python
# –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –≤–µ—Å—å flow
import contextvars

request_id = contextvars.ContextVar('request_id', default=None)

def log_with_context(message: str, **kwargs):
    log_data = {
        'request_id': request_id.get(),
        'message': message,
        **kwargs
    }
    logger.info(json.dumps(log_data))
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°–†–ï–î–ù–ï  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 1 –¥–µ–Ω—å  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ 200%

---

## üü° –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ï—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤, —Ç–∞—Ä–∏—Ñ–æ–≤, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 4.1 –í–Ω–µ–¥—Ä–∏—Ç—å Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```python
# app/infra/cache.py
import redis
from typing import Optional
import json

class Cache:
    def __init__(self, redis_url: str = None):
        if redis_url:
            self.redis = redis.from_url(redis_url)
        else:
            self.redis = None
            self._memory_cache = {}
    
    async def get(self, key: str) -> Optional[dict]:
        if self.redis:
            data = await self.redis.get(key)
            return json.loads(data) if data else None
        return self._memory_cache.get(key)
    
    async def set(self, key: str, value: dict, ttl: int = 300):
        if self.redis:
            await self.redis.setex(key, ttl, json.dumps(value))
        else:
            self._memory_cache[key] = value
```

#### 4.2 –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (TTL: 5 –º–∏–Ω—É—Ç)
- –°–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ (TTL: 15 –º–∏–Ω—É—Ç)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π (TTL: 1 —á–∞—Å)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (TTL: 1 –º–∏–Ω—É—Ç–∞)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°–†–ï–î–ù–ï  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 1 –¥–µ–Ω—å  
**–≠—Ñ—Ñ–µ–∫—Ç**: –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –Ω–∞ 40-60%

---

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ï—Å—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π `BotErrorHandler`
- –ù–æ –Ω–µ –≤—Å–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 5.1 –°–æ–∑–¥–∞—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é –∏—Å–∫–ª—é—á–µ–Ω–∏–π
```python
# bot/exceptions.py
class VeilBotError(Exception):
    """–ë–∞–∑–æ–≤–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ"""
    pass

class KeyError(VeilBotError):
    """–û—à–∏–±–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏"""
    pass

class PaymentError(VeilBotError):
    """–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π"""
    pass

class ServerError(VeilBotError):
    """–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤"""
    pass
```

#### 5.2 –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ handlers
```python
# bot/handlers/base.py
from bot.exceptions import VeilBotError
from bot_error_handler import BotErrorHandler

async def safe_handler(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""
    async def wrapper(*args, **kwargs):
        try:
            return await func(*args, **kwargs)
        except VeilBotError as e:
            await BotErrorHandler.handle_error(e, *args, **kwargs)
        except Exception as e:
            await BotErrorHandler.handle_unexpected_error(e, *args, **kwargs)
    return wrapper
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°–†–ï–î–ù–ï  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 1 –¥–µ–Ω—å  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 50%

---

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ï—Å—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è payments
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –±–æ—Ç–∞
- –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 6.1 Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```python
# tests/test_key_service.py
import pytest
from bot.services.key_service import KeyService

@pytest.mark.asyncio
async def test_create_key():
    service = KeyService()
    key = await service.create_key(user_id=123, tariff_id=1)
    assert key is not None
    assert key.user_id == 123
```

#### 6.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```python
# tests/integration/test_payment_flow.py
@pytest.mark.asyncio
async def test_full_payment_flow():
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    # –û–∂–∏–¥–∞–Ω–∏–µ webhook
    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞
```

#### 6.3 Mock –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
```python
# tests/mocks/v2ray_api.py
class MockV2RayAPI:
    async def create_user(self, email: str):
        return {'uuid': 'test-uuid', 'id': 'test-id'}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–ò–ó–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 3-5 –¥–Ω–µ–π  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –Ω–∞ 200%

---

## üü¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è

### 7. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ï—Å—Ç—å connection pool
- –ï—Å—Ç—å –∏–Ω–¥–µ–∫—Å—ã
- –ù–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å foreign keys

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 7.1 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π
# –í–º–µ—Å—Ç–æ:
cursor.execute("SELECT * FROM keys WHERE user_id = ?", (user_id,))
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
cursor.execute("SELECT id, access_url, expiry_at FROM keys WHERE user_id = ?", (user_id,))
```

#### 7.2 Batch –æ–ø–µ—Ä–∞—Ü–∏–∏
```python
# –î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å executemany
cursor.executemany(
    "UPDATE keys SET expiry_at = ? WHERE id = ?",
    [(new_expiry, key_id) for key_id in key_ids]
)
```

#### 7.3 –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü (–¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤)
```python
# –î–ª—è —Ç–∞–±–ª–∏—Ü—ã keys –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –≥–æ–¥—É —Å–æ–∑–¥–∞–Ω–∏—è
# –≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ —Å—Ç–∞—Ä—ã–º –¥–∞–Ω–Ω—ã–º
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–ò–ó–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 1 –¥–µ–Ω—å  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ 20-30%

---

### 8. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ï—Å—Ç—å –±–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ù–µ—Ç –∞–ª–µ—Ä—Ç–æ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 8.1 –í–Ω–µ–¥—Ä–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏
```python
# bot/metrics.py
from prometheus_client import Counter, Histogram, Gauge

requests_total = Counter('veilbot_requests_total', 'Total requests', ['handler'])
request_duration = Histogram('veilbot_request_duration_seconds', 'Request duration')
active_users = Gauge('veilbot_active_users', 'Active users')
```

#### 8.2 Health check endpoint
```python
# admin/routes/health.py
@router.get("/health")
async def health_check():
    return {
        'status': 'ok',
        'database': check_database(),
        'bot': check_bot_status(),
        'memory': get_memory_usage()
    }
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–ò–ó–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 1 –¥–µ–Ω—å  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ 100%

---

### 9. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**:
- –ï—Å—Ç—å –±–∞–∑–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ù–µ—Ç API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –±–æ—Ç–∞
- –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:

#### 9.1 API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å docstrings —Å —Ñ–æ—Ä–º–∞—Ç–æ–º Google
def create_key(user_id: int, tariff_id: int) -> dict:
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
        tariff_id: ID —Ç–∞—Ä–∏—Ñ–∞
        
    Returns:
        dict: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞
        
    Raises:
        KeyError: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á
    """
    pass
```

#### 9.2 –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
```markdown
# docs/ARCHITECTURE.md
## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π
- –î–∏–∞–≥—Ä–∞–º–º—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ –ù–ò–ó–ö–ò–ô  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 2-3 –¥–Ω—è  
**–≠—Ñ—Ñ–µ–∫—Ç**: –£–ª—É—á—à–µ–Ω–∏–µ onboarding –Ω–∞ 300%

---

## üìã –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `bot.py`
2. ‚úÖ –£—Å—Ç—Ä–∞–Ω–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
3. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
4. ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (2-3 –Ω–µ–¥–µ–ª–∏)
5. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
6. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î –∑–∞–ø—Ä–æ—Å—ã
7. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –§–∞–∑–∞ 3: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –º–µ—Å—è—Ü–∞)
8. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã
9. ‚úÖ –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
10. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å CI/CD

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ ROI

| –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –í—Ä–µ–º—è | ROI | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|--------|-----------|-------|-----|-----------|
| –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ bot.py | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | 2-3 –¥–Ω—è | –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω—è—è |
| –£—Å—Ç—Ä–∞–Ω–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | üü° –í–∞–∂–Ω–æ | 4-6 —á–∞—Å–æ–≤ | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∞—è |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | üü° –í–∞–∂–Ω–æ | 1 –¥–µ–Ω—å | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∞—è |
| –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ | üü° –í–∞–∂–Ω–æ | 1 –¥–µ–Ω—å | –í—ã—Å–æ–∫–∏–π | –°—Ä–µ–¥–Ω—è—è |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | üü° –í–∞–∂–Ω–æ | 1 –¥–µ–Ω—å | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∞—è |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | 3-5 –¥–Ω–µ–π | –í—ã—Å–æ–∫–∏–π | –í—ã—Å–æ–∫–∞—è |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | 1 –¥–µ–Ω—å | –°—Ä–µ–¥–Ω–∏–π | –°—Ä–µ–¥–Ω—è—è |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | 2-3 –¥–Ω—è | –°—Ä–µ–¥–Ω–∏–π | –ù–∏–∑–∫–∞—è |

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ **—Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏** –ø–æ—Å–ª–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞. –û—Å–Ω–æ–≤–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã, –Ω–æ –æ—Å—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –ø–æ:

1. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏—é —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞** - –≤—ã–Ω–æ—Å –æ—Å—Ç–∞–≤—à–µ–π—Å—è –ª–æ–≥–∏–∫–∏ –∏–∑ `bot.py`
2. **–£–ª—É—á—à–µ–Ω–∏—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã** - —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
4. **–ö–∞—á–µ—Å—Ç–≤—É –∫–æ–¥–∞** - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—á–∞—Ç—å —Å **–§–∞–∑—ã 1** –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º.

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2025-11-05  
**–ê–≤—Ç–æ—Ä**: AI Code Assistant  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0


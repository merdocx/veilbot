# –ë—ã—Å—Ç—Ä—ã–µ —É–ª—É—á—à–µ–Ω–∏—è - –ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ

**–î–∞—Ç–∞**: 2025-11-06  
**–°—Ç–∞—Ç—É—Å**: –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ë–î ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã**:
- `idx_keys_user_expiry` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ `user_id` –∏ `expiry_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `keys`
- `idx_v2ray_keys_user_expiry` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ `user_id` –∏ `expiry_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `v2ray_keys`
- `idx_payments_user_status` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ `user_id` –∏ `status` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
- `idx_keys_server_expiry` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ `server_id` –∏ `expiry_at` (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
- `idx_v2ray_keys_server_expiry` - –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ `server_id` –∏ `expiry_at` (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)

**–≠—Ñ—Ñ–µ–∫—Ç**: 
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 20-30%
- –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- –ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —á–∞—Å—Ç—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π

**–§–∞–π–ª—ã**:
- `db.py` - —Ñ—É–Ω–∫—Ü–∏—è `migrate_add_common_indexes()`

---

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ**:
- –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã 3 –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è email –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å `UNION ALL`
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `payments` > `keys` > `v2ray_keys`

**–§–∞–π–ª—ã**:
- `app/repositories/user_repository.py` - –º–µ—Ç–æ–¥ `get_user_stats()`
- `bot/handlers/purchase.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î —Å 3 –¥–æ 1
- –£–ª—É—á—à–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î

**–î–æ**:
```python
# 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
c.execute("SELECT email FROM payments WHERE ...")
c.execute("SELECT email FROM keys WHERE ...")
c.execute("SELECT email FROM v2ray_keys WHERE ...")
```

**–ü–æ—Å–ª–µ**:
```python
# 1 –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
c.execute("""
    SELECT email FROM (
        SELECT email, 1 as priority, created_at as sort_date FROM payments WHERE ...
        UNION ALL
        SELECT email, 2 as priority, expiry_at as sort_date FROM keys WHERE ...
        UNION ALL
        SELECT email, 3 as priority, expiry_at as sort_date FROM v2ray_keys WHERE ...
    ) ORDER BY priority ASC, sort_date DESC LIMIT 1
""")
```

---

### 3. –£–ª—É—á—à–µ–Ω–∏–µ Content-Security-Policy ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `nonce` –¥–ª—è inline —Å–∫—Ä–∏–ø—Ç–æ–≤
- CSP —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `nonce-{csp_nonce}` –≤–º–µ—Å—Ç–æ —Ç–æ–ª—å–∫–æ `unsafe-inline`
- `unsafe-inline` –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ fallback –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–§–∞–π–ª—ã**:
- `admin/main.py` - middleware `add_security_headers()`
- `admin/config.py` - –æ–±–Ω–æ–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ `SECURITY_HEADERS`
- `admin/dependencies/templates.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `add_csp_nonce_to_context()`

**–≠—Ñ—Ñ–µ–∫—Ç**:
- –£–ª—É—á—à–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç XSS –∞—Ç–∞–∫
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–ª–Ω–æ–º—É —É–¥–∞–ª–µ–Ω–∏—é `unsafe-inline` –≤ –±—É–¥—É—â–µ–º
- Nonce –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —à–∞–±–ª–æ–Ω–∞—Ö —á–µ—Ä–µ–∑ `request.state.csp_nonce`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —à–∞–±–ª–æ–Ω–∞—Ö** (–¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π):
```html
<script nonce="{{ csp_nonce }}">
    // inline —Å–∫—Ä–∏–ø—Ç
</script>
```

**–¢–µ–∫—É—â–∏–π CSP**:
```
script-src 'self' 'nonce-{nonce}' 'unsafe-inline' cdnjs.cloudflare.com
```

**–¶–µ–ª–µ–≤–æ–π CSP** (–ø–æ—Å–ª–µ –≤—ã–Ω–æ—Å–∞ –≤—Å–µ—Ö inline —Å–∫—Ä–∏–ø—Ç–æ–≤):
```
script-src 'self' 'nonce-{nonce}' cdnjs.cloudflare.com
```

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã**: –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ 20-30%
- ‚úÖ **SQL**: –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å 3 –¥–æ 1 (66% —É–º–µ–Ω—å—à–µ–Ω–∏–µ)
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –£–ª—É—á—à–µ–Ω–∞ –∑–∞ —Å—á–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ë–î

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ **CSP**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ nonce
- ‚úÖ **XSS –∑–∞—â–∏—Ç–∞**: –£–ª—É—á—à–µ–Ω–∞ —á–µ—Ä–µ–∑ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π CSP
- ‚úÖ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–ª–Ω–æ–º—É —É–¥–∞–ª–µ–Ω–∏—é unsafe-inline

### –ö–æ–¥
- ‚úÖ **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: –£–ª—É—á—à–µ–Ω–∞ –∑–∞ —Å—á–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è unsafe-inline:
1. –í—ã–Ω–µ—Å—Ç–∏ –≤—Å–µ inline —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ JS —Ñ–∞–π–ª—ã
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å nonce –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è inline —Å–∫—Ä–∏–ø—Ç–æ–≤
3. –£–±—Ä–∞—Ç—å `'unsafe-inline'` –∏–∑ CSP

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
1. –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ N+1 –∑–∞–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã)
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ë–î

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~2 —á–∞—Å–∞  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –∂–∏–≤—ã–µ —Ç–µ—Å—Ç—ã


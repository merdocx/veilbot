# Решение проблемы с повторной покупкой бесплатных ключей

## Проблема

После автоматической очистки истекших ключей пользователи получали возможность покупать бесплатный ключ снова, что нарушало бизнес-логику "один бесплатный ключ навсегда".

## Решение

### 1. Новая таблица `free_key_usage`

Создана новая таблица для отслеживания пользователей, которые уже получали бесплатные ключи:

```sql
CREATE TABLE free_key_usage (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    protocol TEXT NOT NULL,
    country TEXT,
    created_at INTEGER,
    UNIQUE(user_id, protocol, country)
);
```

**Поля:**
- `user_id` - ID пользователя
- `protocol` - протокол (outline/v2ray)
- `country` - страна сервера (может быть NULL)
- `created_at` - время создания записи
- `UNIQUE(user_id, protocol, country)` - уникальный индекс

### 2. Обновленная логика проверки

Функция `check_free_tariff_limit_by_protocol_and_country()` теперь:

1. **Основная проверка**: Сначала проверяет таблицу `free_key_usage`
2. **Проверка по протоколу**: Если пользователь уже получал бесплатный ключ для протокола, блокирует получение
3. **Проверка по стране**: Если указана конкретная страна, дополнительно проверяет для неё
4. **Обратная совместимость**: Дополнительно проверяет старые таблицы ключей

### 3. Запись использования

Функция `record_free_key_usage()` записывает использование бесплатного ключа при его создании.

### 4. Миграция данных

Скрипт `migrate_free_key_usage.py` переносит существующие данные о бесплатных ключах в новую таблицу.

## Логика работы

### Для новых пользователей:
1. Пользователь запрашивает бесплатный ключ
2. Система проверяет таблицу `free_key_usage`
3. Если записи нет - создает ключ и записывает использование
4. Если запись есть - блокирует создание

### Для существующих пользователей:
1. При запуске системы выполняется миграция
2. Все существующие бесплатные ключи записываются в `free_key_usage`
3. Пользователи не могут получить бесплатные ключи повторно

### По протоколам:
- **Outline**: Один бесплатный ключ навсегда
- **V2Ray**: Один бесплатный ключ навсегда
- **Разные протоколы**: Можно получить по одному бесплатному ключу для каждого протокола

### По странам:
- Если пользователь уже получал бесплатный ключ для протокола, он не может получить его для любой страны
- Если указана конкретная страна, дополнительно проверяется для неё

## Файлы изменений

### Основные изменения:
- `db.py` - добавлена таблица `free_key_usage` и функция миграции
- `bot.py` - обновлена логика проверки и записи использования

### Новые файлы:
- `migrate_free_key_usage.py` - скрипт миграции данных
- `test_free_key_limit.py` - тесты логики
- `FREE_KEY_LIMIT_SOLUTION.md` - эта документация

## Тестирование

Запуск тестов:
```bash
python3 test_free_key_limit.py
```

Запуск миграции:
```bash
python3 migrate_free_key_usage.py
```

## Результат

✅ Пользователи не могут повторно получать бесплатные ключи после очистки истекших ключей

✅ Сохранена обратная совместимость с существующими данными

✅ Поддержка разных протоколов и стран

✅ Автоматическая миграция существующих данных

## Важное замечание

⚠️ **Перезапуск бота обязателен** после внесения изменений в код. Без перезапуска старый код продолжит работать и пользователи смогут обходить ограничения.

### Процедура обновления:
1. Внести изменения в код
2. Перезапустить бота: `./restart_bot.sh`
3. Проверить статус: `systemctl status veilbot`
4. Проверить логи: `journalctl -u veilbot -f`

### Альтернативный способ (ручной):
1. Остановить сервис: `systemctl stop veilbot`
2. Запустить сервис: `systemctl start veilbot`
3. Проверить статус: `systemctl status veilbot`


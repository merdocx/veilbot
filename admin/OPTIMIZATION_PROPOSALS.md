# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∫–∏

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ V2Ray –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (30-50x –±—ã—Å—Ç—Ä–µ–µ)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ë–î (5-10x –±—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—Ä–æ—Å—ã)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã SQL injection —Ä–∏—Å–∫–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ –ë–î

---

## üî¥ –û—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞** ‚ö†Ô∏è –í–ê–ñ–ù–û
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π, —Ç—Ä–∞—Ñ–∏–∫ –≤—Å–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (—Å—Ç—Ä–æ–∫–∏ 1048-1054):
```python
# –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫ (–º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ)
for result in config_results:
    ...
    monthly_traffic = await get_key_monthly_traffic(key[1], 'v2ray', server_config, server_id)
    keys_with_traffic.append(key_list + [monthly_traffic])
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –ü—Ä–∏ 50 –∫–ª—é—á–∞—Ö = 50 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `get_key_monthly_traffic()`
- –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ (monthly_traffic + traffic_history fallback)
- –í—Ä–µ–º—è: ~10-30 —Å–µ–∫—É–Ω–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

**–†–µ—à–µ–Ω–∏–µ**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–∞—Ç—á–∞–º–∏
```python
# –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–ª—é—á–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º
keys_by_server = {}
for result in config_results:
    key_id, real_config, _ = result
    key = v2ray_keys_data[key_id]
    server_id = server_id_map.get(key_id)
    
    if server_id not in keys_by_server:
        keys_by_server[server_id] = []
    keys_by_server[server_id].append((key_id, key, real_config))

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º
traffic_tasks = []
for server_id, server_keys in keys_by_server.items():
    if server_id:
        # –°–æ–∑–¥–∞–µ–º –æ–¥–Ω—É –∑–∞–¥–∞—á—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∫–ª—é—á–µ–π
        api_url = server_keys[0][1][10] if len(server_keys[0][1]) > 10 else ''
        api_key = server_keys[0][1][11] if len(server_keys[0][1]) > 11 else ''
        server_config = {'api_url': api_url or '', 'api_key': api_key or ''}
        traffic_tasks.append(fetch_server_traffic(server_id, server_config, server_keys))

traffic_results = await asyncio.gather(*traffic_tasks, return_exceptions=True)
```

**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ**: **10-20x –±—ã—Å—Ç—Ä–µ–µ** –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

---

### 2. **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞** üí° –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
**–ü—Ä–æ–±–ª–µ–º–∞**: –¢—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π —Å—Ä–∞–∑—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**: 
- –ù–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AJAX –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –¢—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ V2Ray API

---

### 3. **JavaScript –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚ö° –°–†–ï–î–ù–Ø–Ø –í–ê–ñ–ù–û–°–¢–¨

#### 3.1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–±–∞—É–Ω—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: `filterTable()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∏–º–≤–æ–ª–µ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```javascript
function filterTable() {
    const searchTerm = document.getElementById('global-search').value.toLowerCase();
    // ... –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º
}
```

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å –¥–µ–±–∞—É–Ω—Å 300ms
```javascript
let filterTimeout;
function filterTable() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
        // ... –∫–æ–¥ –ø–æ–∏—Å–∫–∞
    }, 300);
}
```

#### 3.2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: `filterTable()` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 3 —à–∞–±–ª–æ–Ω–∞—Ö:
- `keys.html`
- `users.html`
- `servers.html`

**–†–µ—à–µ–Ω–∏–µ**: –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ–±—â–∏–π —Ñ–∞–π–ª `base.html` –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å `admin/static/js/common.js`

#### 3.3. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π DOM –ø–æ–∏—Å–∫
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–∏—Å–∫ –ø–æ `getElementsByTagName()` –∫–∞–∂–¥—ã–π —Ä–∞–∑

**–†–µ—à–µ–Ω–∏–µ**: –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```javascript
let cachedRows = null;
function filterTable() {
    if (!cachedRows) {
        const table = document.getElementById('keys-table');
        cachedRows = Array.from(table.querySelectorAll('tbody tr'));
    }
    // ... –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cachedRows
}
```

---

### 4. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å OFFSET** ‚ö° –°–†–ï–î–ù–Ø–Ø –í–ê–ñ–ù–û–°–¢–¨
**–ü—Ä–æ–±–ª–µ–º–∞**: `OFFSET` –º–µ–¥–ª–µ–Ω–Ω—ã–π –Ω–∞ –±–æ–ª—å—à–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (>1000)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```python
offset = (page - 1) * limit
rows = key_repo.list_keys_unified(..., offset=offset, limit=limit)
```

**–†–µ—à–µ–Ω–∏–µ**: Cursor-based pagination
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WHERE id > last_id –≤–º–µ—Å—Ç–æ OFFSET
rows = key_repo.list_keys_unified_cursor(last_id=last_id, limit=limit)
```

**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ**: **2-5x –±—ã—Å—Ç—Ä–µ–µ** –Ω–∞ –±–æ–ª—å—à–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö

---

## üìä –î–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 5. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**
**–¢–µ–∫—É—â–µ–µ**: 
- Dashboard stats: 60 —Å–µ–∫—É–Ω–¥
- V2Ray traffic: 300 —Å–µ–∫—É–Ω–¥

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è**:
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (10 –º–∏–Ω—É—Ç)
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤ (10 –º–∏–Ω—É—Ç)
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (5 –º–∏–Ω—É—Ç)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ETags –¥–ª—è HTTP –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### 6. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ë–î**
**–ü—Ä–æ–±–ª–µ–º—ã**:
- Dashboard –¥–µ–ª–∞–µ—Ç 3 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö COUNT –∑–∞–ø—Ä–æ—Å–∞
- –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å UNION

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```python
c.execute("SELECT COUNT(*) FROM keys WHERE expiry_at > ?", (now,))
c.execute("SELECT COUNT(*) FROM v2ray_keys WHERE expiry_at > ?", (now,))
c.execute("SELECT COUNT(*) FROM tariffs")
```

**–†–µ—à–µ–Ω–∏–µ**:
```python
c.execute("""
    SELECT 
        (SELECT COUNT(*) FROM keys WHERE expiry_at > ?) as active_keys,
        (SELECT COUNT(*) FROM tariffs) as tariff_count,
        (SELECT COUNT(*) FROM servers) as server_count
""", (now,))
```

**–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ**: **2-3x –±—ã—Å—Ç—Ä–µ–µ** dashboard

### 7. **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü**
**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è —Å—Ä–∞–∑—É

**–†–µ—à–µ–Ω–∏–µ**: 
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä–≤—ã–µ 20 —Å—Ç—Ä–æ–∫
- –ü–æ–¥–≥—Ä—É–∂–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (virtual scrolling)
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

---

## üé® UX/UI —É–ª—É—á—à–µ–Ω–∏—è

### 8. **–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–†–µ—à–µ–Ω–∏–µ**:
- –°–ø–∏–Ω–Ω–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã `/keys`
- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Skeleton screens –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

### 9. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ**
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∞–ª–µ—Ä—Ç

**–†–µ—à–µ–Ω–∏–µ**:
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π error handler
- –ö—Ä–∞—Å–∏–≤—ã–µ toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è failed –∑–∞–ø—Ä–æ—Å–æ–≤

### 10. **–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ –¥–∞–Ω–Ω—ã–º

**–†–µ—à–µ–Ω–∏–µ**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `localStorage` –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sessionStorage` –¥–ª—è —Å–µ—Å—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Service Worker –¥–ª—è offline —Ä–µ–∂–∏–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 11. **–†–∞–∑–±–∏–µ–Ω–∏–µ admin_routes.py**
**–ü—Ä–æ–±–ª–µ–º–∞**: 1970+ —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ

**–†–µ—à–µ–Ω–∏–µ**: –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –º–æ–¥—É–ª–∏
```
admin/
  routes/
    __init__.py
    auth.py          # –õ–æ–≥–∏–Ω, –ª–æ–≥–∞—É—Ç
    dashboard.py     # Dashboard
    keys.py          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏
    servers.py       # –°–µ—Ä–≤–µ—Ä—ã
    tariffs.py       # –¢–∞—Ä–∏—Ñ—ã
    payments.py      # –ü–ª–∞—Ç–µ–∂–∏
    users.py         # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    webhooks.py      # –í–µ–±—Ö—É–∫–∏
    cleanup.py       # –û—á–∏—Å—Ç–∫–∞
```

### 12. **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
```python
def require_auth(func):
    @wraps(func)
    async def wrapper(request: Request, *args, **kwargs):
        if not request.session.get("admin_logged_in"):
            return RedirectResponse("/login")
        return await func(request, *args, **kwargs)
    return wrapper

@router.get("/keys")
@require_auth
async def keys_page(request: Request, ...):
    ...
```

### 13. **API endpoints –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞**
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç REST API, —Ç–æ–ª—å–∫–æ HTML –æ—Ç–≤–µ—Ç—ã

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–∏—Ç—å JSON endpoints
```python
@router.get("/api/keys")
@require_auth
async def api_keys(request: Request, ...):
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –≤–º–µ—Å—Ç–æ HTML
    return JSONResponse({"keys": [...], "total": ...})
```

---

## üìã –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–í—ã—Å–æ–∫–∏–π) - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
1. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ (–±–∞—Ç—á–∏–Ω–≥ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º)
2. ‚úÖ –î–µ–±–∞—É–Ω—Å –¥–ª—è JavaScript –ø–æ–∏—Å–∫–∞
3. ‚úÖ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ dashboard
4. ‚úÖ –í—ã–Ω–æ—Å –æ–±—â–µ–≥–æ JavaScript –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–°—Ä–µ–¥–Ω–∏–π) - UX:
1. ‚úÖ –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
2. ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏
3. ‚úÖ Cursor-based pagination
4. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ù–∏–∑–∫–∏–π) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
1. ‚úÖ –†–∞–∑–±–∏–µ–Ω–∏–µ admin_routes.py
2. ‚úÖ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. ‚úÖ REST API endpoints
4. ‚úÖ –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üí° –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞ - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ~10-15 —Å–µ–∫ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ) ‚úÖ
- –¢—Ä–∞—Ñ–∏–∫: ~10-30 —Å–µ–∫ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ) ‚ùå

**–¶–µ–ª–µ–≤–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ~10-15 —Å–µ–∫ ‚úÖ
- –¢—Ä–∞—Ñ–∏–∫: ~2-5 —Å–µ–∫ (–±–∞—Ç—á–∏–Ω–≥) ‚úÖ

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
```python
# –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–ª—é—á–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º
server_keys_map = defaultdict(list)
for result in config_results:
    key_id, real_config, _ = result
    key = v2ray_keys_data[key_id]
    server_id = server_id_map.get(key_id)
    if server_id:
        server_keys_map[server_id].append({
            'key_id': key_id,
            'key': key,
            'config': real_config,
            'uuid': key[1]
        })

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫ –±–∞—Ç—á–∞–º–∏ –ø–æ —Å–µ—Ä–≤–µ—Ä–∞–º
async def fetch_server_traffic_batch(server_id, server_keys, server_config):
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å)
        monthly_traffic = await get_monthly_traffic_for_server(server_id, server_config)
        
        # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–ª—é—á–∞–º
        results = []
        for key_data in server_keys:
            uuid = key_data['uuid']
            traffic = find_traffic_for_uuid(monthly_traffic, uuid)
            results.append((key_data['key_id'], key_data['config'], traffic))
        return results
    except Exception as e:
        logging.error(f"Error fetching traffic for server {server_id}: {e}")
        return [(k['key_id'], k['config'], "Error") for k in server_keys]

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
traffic_tasks = [
    fetch_server_traffic_batch(srv_id, keys, get_server_config(srv_id))
    for srv_id, keys in server_keys_map.items()
]

traffic_results = await asyncio.gather(*traffic_tasks, return_exceptions=True)
```

---

### 2. JavaScript –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω

**–°–æ–∑–¥–∞—Ç—å `admin/static/js/common.js`**:
```javascript
// –î–µ–±–∞—É–Ω—Å —Ñ—É–Ω–∫—Ü–∏—è
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü
function createTableFilter(tableId) {
    const table = document.getElementById(tableId);
    let cachedRows = null;
    
    const filterFunction = debounce((searchTerm) => {
        if (!cachedRows) {
            cachedRows = Array.from(table.querySelectorAll('tbody tr'));
        }
        
        const term = searchTerm.toLowerCase();
        cachedRows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            const found = cells.some(cell => 
                cell.textContent.toLowerCase().includes(term)
            );
            row.style.display = found ? '' : 'none';
        });
    }, 300);
    
    return filterFunction;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('global-search');
    if (searchInput) {
        const tableId = searchInput.dataset.tableId || 'keys-table';
        const filterFn = createTableFilter(tableId);
        searchInput.addEventListener('input', (e) => filterFn(e.target.value));
    }
});
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –æ–∂–∏–¥–∞–µ–º—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π

| –û–ø–µ—Ä–∞—Ü–∏—è | –¢–µ–∫—É—â–µ–µ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|---------|-------------------|-----------|
| –ó–∞–≥—Ä—É–∑–∫–∞ /keys (50 V2Ray) | ~25-45 —Å–µ–∫ | ~12-20 —Å–µ–∫ | **2x –±—ã—Å—Ç—Ä–µ–µ** |
| –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ | 0-100ms (lag) | <50ms (smooth) | **–ü–ª–∞–≤–Ω–µ–µ** |
| Dashboard –∑–∞–≥—Ä—É–∑–∫–∞ | ~50-100ms | ~20-30ms | **2-3x –±—ã—Å—Ç—Ä–µ–µ** |
| –ë–æ–ª—å—à–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (>1000) | –ú–µ–¥–ª–µ–Ω–Ω–æ | –ë—ã—Å—Ç—Ä–æ | **2-5x –±—ã—Å—Ç—Ä–µ–µ** |

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ (–±–∞—Ç—á–∏–Ω–≥)
- [ ] –î–µ–±–∞—É–Ω—Å –¥–ª—è JavaScript –ø–æ–∏—Å–∫–∞
- [ ] –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ dashboard
- [ ] –í—ã–Ω–æ—Å –æ–±—â–µ–≥–æ JavaScript

### –§–∞–∑–∞ 2: UX —É–ª—É—á—à–µ–Ω–∏—è
- [ ] –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
- [ ] –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∑–∫–∏
- [ ] Cursor-based pagination
- [ ] –£–ª—É—á—à–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –§–∞–∑–∞ 3: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- [ ] –†–∞–∑–±–∏–µ–Ω–∏–µ admin_routes.py
- [ ] –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è –æ–±—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] REST API endpoints
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: 2025-01-01
**–í–µ—Ä—Å–∏—è**: –ü–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π v2.0.1
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏


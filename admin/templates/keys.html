{% extends "base.html" %}

{% block title %}Ключи{% endblock %}
{% block page_title %}Ключи{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total }}</div>
        <div class="stat-label">Всего ключей</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ active_count }}</div>
        <div class="stat-label">Активных</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ expired_count }}</div>
        <div class="stat-label">Истекших</div>
    </div>
</div>

<!-- Keys Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Выданные ключи</h2>
        <p class="card-subtitle">Управление всеми выданными ключами</p>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <form method="get" action="/keys" style="display: flex; gap: 16px; align-items: center; flex: 1; flex-wrap: wrap;">
            <input type="text" name="email" placeholder="Поиск по email" value="{{ email }}" class="filter-input">
            <input type="text" name="protocol" placeholder="Протокол" value="{{ protocol }}" class="filter-input">
            <button type="submit" class="btn btn-primary">
                <span class="material-icons icon-small">search</span>
                Поиск
            </button>
            <a href="/keys" class="btn">
                <span class="material-icons icon-small">clear</span>
                Сбросить
            </a>
        </form>
    </div>

    <!-- Table -->
    <div style="overflow-x: auto;">
        <table class="material-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Тип</th>
                    <th>Ключ</th>
                    <th>Email</th>
                    <th>Сервер</th>
                    <th>Создан</th>
                    <th>Истекает</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for k in keys %}
                <tr>
                    <td>{{ k[0] }}</td>
                    <td>
                        {% if k[8] == 'outline' %}
                            <span class="badge badge-info">
                                <span class="material-icons icon-small">lock</span>
                                Outline
                            </span>
                        {% elif k[8] == 'v2ray' %}
                            <span class="badge badge-info">
                                <span class="material-icons icon-small">security</span>
                                V2Ray
                            </span>
                        {% else %}
                            <span class="badge badge-neutral">{{ k[8] }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="code" title="{{ k[2] }}">{{ k[2]|truncate(30) }}</span>
                            <button class="btn btn-icon" onclick="copyToClipboard('{{ k[2] }}')" title="Скопировать">
                                <span class="material-icons icon-small">content_copy</span>
                            </button>
                        </div>
                    </td>
                    <td>
                        {% if k[6] %}
                            <span class="text-muted">{{ k[6] }}</span>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>{{ k[5] }}</td>
                    <td class="text-small">{{ (k[3]|timestamp).replace(' ', '<br>')|safe }}</td>
                    <td class="text-small">{{ (k[4]|timestamp).replace(' ', '<br>')|safe }}</td>
                    <td>
                        {% if k[4] > current_time %}
                            <span class="badge badge-success">
                                <span class="material-icons icon-small">check_circle</span>
                                Активен
                            </span>
                        {% else %}
                            <span class="badge badge-error">
                                <span class="material-icons icon-small">cancel</span>
                                Истек
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-icon" onclick="editKey({{ k[0] }}, '{{ k[4]|my_datetime_local }}')" title="Редактировать">
                                <span class="material-icons icon-small">edit</span>
                            </button>
                            <a href="/keys/delete/{{ k[0] }}" class="btn btn-icon btn-danger" 
                               onclick="return confirm('Удалить ключ?')" title="Удалить">
                                <span class="material-icons icon-small">delete</span>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if server %}&server={{ server }}{% endif %}{% if protocol %}&protocol={{ protocol }}{% endif %}">
            <span class="material-icons icon-small">chevron_left</span>
        </a>
    {% endif %}
    
    {% for p in range(1, pages + 1) %}
        {% if p == page %}
            <a href="#" class="active">{{ p }}</a>
        {% elif p <= 3 or p >= pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?page={{ p }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if server %}&server={{ server }}{% endif %}{% if protocol %}&protocol={{ protocol }}{% endif %}">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
            <span>...</span>
        {% elif p == pages - 3 and page < pages - 4 %}
            <span>...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < pages %}
        <a href="?page={{ page + 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if server %}&server={{ server }}{% endif %}{% if protocol %}&protocol={{ protocol }}{% endif %}">
            <span class="material-icons icon-small">chevron_right</span>
        </a>
    {% endif %}
</div>
{% endif %}

<!-- Edit Modal -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Редактировать срок действия</h3>
        <form id="editForm" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <div style="margin: 16px 0;">
                <label for="new_expiry" style="display: block; margin-bottom: 8px; font-weight: 500;">Новая дата истечения:</label>
                <input type="datetime-local" id="new_expiry" name="new_expiry" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeEditModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 24px;
    border-radius: 8px;
    min-width: 400px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}

.modal h3 {
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 500;
}
</style>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showNotification('Ключ скопирован!', 'success');
    });
}

function editKey(keyId, currentExpiry) {
    document.getElementById('editForm').action = `/keys/edit/${keyId}`;
    document.getElementById('new_expiry').value = currentExpiry;
    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : '#2196f3'};
        color: white;
        padding: 12px 16px;
        border-radius: 4px;
        z-index: 1001;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Close modal on outside click
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target == modal) {
        closeEditModal();
    }
}
</script>
{% endblock %}
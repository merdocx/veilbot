{% extends "base.html" %}

{% block page_title %}–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { display:inline-flex; align-items:center; gap:6px; height:32px; padding:0 10px; border-radius:16px; background:#f1f3f4; color:#3c4043; font-size:12px; }
  .chip .material-icons-outlined { font-size:16px; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eaeaea; background:#fff; }
  .search { display:flex; align-items:center; gap:8px; background:#f1f3f4; padding:0 12px; border-radius:24px; height:40px; }
  .search input { border:none; background:transparent; outline:none; font-size:14px; width:220px; }
  .segmented { display:inline-flex; background:#f1f3f4; border-radius:8px; overflow:hidden; }
  .segmented a { padding:8px 12px; font-size:12px; color:#3c4043; text-decoration:none; }
  .segmented a.active { background:#e8eaed; font-weight:600; }
  .fab { position:fixed; bottom:24px; right:24px; width:56px; height:56px; border-radius:50%; background:#1a73e8; color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 12px rgba(0,0,0,0.2); cursor:pointer; }
</style>
{% endblock %}

{% block content %}
<div class="table-container">
  <div class="table-header">
    <h2>–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏</h2>
    <div class="stats-row">
      <div class="stat-item"><span class="stat-label">–í—Å–µ–≥–æ:</span><span class="stat-value">{{ total }}</span></div>
      <div class="stat-item"><span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span><span class="stat-value">{{ active_count }}</span></div>
      <div class="stat-item"><span class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö:</span><span class="stat-value">{{ expired_count }}</span></div>
    </div>
  </div>

  <div class="filter-row">
    <form method="get" action="/keys" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input type="text" name="email" placeholder="–ü–æ–∏—Å–∫ –ø–æ email" value="{{ email }}" />
      <select name="tariff_id" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; background:white;">
        <option value="">–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</option>
        {% for tariff in tariffs %}
        <option value="{{ tariff.id }}" {% if tariff_id == tariff.id %}selected{% endif %}>{{ tariff.name }}</option>
        {% endfor %}
      </select>
      <select name="protocol" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; background:white;">
        <option value="">–í—Å–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã</option>
        <option value="outline" {% if protocol == 'outline' %}selected{% endif %}>Outline</option>
        <option value="v2ray" {% if protocol == 'v2ray' %}selected{% endif %}>V2Ray</option>
      </select>
      <select name="server_id" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; background:white;">
        <option value="">–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã</option>
        {% for server in servers %}
        <option value="{{ server.id }}" {% if server_id == server.id %}selected{% endif %}>{{ server.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-primary" type="submit">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
      <a href="/keys" class="btn">–°–±—Ä–æ—Å–∏—Ç—å</a>
    </form>
  </div>

  <div style="overflow-x:auto;">
    <table class="unified-table">
      <thead>
        <tr>
          <th style="width:60px;">ID</th>
          <th style="width:80px;">–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
          <th>–ö–ª—é—á</th>
          <th style="width:120px;">–¢–∞—Ä–∏—Ñ</th>
          <th style="width:150px;">Email</th>
          <th style="width:120px;">–°–µ—Ä–≤–µ—Ä</th>
          <th style="width:120px;">–°–æ–∑–¥–∞–Ω</th>
          <th style="width:120px;">–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
          <th style="width:100px;">–°—Ç–∞—Ç—É—Å</th>
          <th style="width:120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for k in keys %}
        <tr>
          <td>{{ k[0] }}</td>
          <td>
            {% if k[8] == 'outline' %}
              <span class="badge active">üîí Outline</span>
            {% elif k[8] == 'v2ray' %}
              <span class="badge active">üõ°Ô∏è V2Ray</span>
            {% else %}
              <span class="badge">{{ k[8] }}</span>
            {% endif %}
          </td>
          <td>
            <div class="key-inline">
              <div class="code" id="code-{{ k[0] }}" title="{{ k[2] }}">{{ k[2]|truncate(30) }}</div>
              <button class="btn" onclick="copyCode('{{ k[2] }}')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                <span class="material-icons">content_copy</span>
              </button>
            </div>
          </td>
          <td>
            {% if k[7] %}
              <span>{{ k[7] }}</span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>
          <td>
            {% if k[6] %}
              <span class="email">{{ k[6] }}</span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>
          <td>{{ k[5] }}</td>
          <td class="date-cell" title="{{ k[3]|timestamp }}">{{ (k[3]|timestamp).replace(' ', '<br>')|safe }}</td>
          <td class="date-cell" title="{{ k[4]|timestamp }}">{{ (k[4]|timestamp).replace(' ', '<br>')|safe }}</td>
          <td>
            {% if k[4] > current_time %}
              <span class="badge active">–ê–∫—Ç–∏–≤–µ–Ω</span>
            {% else %}
              <span class="badge expired">–ò—Å—Ç–µ–∫</span>
            {% endif %}
          </td>
          <td>
            <div class="action-buttons">
              <a href="/keys/delete/{{ k[0] }}" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á?')" title="–£–¥–∞–ª–∏—Ç—å">
                <span class="material-icons">delete</span>
              </a>
              <button class="btn btn-primary" 
                      data-key-id="{{ k[0] }}" 
                      data-expiry="{{ k[4]|my_datetime_local }}" 
                      onclick="openEditModal(this)" 
                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è">
                <span class="material-icons">edit</span>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination">
  {% set pages = (total // limit) + (1 if (total % limit) else 0) %}
  {% if pages > 1 %}
    {% if page > 1 %}
      <a href="?page={{ page - 1 }}{% if email %}&email={{ email }}{% endif %}{% if tariff_id %}&tariff_id={{ tariff_id }}{% endif %}{% if protocol %}&protocol={{ protocol }}{% endif %}{% if server_id %}&server_id={{ server_id }}{% endif %}">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
    {% endif %}
    
    {% for p in range(1, pages + 1) %}
      {% if p == page %}
        <a href="#" class="active">{{ p }}</a>
      {% elif p <= 3 or p >= pages - 2 or (p >= page - 1 and p <= page + 1) %}
        <a href="?page={{ p }}{% if email %}&email={{ email }}{% endif %}{% if tariff_id %}&tariff_id={{ tariff_id }}{% endif %}{% if protocol %}&protocol={{ protocol }}{% endif %}{% if server_id %}&server_id={{ server_id }}{% endif %}">{{ p }}</a>
      {% elif p == 4 and page > 5 %}
        <span>...</span>
      {% elif p == pages - 3 and page < pages - 4 %}
        <span>...</span>
      {% endif %}
    {% endfor %}
    
    {% if page < pages %}
      <a href="?page={{ page + 1 }}{% if email %}&email={{ email }}{% endif %}{% if tariff_id %}&tariff_id={{ tariff_id }}{% endif %}{% if protocol %}&protocol={{ protocol }}{% endif %}{% if server_id %}&server_id={{ server_id }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
    {% endif %}
  {% endif %}
</div>

<!-- Modal –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</h4>
    <form id="editForm" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      <div class="input-field">
        <label for="new_expiry">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è:</label>
        <input type="datetime-local" id="new_expiry" name="new_expiry" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
function copyCode(code) {
  navigator.clipboard.writeText(code).then(function() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.textContent = '–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!';
    notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:8px 16px;border-radius:6px;z-index:1000;';
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 2000);
  });
}

function openEditModal(button) {
  const keyId = button.dataset.keyId;
  const currentExpiry = button.dataset.expiry;
  
  document.getElementById('editForm').action = `/keys/edit/${keyId}`;
  document.getElementById('new_expiry').value = currentExpiry;
  document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
  const modal = document.getElementById('editModal');
  if (event.target == modal) {
    closeEditModal();
  }
}
</script>

<style>
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 15% auto;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  max-width: 90%;
}

.modal-footer {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 16px;
}

.input-field {
  margin-bottom: 16px;
}

.input-field label {
  display: block;
  margin-bottom: 4px;
  font-weight: 500;
}

.input-field input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}
</style>
{% endblock %}
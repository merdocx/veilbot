{% extends "base.html" %}

{% block page_title %}–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { display:inline-flex; align-items:center; gap:6px; height:32px; padding:0 10px; border-radius:16px; background:#f1f3f4; color:#3c4043; font-size:12px; }
  .chip .material-icons-outlined { font-size:16px; }
  .toolbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eaeaea; background:#fff; }
  .search { display:flex; align-items:center; gap:8px; background:#f1f3f4; padding:0 12px; border-radius:24px; height:40px; }
  .search input { border:none; background:transparent; outline:none; font-size:14px; width:220px; }
  .segmented { display:inline-flex; background:#f1f3f4; border-radius:8px; overflow:hidden; }
  .segmented a { padding:8px 12px; font-size:12px; color:#3c4043; text-decoration:none; }
  .segmented a.active { background:#e8eaed; font-weight:600; }
  .fab { position:fixed; bottom:24px; right:24px; width:56px; height:56px; border-radius:50%; background:#1a73e8; color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 12px rgba(0,0,0,0.2); cursor:pointer; }
</style>
{% endblock %}

{% block content %}
<style>
.keys-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 0.8rem;
}

.keys-table th {
    background: #f8fafc;
    padding: 8px 6px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.75rem;
    white-space: nowrap;
}

.keys-table td {
    padding: 8px 6px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.75rem;
    vertical-align: middle;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.keys-table tr:hover {
    background-color: #f9fafb;
}

.keys-table tr:last-child td {
    border-bottom: none;
}

.action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 8px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 28px;
    height: 28px;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.btn .material-icons {
    font-size: 14px;
}

/* –£–±—Ä–∞–Ω—ã —Å—Ç–∏–ª–∏ –¥–ª—è badge –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã */

.email {
    font-size: 0.7rem;
    color: #374151;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
}

.code {
    font-family: 'Courier New', monospace;
    font-size: 0.7rem;
    background: #f3f4f6;
    padding: 2px 4px;
    border-radius: 3px;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* –í—Å–µ badge —Å—Ç–∏–ª–∏ —É–±—Ä–∞–Ω—ã –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è */

.code {
    font-family: 'Courier New', monospace;
    background: #f3f4f6;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    word-break: break-all;
}

.email {
    color: #3b82f6;
    font-weight: 500;
}

.text-muted {
    color: #9ca3af;
}

.filter-row {
    background: #f8fafc;
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
}

.filter-row input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    box-sizing: border-box;
}

.filter-row input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    gap: 8px;
}

.pagination .btn {
    min-width: 40px;
    height: 40px;
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.pagination .btn:hover {
    background: #e5e7eb;
    transform: none;
}

.pagination .btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    min-width: 400px;
    max-width: 90vw;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    position: relative;
}

.modal h2 {
    margin: 0 0 1.5rem 0;
    color: #111827;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    box-sizing: border-box;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.close-btn {
    position: absolute;
    right: 1rem;
    top: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.close-btn:hover {
    color: #374151;
}

.error-message {
    color: #ef4444;
    margin-bottom: 1rem;
    display: none;
}

.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.table-header h2 {
    margin: 0;
    color: #111827;
    font-size: 1.5rem;
    font-weight: 600;
}

.stats-row {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stat-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.stat-value {
    font-weight: 600;
    color: #111827;
}
.date-cell { white-space: normal; line-height: 1.1; }
.key-inline { display:flex; align-items:center; gap:6px; }
.key-inline .code { flex:1 1 auto; }
</style>

<div class="table-container">
    <div class="table-header">
        <h2>–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏</h2>
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-label">–í—Å–µ–≥–æ –∫–ª—é—á–µ–π:</span>
                <span class="stat-value">{{ total }}</span>
            </div>
        </div>
    </div>

    

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-row sticky" style="display:grid; grid-template-columns: 50px 60px 100px 70px 110px 90px 70px 90px 90px 100px 50px 120px; gap:6px; align-items:center;">
        <input class="col-filter" data-col="0" placeholder="ID" style="width:100%;">
        <input class="col-filter" data-col="1" placeholder="–ü—Ä–æ—Ç–æ–∫–æ–ª" style="width:100%;">
        <input class="col-filter" data-col="2" placeholder="–ö–ª—é—á" style="width:100%;">
        <input class="col-filter" data-col="3" placeholder="–¢–∞—Ä–∏—Ñ" style="width:100%;">
        <input class="col-filter" data-col="4" placeholder="Email" style="width:100%;">
        <input class="col-filter" data-col="5" placeholder="–¢—Ä–∞—Ñ–∏–∫" style="width:100%;">
        <input class="col-filter" data-col="6" placeholder="–°–µ—Ä–≤–µ—Ä" style="width:100%;">
        <input class="col-filter" data-col="7" placeholder="–°–æ–∑–¥–∞–Ω" style="width:100%;">
        <input class="col-filter" data-col="8" placeholder="–ò—Å—Ç–µ–∫–∞–µ—Ç" style="width:100%;">
        <input class="col-filter" data-col="9" placeholder="–û—Å—Ç–∞–ª–æ—Å—å" style="width:100%;">
        <input class="col-filter" data-col="10" placeholder="–°—Ç–∞—Ç—É—Å" style="width:100%;">
        <div></div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div style="overflow-x: auto; margin-top: 1rem;">
        <table class="table keys-table">
        <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th style="width: 60px;">–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                <th style="width: 100px;">–ö–ª—é—á</th>
                <th style="width: 70px;">–¢–∞—Ä–∏—Ñ</th>
                <th style="width: 110px;">Email</th>
                <th style="width: 90px;">–¢—Ä–∞—Ñ–∏–∫</th>
                <th style="width: 70px;">–°–µ—Ä–≤–µ—Ä</th>
                <th style="width: 90px;">–°–æ–∑–¥–∞–Ω</th>
                <th style="width: 90px;">–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                <th style="width: 100px;">–û—Å—Ç–∞–ª–æ—Å—å</th>
                <th style="width: 50px;">–°—Ç–∞—Ç—É—Å</th>
                <th style="width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="keys-tbody">
            {% for k in keys %}
            <tr>
                <td>{{ k[0] }}</td>
                <td>
                    {% if k[8] == 'outline' %}
                        <span>üîí</span>
                    {% elif k[8] == 'v2ray' %}
                        <span>üõ°Ô∏è</span>
                    {% else %}
                        <span>{{ k[8] }}</span>
                    {% endif %}
                </td>
                <td>
                    <div class="key-inline">
                        <div class="code" id="code-{{ k[0] }}" title="{{ k[2] }}">{{ k[2]|truncate(30) }}</div>
                        <button class="btn" onclick="copyCode('{{ k[2] }}')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"><span class="material-icons">content_copy</span></button>
                    </div>
                </td>
                <td>
                    {% if k[7] %}
                        <span>{{ k[7] }}</span>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if k[6] %}
                        <span class="email">{{ k[6] }}</span>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if k[8] == 'v2ray' %}
                        <span>{{ (k[-1] if k|length > 12 else '') or '‚Äî' }}</span>
                    {% elif k[8] == 'outline' %}
                        <span>{{ (k[-1] if k|length > 9 else '') or '‚Äî' }}</span>
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <span>{{ k[5] }}</span>
                </td>
                <td class="date-cell" title="{{ k[3]|timestamp }}">{{ (k[3]|timestamp).replace(' ', '<br>')|safe }}</td>
                <td class="date-cell" title="{{ k[4]|timestamp }}">{{ (k[4]|timestamp).replace(' ', '<br>')|safe }}</td>
                <td>
                    {% if k[4] > current_time %}
                        {% set remaining = k[4] - current_time %}
                        <span>{{ remaining|format_duration }}</span>
                    {% else %}
                        <span style="color: #ef4444;">–ò—Å—Ç–µ–∫</span>
                    {% endif %}
                </td>
                <td>
                    {% if k[4] > current_time %}
                        <span title="–ê–∫—Ç–∏–≤–µ–Ω">‚úÖ</span>
                    {% else %}
                        <span title="–ò—Å—Ç–µ–∫">‚ùå</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="/keys/delete/{{ k[0] }}" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á?')" title="–£–¥–∞–ª–∏—Ç—å"><span class="material-icons">delete</span></a>
                        <button class="btn btn-primary" 
                                data-key-id="{{ k[0] }}" 
                                data-expiry="{{ k[4]|my_datetime_local }}" 
                                onclick="openEditModal(this)" 
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è">
                            <span class="material-icons">edit</span>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è) -->
<div class="pagination">
  {% set pages = (total // limit) + (1 if (total % limit) else 0) %}
  {% if page > 1 %}
    <a class="btn" href="/keys?page={{ page-1 }}&limit={{ limit }}">‚Üê</a>
  {% endif %}
  {% for p in range(1, pages+1) %}
    {% if p == 1 or p == pages or (p >= page-2 and p <= page+2) %}
      <a class="btn {% if p==page %}active{% endif %}" href="/keys?page={{ p }}&limit={{ limit }}">{{ p }}</a>
    {% elif p == page-3 or p == page+3 %}
      <span style="padding:4px 8px; color:#6b7280;">‚Ä¶</span>
    {% endif %}
  {% endfor %}
  {% if page < pages %}
    <a class="btn" href="/keys?page={{ page+1 }}&limit={{ limit }}">‚Üí</a>
  {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <form id="editForm" onsubmit="submitEdit(event)">
            <input type="hidden" id="editKeyId" name="key_id">
            <div class="form-group">
                <label for="editExpiry">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è</label>
                <input type="datetime-local" id="editExpiry" name="expiry_at" class="form-input" required>
            </div>
            <div class="error-message" id="editError"></div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn" onclick="closeEditModal()" style="background: #6b7280; color: white;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<script>
// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function openEditModal(button) {
    const keyId = button.getAttribute('data-key-id');
    const expiry = button.getAttribute('data-expiry');
    
    document.getElementById('editKeyId').value = keyId;
    document.getElementById('editExpiry').value = expiry;
    document.getElementById('editError').style.display = 'none';
    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

async function submitEdit(event) {
    event.preventDefault();
    
    const keyId = document.getElementById('editKeyId').value;
    const expiry = document.getElementById('editExpiry').value;
    const errorDiv = document.getElementById('editError');
    
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch(`/api/keys/${keyId}/expiry`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ expiry_at: expiry })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            closeEditModal();
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        } else {
            errorDiv.textContent = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        errorDiv.style.display = 'block';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
});

function copyCode(text) {
  try { navigator.clipboard.writeText(text); M && M.toast && M.toast({html: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'}); } catch (e) { alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }
}
function toggleFull(id, text) {
  const el = document.getElementById('code-' + id);
  if (!el) return;
  if (el.innerText.length < text.length) { el.innerText = text; } else { el.innerText = text.substring(0, 30) + '‚Ä¶'; }
}
</script>
<script>
// –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)
document.addEventListener('DOMContentLoaded', function() {
  const inputs = document.querySelectorAll('input.col-filter');
  const tbody = document.getElementById('keys-tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  function applyFilters() {
    const terms = Array.from(inputs).map(i => (i.value||'').toLowerCase());
    tbody.innerHTML = '';
    rows.forEach(tr => {
      const cells = tr.children;
      let ok = true;
      for (let i=0;i<terms.length;i++) {
        if (!terms[i]) continue;
        const txt = (cells[i]?.innerText||'').toLowerCase();
        if (!txt.includes(terms[i])) { ok = false; break; }
      }
      if (ok) tbody.appendChild(tr.cloneNode(true));
    });
  }
  inputs.forEach(inp => inp.addEventListener('input', applyFilters));
});
</script>

<div class="fab" title="–≠–∫—Å–ø–æ—Ä—Ç CSV" onclick="exportCsv()">
  <span class="material-icons">download</span>
</div>
<script>
function exportCsv(){
  const url = new URL(window.location.href);
  url.searchParams.set('export','csv');
  window.location.href = url.toString();
}
</script>
{% endblock %}

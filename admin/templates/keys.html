{% extends "base.html" %}

{% block page_title %}–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏{% endblock %}

{% block content %}
<style>
.keys-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 0.8rem;
}

.keys-table th {
    background: #f8fafc;
    padding: 8px 6px;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.75rem;
    white-space: nowrap;
}

.keys-table td {
    padding: 8px 6px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 0.75rem;
    vertical-align: middle;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.keys-table tr:hover {
    background-color: #f9fafb;
}

.keys-table tr:last-child td {
    border-bottom: none;
}

.action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 8px;
    border: none;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 28px;
    height: 28px;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.btn .material-icons {
    font-size: 14px;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-align: center;
}

.badge-outline {
    background: #3b82f6;
    color: white;
}

.badge-traffic {
    background: #10b981;
    color: white;
    font-weight: 600;
}

.email {
    font-size: 0.7rem;
    color: #374151;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
}

.code {
    font-family: 'Courier New', monospace;
    font-size: 0.7rem;
    background: #f3f4f6;
    padding: 2px 4px;
    border-radius: 3px;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.badge-v2ray {
    background: #8b5cf6;
    color: white;
}

.badge-success {
    background: #10b981;
    color: white;
}

.badge-danger {
    background: #ef4444;
    color: white;
}

.badge-info {
    background: #6b7280;
    color: white;
}

.badge-primary {
    background: #3b82f6;
    color: white;
}

.code {
    font-family: 'Courier New', monospace;
    background: #f3f4f6;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    word-break: break-all;
}

.email {
    color: #3b82f6;
    font-weight: 500;
}

.text-muted {
    color: #9ca3af;
}

.filter-row {
    background: #f8fafc;
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
}

.filter-row input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    box-sizing: border-box;
}

.filter-row input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    gap: 8px;
}

.pagination .btn {
    min-width: 40px;
    height: 40px;
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.pagination .btn:hover {
    background: #e5e7eb;
    transform: none;
}

.pagination .btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    min-width: 400px;
    max-width: 90vw;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    position: relative;
}

.modal h2 {
    margin: 0 0 1.5rem 0;
    color: #111827;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    box-sizing: border-box;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.close-btn {
    position: absolute;
    right: 1rem;
    top: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.close-btn:hover {
    color: #374151;
}

.error-message {
    color: #ef4444;
    margin-bottom: 1rem;
    display: none;
}

.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.table-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.table-header h2 {
    margin: 0;
    color: #111827;
    font-size: 1.5rem;
    font-weight: 600;
}

.stats-row {
    display: flex;
    gap: 2rem;
    margin-top: 1rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stat-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.stat-value {
    font-weight: 600;
    color: #111827;
}
</style>

<div class="table-container">
    <div class="table-header">
        <h2>–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏</h2>
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-label">–í—Å–µ–≥–æ –∫–ª—é—á–µ–π:</span>
                <span class="stat-value">{{ keys|length }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
                <span class="stat-value">{{ keys|selectattr('4', 'gt', current_time)|list|length }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">–ò—Å—Ç–µ–∫—à–∏—Ö:</span>
                <span class="stat-value">{{ keys|selectattr('4', 'le', current_time)|list|length }}</span>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-row">
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="padding: 0 2px;"><input type="text" id="filter-id" placeholder="ID" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-protocol" placeholder="–ü—Ä–æ—Ç–æ–∫–æ–ª" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-key" placeholder="–ö–ª—é—á" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-tariff" placeholder="–¢–∞—Ä–∏—Ñ" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-email" placeholder="Email" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-traffic" placeholder="–¢—Ä–∞—Ñ–∏–∫" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-server" placeholder="–°–µ—Ä–≤–µ—Ä" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-created" placeholder="–°–æ–∑–¥–∞–Ω" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-expiry" placeholder="–ò—Å—Ç–µ–∫–∞–µ—Ç" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px;"><input type="text" id="filter-status" placeholder="–°—Ç–∞—Ç—É—Å" style="font-size: 0.7rem; padding: 2px 4px;"></td>
                <td style="padding: 0 2px; width: 80px;"></td>
            </tr>
        </table>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div style="overflow-x: auto; margin-top: 1rem;">
        <table class="keys-table">
        <thead>
            <tr>
                <th style="width: 50px;">ID</th>
                <th style="width: 80px;">–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                <th style="width: 150px;">–ö–ª—é—á</th>
                <th style="width: 80px;">–¢–∞—Ä–∏—Ñ</th>
                <th style="width: 120px;">Email</th>
                <th style="width: 100px;">–¢—Ä–∞—Ñ–∏–∫ (–º–µ—Å—è—Ü)</th>
                <th style="width: 80px;">–°–µ—Ä–≤–µ—Ä</th>
                <th style="width: 90px;">–°–æ–∑–¥–∞–Ω</th>
                <th style="width: 90px;">–ò—Å—Ç–µ–∫–∞–µ—Ç</th>
                <th style="width: 70px;">–°—Ç–∞—Ç—É—Å</th>
                <th style="width: 80px;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="keys-tbody">
            {% for k in keys %}
            <tr>
                <td>{{ k[0] }}</td>
                <td>
                    {% if k[8] == 'outline' %}
                        <span class="badge badge-outline">üîí</span>
                    {% elif k[8] == 'v2ray' %}
                        <span class="badge badge-v2ray">üõ°Ô∏è</span>
                    {% else %}
                        <span class="badge badge-info">{{ k[8] }}</span>
                    {% endif %}
                </td>
                <td>
                    <div class="code" title="{{ k[2] }}">{{ k[2]|truncate(30) }}</div>
                </td>
                <td>
                    {% if k[7] %}
                        <span class="badge badge-primary">{{ k[7] }}</span>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if k[6] %}
                        <span class="email">{{ k[6] }}</span>
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if k[8] == 'v2ray' and k|length > 11 %}
                        <span class="badge badge-traffic">{{ k[11] }}</span>
                    {% elif k[8] == 'outline' and k|length > 9 %}
                        <span class="badge badge-traffic">{{ k[9] }}</span>
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge badge-info">{{ k[5] }}</span>
                </td>
                <td title="{{ k[3]|timestamp }}">{{ k[3]|timestamp|truncate(10) }}</td>
                <td title="{{ k[4]|timestamp }}">{{ k[4]|timestamp|truncate(10) }}</td>
                <td>
                    {% if k[4] > current_time %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                        <span class="badge badge-danger">–ò—Å—Ç–µ–∫</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="/keys/delete/{{ k[0] }}" class="btn btn-danger" 
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á?')" title="–£–¥–∞–ª–∏—Ç—å">
                            <span class="material-icons">delete</span>
                        </a>
                        <button class="btn btn-primary" 
                                data-key-id="{{ k[0] }}" 
                                data-expiry="{{ k[4]|my_datetime_local }}" 
                                onclick="openEditModal(this)" 
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è">
                            <span class="material-icons">edit</span>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination" id="pagination"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</h2>
        <form id="editForm" onsubmit="submitEdit(event)">
            <input type="hidden" id="editKeyId" name="key_id">
            <div class="form-group">
                <label for="editExpiry">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è</label>
                <input type="datetime-local" id="editExpiry" name="expiry_at" class="form-input" required>
            </div>
            <div class="error-message" id="editError"></div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="btn" onclick="closeEditModal()" style="background: #6b7280; color: white;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<script>
// –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
const filters = [
    document.getElementById('filter-id'),
    document.getElementById('filter-protocol'),
    document.getElementById('filter-key'),
    document.getElementById('filter-tariff'),
    document.getElementById('filter-email'),
    document.getElementById('filter-traffic'),
    document.getElementById('filter-server'),
    document.getElementById('filter-created'),
    document.getElementById('filter-expiry'),
    document.getElementById('filter-status')
];

// –≠–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–±–ª–∏—Ü—ã
const table = document.querySelector('.keys-table');
const tbody = document.getElementById('keys-tbody');
const rows = Array.from(tbody.rows);
const pageSize = 10;
let currentPage = 1;
let filteredRows = rows.slice();

// –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
function filterTable() {
    filteredRows = rows.filter(row => {
        for (let i = 0; i < filters.length; i++) {
            const filterValue = filters[i].value.trim().toLowerCase();
            const cellText = row.cells[i].textContent.toLowerCase();
            if (filterValue && !cellText.includes(filterValue)) {
                return false;
            }
        }
        return true;
    });
    currentPage = 1;
    renderPage();
    renderPagination();
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function renderPage() {
    tbody.innerHTML = '';
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    filteredRows.slice(start, end).forEach(row => tbody.appendChild(row.cloneNode(true)));
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
function renderPagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    const pageCount = Math.ceil(filteredRows.length / pageSize);
    if (pageCount <= 1) return;
    
    // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
    if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '‚Üê';
        prevBtn.className = 'btn';
        prevBtn.onclick = () => {
            currentPage--;
            renderPage();
            renderPagination();
        };
        pagination.appendChild(prevBtn);
    }
    
    // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
    for (let i = 1; i <= pageCount; i++) {
        if (i === 1 || i === pageCount || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = 'btn' + (i === currentPage ? ' active' : '');
            btn.onclick = () => {
                currentPage = i;
                renderPage();
                renderPagination();
            };
            pagination.appendChild(btn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.style.padding = '8px 12px';
            dots.style.color = '#6b7280';
            pagination.appendChild(dots);
        }
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
    if (currentPage < pageCount) {
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '‚Üí';
        nextBtn.className = 'btn';
        nextBtn.onclick = () => {
            currentPage++;
            renderPage();
            renderPagination();
        };
        pagination.appendChild(nextBtn);
    }
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function openEditModal(button) {
    const keyId = button.getAttribute('data-key-id');
    const expiry = button.getAttribute('data-expiry');
    
    document.getElementById('editKeyId').value = keyId;
    document.getElementById('editExpiry').value = expiry;
    document.getElementById('editError').style.display = 'none';
    document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

async function submitEdit(event) {
    event.preventDefault();
    
    const keyId = document.getElementById('editKeyId').value;
    const expiry = document.getElementById('editExpiry').value;
    const errorDiv = document.getElementById('editError');
    
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch(`/api/keys/${keyId}/expiry`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ expiry_at: expiry })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            closeEditModal();
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        } else {
            errorDiv.textContent = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
        errorDiv.style.display = 'block';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    filters.forEach(input => {
        if (input) {
            input.addEventListener('input', filterTable);
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    renderPage();
    renderPagination();
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
});
</script>
{% endblock %}

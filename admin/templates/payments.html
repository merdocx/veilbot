{% extends "base.html" %}

{% block title %}Платежи{% endblock %}
{% block page_title %}Платежи{% endblock %}

{% block content %}
{% set current_status = status or '' %}
{% set current_preset = preset or '' %}

<!-- Stats Cards -->
<div class="stats-grid">
    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter=""
        data-preset-filter=""
        aria-pressed="{{ 'true' if (current_status == '' and current_preset == '') else 'false' }}"
        aria-label="Показать все платежи">
        <div class="stat-value">{{ total }}</div>
        <div class="stat-label">Все платежи</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter="paid"
        data-preset-filter=""
        aria-pressed="{{ 'true' if current_status == 'paid' else 'false' }}"
        aria-label="Показать оплаченные платежи">
        <div class="stat-value">{{ paid_count }}</div>
        <div class="stat-label">Оплачено</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter="pending"
        data-preset-filter=""
        aria-pressed="{{ 'true' if current_status == 'pending' or current_preset == 'pending' else 'false' }}"
        aria-label="Показать ожидающие платежи">
        <div class="stat-value">{{ pending_count }}</div>
        <div class="stat-label">Ожидает</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter=""
        data-preset-filter="errors"
        aria-pressed="{{ 'true' if current_preset == 'errors' or current_status in ['failed','cancelled','expired'] else 'false' }}"
        aria-label="Показать проблемные платежи">
        <div class="stat-value">{{ failed_count }}</div>
        <div class="stat-label">Проблемы</div>
    </button>
</div>

<!-- Payments Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Платежи</h2>
        <p class="card-subtitle">Управление платежами и транзакциями</p>
        <div class="mt-2">
            <button class="btn btn-primary" data-action="reconcile" data-csrf="{{ csrf_token }}">
                <span class="material-icons icon-small">sync</span>
                Реконсиляция
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <div class="filter-bar__group flex-1">
            <input type="text" id="global-search" data-table-id="payments-table" placeholder="Поиск по всем столбцам..." class="filter-input filter-input--grow">
            <button type="button" class="btn" id="reset-search-btn">
                <span class="material-icons icon-small">clear</span>
                Сбросить
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-scroll">
        <table class="material-table" id="payments-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Провайдер</th>
                    <th>Тариф</th>
                    <th>Email</th>
                    <th>Сумма</th>
                    <th>User</th>
                    <th>Создан</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payments %}
                <tr>
                    <td>{{ p.id }}</td>
                    <td>
                        {% set prov = (p.provider.value if (p.provider is not none and (p.provider is not string)) else (p.provider or 'yookassa')) %}
                        <div class="cell-primary">{{ prov|replace('_', ' ')|capitalize }}</div>
                        <div class="cell-secondary">
                            <a href="/payments/{{ p.payment_id }}" class="link-plain text-muted" title="Открыть платеж">
                                ID: {{ p.payment_id|string|truncate(18) }}
                            </a>
                        </div>
                    </td>
                    <td>
                        <div class="cell-primary">#{{ p.tariff_id or '—' }}</div>
                    </td>
                    <td>
                        {% if p.email %}
                            <div class="cell-primary" title="{{ p.email }}">{{ p.email }}</div>
                        {% else %}
                            <div class="cell-primary text-muted">—</div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="cell-primary">{{ p.amount|rub }}</div>
                    </td>
                    <td>
                        <div class="cell-primary">{{ p.user_id or '—' }}</div>
                    </td>
                    <td>
                        <div class="cell-primary">{{ (p.created_at.timestamp() if p.created_at else 0) | timestamp }}</div>
                    </td>
                    <td>
                        {% set st = (p.status | status_text) %}
                        <div class="cell-primary">{{ st }}</div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <form method="post" action="/payments/{{ p.payment_id }}/recheck" data-action="payments-form" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-primary" title="Перепроверить">
                                    <span class="material-icons icon-small">refresh</span>
                                </button>
                            </form>
                            <a href="/payments/{{ p.payment_id }}" class="btn" title="Подробнее">
                                <span class="material-icons icon-small">visibility</span>
                            </a>
                            <form method="post" action="/payments/{{ p.payment_id }}/delete" data-action="delete-payment" data-payment-id="{{ p.payment_id }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-danger" title="Удалить" type="submit">
                                    <span class="material-icons icon-small">delete</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
            <span class="material-icons icon-small">chevron_left</span>
        </a>
    {% endif %}
    
    {% for p in range(1, pages + 1) %}
        {% if p == page %}
            <a href="#" class="active">{{ p }}</a>
        {% elif p <= 3 or p >= pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?page={{ p }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
            <span>...</span>
        {% elif p == pages - 3 and page < pages - 4 %}
            <span>...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < pages %}
        <a href="?page={{ page + 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
            <span class="material-icons icon-small">chevron_right</span>
        </a>
    {% endif %}
</div>
{% endif %}

{% block extra_scripts %}
    {{ super() }}
    <script type="module" src="/static/js/payments.js"></script>
{% endblock %}
{% endblock %}
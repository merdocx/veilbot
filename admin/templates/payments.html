{% extends "base.html" %}

{% block title %}Платежи{% endblock %}
{% block page_title %}Платежи{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ payments|length }}</div>
        <div class="stat-label">Всего платежей</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ paid_count }}</div>
        <div class="stat-label">Оплачено</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ pending_count }}</div>
        <div class="stat-label">Ожидает</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ failed_count }}</div>
        <div class="stat-label">Неудачных</div>
    </div>
</div>

<!-- Payments Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Платежи</h2>
        <p class="card-subtitle">Управление платежами и транзакциями</p>
        <div style="margin-top: 16px;">
            <button class="btn btn-primary" onclick="reconcileNow('{{ csrf_token }}')">
                <span class="material-icons icon-small">sync</span>
                Реконсиляция
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <form method="get" action="/payments" style="display: flex; gap: 16px; align-items: center; flex: 1; flex-wrap: wrap;">
            <input type="text" name="email" placeholder="Поиск по email" value="{{ email }}" class="filter-input">
            <input type="text" name="user_id" placeholder="User ID" value="{{ user_id }}" class="filter-input">
            <input type="text" name="payment_id" placeholder="Payment ID" value="{{ payment_id }}" class="filter-input">
            <input type="text" name="status" placeholder="Статус" value="{{ status }}" class="filter-input">
            <button type="submit" class="btn btn-primary">
                <span class="material-icons icon-small">search</span>
                Поиск
            </button>
            <a href="/payments" class="btn">
                <span class="material-icons icon-small">clear</span>
                Сбросить
            </a>
        </form>
    </div>

    <!-- Table -->
    <div style="overflow-x: auto;">
        <table class="material-table" id="payments-table" style="table-layout: fixed; width: 100%; max-width: 100%;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Провайдер</th>
                    <th>Payment ID</th>
                    <th>Тариф</th>
                    <th>Email</th>
                    <th>Сумма</th>
                    <th>User</th>
                    <th>Страна</th>
                    <th>Создан</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payments %}
                <tr>
                    <td>{{ p.id }}</td>
                    <td>
                        {% set prov = (p.provider.value if (p.provider is not none and (p.provider is not string)) else (p.provider or 'yookassa')) %}
                        <span class="badge badge-info">
                            <span class="material-icons icon-small">payment</span>
                            {{ prov|lower }}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="code" title="{{ p.payment_id }}">
                                <a href="/payments/{{ p.payment_id }}" style="color: inherit; text-decoration: none;">
                                    {{ p.payment_id|string|truncate(20) }}
                                </a>
                            </span>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-neutral">{{ p.tariff_id }}</span>
                    </td>
                    <td>
                        {% if p.email %}
                            <span class="text-muted">{{ p.email }}</span>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="text-large">{{ p.amount|rub }}</span>
                    </td>
                    <td>{{ p.user_id }}</td>
                    <td>{{ p.country or '—' }}</td>
                    <td class="text-small">
                        {{ (p.created_at.timestamp() if p.created_at else 0) | timestamp | truncate(10) }}
                    </td>
                    <td style="text-align: center;">
                        {% set st = (p.status | status_text) %}
                        {% if st == 'paid' %}
                            <span class="material-icons" style="color: #2e7d32; font-size: 20px;" title="Оплачен">check_circle</span>
                        {% elif st == 'pending' %}
                            <span class="material-icons" style="color: #ef6c00; font-size: 20px;" title="Ожидает">schedule</span>
                        {% elif st in ['failed','cancelled','expired'] %}
                            <span class="material-icons" style="color: #c62828; font-size: 20px;" title="{{ st }}">cancel</span>
                        {% else %}
                            <span class="material-icons" style="color: #757575; font-size: 20px;" title="{{ st }}">help_outline</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <form method="post" action="/payments/{{ p.payment_id }}/recheck" onsubmit="return submitAjax(event, this)" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-primary" title="Перепроверить">
                                    <span class="material-icons icon-small">refresh</span>
                                </button>
                            </form>
                            <a href="/payments/{{ p.payment_id }}" class="btn" title="Подробнее">
                                <span class="material-icons icon-small">visibility</span>
                            </a>
                            <form method="post" action="/payments/{{ p.payment_id }}/delete" onsubmit="return deletePayment(event, this, '{{ p.payment_id }}')" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-danger" title="Удалить" type="submit">
                                    <span class="material-icons icon-small">delete</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
            <span class="material-icons icon-small">chevron_left</span>
        </a>
    {% endif %}
    
    {% for p in range(1, pages + 1) %}
        {% if p == page %}
            <a href="#" class="active">{{ p }}</a>
        {% elif p <= 3 or p >= pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?page={{ p }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
            <span>...</span>
        {% elif p == pages - 3 and page < pages - 4 %}
            <span>...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < pages %}
        <a href="?page={{ page + 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
            <span class="material-icons icon-small">chevron_right</span>
        </a>
    {% endif %}
</div>
{% endif %}

<script>
function reconcileNow(csrfToken) {
    if (confirm('Запустить реконсиляцию платежей?')) {
        fetch('/payments/reconcile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `csrf_token=${csrfToken}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Реконсиляция завершена. Обработано: ${data.processed}`, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('Ошибка реконсиляции: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showNotification('Ошибка: ' + error, 'error');
        });
    }
}

function submitAjax(event, form) {
    event.preventDefault();
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Операция выполнена успешно', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Ошибка: ' + error, 'error');
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 12px 16px;
        border-radius: 4px;
        z-index: 1001;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

function deletePayment(event, form, paymentId) {
    event.preventDefault();
    
    if (!confirm(`Вы уверены, что хотите удалить платеж ${paymentId}? Это действие нельзя отменить.`)) {
        return false;
    }
    
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || 'Платеж успешно удален', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ошибка: ' + (data.error || 'Не удалось удалить платеж'), 'error');
        }
    })
    .catch(error => {
        showNotification('Ошибка: ' + error, 'error');
    });
    
    return false;
}
</script>
{% endblock %}
{% extends "base.html" %}
{% block page_title %}Платежи{% endblock %}
{% block content %}

<div class="table-container">
  <div class="table-header">
    <h2>Платежи</h2>
    <div class="stats-row">
      <div class="stat-item"><span class="stat-label">Всего:</span><span class="stat-value">{{ payments|length }}</span></div>
      <div class="stat-item"><span class="stat-label">Оплачено:</span><span class="stat-value">{{ paid_count }}</span></div>
      <div class="stat-item"><span class="stat-label">Ожидает:</span><span class="stat-value">{{ pending_count }}</span></div>
      <div class="stat-item"><span class="stat-label">Неудачных/отмен:</span><span class="stat-value">{{ failed_count }}</span></div>
      <div class="stat-item" style="margin-left:auto;">
        <button class="btn" onclick="reconcileNow('{{ csrf_token }}')" title="Запустить реконсиляцию сейчас">Реконсиляция</button>
      </div>
    </div>
  </div>

  <!-- Пресеты фильтров -->
  <div class="filter-row sticky" style="display:flex; gap:8px; align-items:center;">
    <a class="btn" href="/payments?preset=paid_no_keys">Оплаченные без ключей</a>
    <a class="btn" href="/payments?preset=pending">Ожидают</a>
    <a class="btn" href="/payments?preset=errors">Ошибки</a>
  </div>

  <!-- Мини-диаграмма по дням (Chart.js) -->
  <div style="background:#fff; border-radius:8px; padding:12px; box-shadow:0 2px 4px rgba(0,0,0,0.05); margin-top:8px;">
    <canvas id="paymentsChart" height="120"></canvas>
  </div>

  <!-- Фильтры (клиентская фильтрация по колонкам) -->
  <div class="filter-row">
    <table style="width: 100%; border-collapse: collapse;">
      <tr>
        <td style="padding: 0 2px;"><input type="text" id="f-id" placeholder="ID"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-provider" placeholder="Провайдер"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-payment" placeholder="Payment ID"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-tariff" placeholder="Тариф"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-email" placeholder="Email"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-amount" placeholder="Сумма"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-user" placeholder="User ID"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-country" placeholder="Страна"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-created" placeholder="Создан"></td>
        <td style="padding: 0 2px;"><input type="text" id="f-status" placeholder="Статус"></td>
        <td style="padding: 0 2px; width: 80px;"></td>
      </tr>
    </table>
  </div>

  <div style="overflow-x: auto;">
    <table class="unified-table">
      <thead>
        <tr>
          <th style="width: 50px;">ID</th>
          <th style="width: 80px;">Провайдер</th>
          <th style="width: 100px;">Payment ID</th>
          <th style="width: 80px;">Тариф</th>
          <th style="width: 140px;">Email</th>
          <th style="width: 100px;">Сумма</th>
          <th style="width: 80px;">User</th>
          <th style="width: 90px;">Страна</th>
          <th style="width: 100px;">Создан</th>
          <th style="width: 90px;">Статус</th>
          <th style="width: 120px;">Действия</th>
        </tr>
      </thead>
      <tbody id="payments-tbody">
        {% for p in payments %}
        <tr>
          <td>{{ p.id }}</td>
          <td>
            {% set prov = (p.provider.value if (p.provider is not none and (p.provider is not string)) else (p.provider or 'yookassa')) %}
            <span class="badge active">{{ prov|lower }}</span>
          </td>
          <td><div class="code" title="{{ p.payment_id }}"><a href="/payments/{{ p.payment_id }}">{{ p.payment_id }}</a></div></td>
          <td><span class="badge active">{{ p.tariff_id }}</span></td>
          <td>{% if p.email %}<span class="email">{{ p.email }}</span>{% else %}<span class="text-muted">—</span>{% endif %}</td>
          <td>{{ p.amount|rub }}</td>
          <td>{{ p.user_id }}</td>
          <td>{{ p.country or '—' }}</td>
          <td class="date-cell" title="{{ (p.created_at.timestamp() if p.created_at else 0) | timestamp }}">{{ (p.created_at.timestamp() if p.created_at else 0) | timestamp | truncate(10) }}</td>
          <td>
            {% set st = (p.status | status_text) %}
            {% if st == 'paid' %}
              <span class="badge active">paid</span>
            {% elif st == 'pending' %}
              <span class="badge pending">pending</span>
            {% elif st in ['failed','cancelled','expired'] %}
              <span class="badge expired">{{ st }}</span>
            {% else %}
              <span class="badge">{{ st }}</span>
            {% endif %}
          </td>
          <td>
            <div class="action-buttons">
              <form method="post" action="/payments/{{ p.payment_id }}/recheck" onsubmit="return submitAjax(event, this)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn btn-primary" title="Перепроверить"><span class="material-icons">refresh</span></button>
              </form>
              <form method="post" action="/payments/{{ p.payment_id }}/issue" onsubmit="return submitAjax(event, this)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn" title="Выдать ключ"><span class="material-icons">vpn_key</span></button>
              </form>
              {% if (p.status.value if p.status else p.status) != 'refunded' %}
              <form method="post" action="/payments/{{ p.payment_id }}/refund" onsubmit="return submitAjax(event, this)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <input type="hidden" name="amount" value="{{ p.amount }}" />
                <button class="btn btn-danger" title="Возврат"><span class="material-icons">undo</span></button>
              </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="pagination">
    {% set pages = (total // limit) + (1 if (total % limit) else 0) %}
    {% if page > 1 %}
      <a class="btn" href="/payments?page={{ page-1 }}&limit={{ limit }}&sort_by={{ sort.by }}&sort_order={{ sort.order }}">←</a>
    {% endif %}
    {% for p in range(1, pages+1) %}
      {% if p == 1 or p == pages or (p >= page-2 and p <= page+2) %}
        <a class="btn {% if p==page %}active{% endif %}" href="/payments?page={{ p }}&limit={{ limit }}&sort_by={{ sort.by }}&sort_order={{ sort.order }}">{{ p }}</a>
      {% elif p == page-3 or p == page+3 %}
        <span style="padding:4px 8px; color:#6b7280;">…</span>
      {% endif %}
    {% endfor %}
    {% if page < pages %}
      <a class="btn" href="/payments?page={{ page+1 }}&limit={{ limit }}&sort_by={{ sort.by }}&sort_order={{ sort.order }}">→</a>
    {% endif %}
  </div>
</div>

<script>
const filters = [
  document.getElementById('f-id'),
  document.getElementById('f-provider'),
  document.getElementById('f-payment'),
  document.getElementById('f-tariff'),
  document.getElementById('f-email'),
  document.getElementById('f-amount'),
  document.getElementById('f-user'),
  document.getElementById('f-country'),
  document.getElementById('f-created'),
  document.getElementById('f-status')
];

const tbody = document.getElementById('payments-tbody');
const rows = Array.from(tbody.rows);
const pageSize = 10;
let currentPage = 1;
let filteredRows = rows.slice();

function filterTable() {
  filteredRows = rows.filter(row => {
    for (let i = 0; i < filters.length; i++) {
      const f = filters[i];
      if (!f) continue;
      const v = f.value.trim().toLowerCase();
      const txt = row.cells[i].textContent.toLowerCase();
      if (v && !txt.includes(v)) return false;
    }
    return true;
  });
  currentPage = 1;
  renderPage();
  renderPagination();
}

function renderPage() {
  tbody.innerHTML = '';
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  filteredRows.slice(start, end).forEach(r => tbody.appendChild(r.cloneNode(true)));
}

function renderPagination() {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const pageCount = Math.ceil(filteredRows.length / pageSize);
  if (pageCount <= 1) return;
  if (currentPage > 1) {
    const prev = document.createElement('button');
    prev.textContent = '←'; prev.className = 'btn';
    prev.onclick = () => { currentPage--; renderPage(); renderPagination(); };
    pagination.appendChild(prev);
  }
  for (let i = 1; i <= pageCount; i++) {
    if (i === 1 || i === pageCount || (i >= currentPage - 2 && i <= currentPage + 2)) {
      const btn = document.createElement('button');
      btn.textContent = i; btn.className = 'btn' + (i === currentPage ? ' active' : '');
      btn.onclick = () => { currentPage = i; renderPage(); renderPagination(); };
      pagination.appendChild(btn);
    } else if (i === currentPage - 3 || i === currentPage + 3) {
      const dots = document.createElement('span'); dots.textContent = '...'; dots.style.padding = '8px 12px'; dots.style.color = '#6b7280';
      pagination.appendChild(dots);
    }
  }
  if (currentPage < pageCount) {
    const next = document.createElement('button');
    next.textContent = '→'; next.className = 'btn';
    next.onclick = () => { currentPage++; renderPage(); renderPagination(); };
    pagination.appendChild(next);
  }
}

async function submitAjax(e, form) {
  e.preventDefault();
  const resp = await fetch(form.action, { method: 'POST', body: new FormData(form) });
  const data = await resp.json().catch(() => ({}));
  alert(data.success ? 'Готово' : ('Ответ: ' + JSON.stringify(data)));
  window.location.reload();
  return false;
}

async function reconcileNow(csrf) {
  const fd = new FormData();
  fd.append('csrf_token', csrf);
  const resp = await fetch('/payments/reconcile', { method: 'POST', body: fd });
  const data = await resp.json().catch(() => ({}));
  if (data && data.success) {
    alert(`Реконсиляция выполнена. pending: ${data.pending_processed}, доп.выдач: ${data.issued_processed}`);
    window.location.reload();
  } else {
    alert('Ошибка: ' + (data.error || 'unknown'));
  }
}

document.addEventListener('DOMContentLoaded', function() {
  filters.forEach(i => i && i.addEventListener('input', filterTable));
  renderPage();
  renderPagination();

  // Chart.js simple line chart
  try {
    const ctx = document.getElementById('paymentsChart');
    if (ctx && window.Chart) {
      const data = {{ daily_stats | tojson | safe }};
      const labels = data.map(d => d.date);
      const amounts = data.map(d => d.amount);
      const paid = data.map(d => d.paid);
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Оплачено, ₽', data: amounts, borderColor: '#10b981', fill: false, tension: 0.2 },
            { label: 'Число оплат', data: paid, borderColor: '#3b82f6', fill: false, tension: 0.2 }
          ]
        },
        options: { plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
      });
    }
  } catch (e) { console.warn('Chart error', e); }
});
</script>
{% endblock %}



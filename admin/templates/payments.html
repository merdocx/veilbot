{% extends "base.html" %}

{% block title %}Платежи{% endblock %}
{% block page_title %}Платежи{% endblock %}

{% block content %}
{% set current_status = status or '' %}
{% set current_preset = preset or '' %}

<!-- Stats Cards -->
<div class="stats-grid">
    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter=""
        data-preset-filter=""
        aria-pressed="{{ 'true' if (current_status == '' and current_preset == '') else 'false' }}"
        aria-label="Показать все платежи">
        <div class="stat-value">{{ total }}</div>
        <div class="stat-label">Все платежи</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter="paid"
        data-preset-filter=""
        aria-pressed="{{ 'true' if current_status == 'paid' else 'false' }}"
        aria-label="Показать оплаченные платежи">
        <div class="stat-value">{{ paid_count }}</div>
        <div class="stat-label">Оплачено</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter="pending"
        data-preset-filter=""
        aria-pressed="{{ 'true' if current_status == 'pending' or current_preset == 'pending' else 'false' }}"
        aria-label="Показать ожидающие платежи">
        <div class="stat-value">{{ pending_count }}</div>
        <div class="stat-label">Ожидает</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter=""
        data-preset-filter="errors"
        aria-pressed="{{ 'true' if current_preset == 'errors' or current_status in ['failed','cancelled','expired'] else 'false' }}"
        aria-label="Показать проблемные платежи">
        <div class="stat-value">{{ failed_count }}</div>
        <div class="stat-label">Проблемы</div>
    </button>
</div>

<!-- Payments Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Платежи</h2>
        <p class="card-subtitle">Управление платежами и транзакциями</p>
        <div class="mt-2">
            <button class="btn btn-primary" data-action="reconcile" data-csrf="{{ csrf_token }}">
                <span class="material-icons icon-small">sync</span>
                Реконсиляция
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <form method="get" action="/payments" class="flex-wrap" data-payments-filter-form>
            <input type="text" name="email" placeholder="Поиск по email" value="{{ email }}" class="filter-input">
            <input type="text" name="user_id" placeholder="User ID" value="{{ user_id }}" class="filter-input">
            <input type="text" name="payment_id" placeholder="Payment ID" value="{{ payment_id }}" class="filter-input">
            <select name="status" class="form-control" id="payments-status-select" data-filter-status-select>
                <option value="">Все статусы</option>
                <option value="paid" {% if status == 'paid' %}selected{% endif %}>Оплачен</option>
                <option value="pending" {% if status == 'pending' %}selected{% endif %}>Ожидает</option>
                <option value="failed" {% if status == 'failed' %}selected{% endif %}>Ошибка</option>
                <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Отменён</option>
                <option value="expired" {% if status == 'expired' %}selected{% endif %}>Истёк</option>
                <option value="refunded" {% if status == 'refunded' %}selected{% endif %}>Возврат</option>
            </select>
            <input type="hidden" name="preset" value="{{ preset }}" data-filter-preset-input>
            <button type="submit" class="btn btn-primary">
                <span class="material-icons icon-small">search</span>
                Поиск
            </button>
            <a href="/payments" class="btn">
                <span class="material-icons icon-small">clear</span>
                Сбросить
            </a>
        </form>
    </div>

    <!-- Table -->
    <div class="table-scroll">
        <table class="material-table" id="payments-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Провайдер</th>
                    <th>Payment ID</th>
                    <th>Тариф</th>
                    <th>Email</th>
                    <th>Сумма</th>
                    <th>User</th>
                    <th>Страна</th>
                    <th>Создан</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payments %}
                <tr>
                    <td>{{ p.id }}</td>
                    <td>
                        {% set prov = (p.provider.value if (p.provider is not none and (p.provider is not string)) else (p.provider or 'yookassa')) %}
                        <span class="badge badge-info">
                            <span class="material-icons icon-small">payment</span>
                            {{ prov|lower }}
                        </span>
                    </td>
                    <td>
                        <div class="inline-flex">
                            <span class="code" title="{{ p.payment_id }}">
                                <a href="/payments/{{ p.payment_id }}" class="link-plain">
                                    {{ p.payment_id|string|truncate(20) }}
                                </a>
                            </span>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-neutral">{{ p.tariff_id }}</span>
                    </td>
                    <td>
                        {% if p.email %}
                            <span class="text-muted">{{ p.email }}</span>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="text-large">{{ p.amount|rub }}</span>
                    </td>
                    <td>{{ p.user_id }}</td>
                    <td>{{ p.country or '—' }}</td>
                    <td class="text-small">
                        {{ (p.created_at.timestamp() if p.created_at else 0) | timestamp | truncate(10) }}
                    </td>
                    <td class="text-center">
                        {% set st = (p.status | status_text) %}
                        {% if st == 'paid' %}
                            <span class="material-icons icon-lg icon-success" title="Оплачен">check_circle</span>
                        {% elif st == 'pending' %}
                            <span class="material-icons icon-lg icon-warning" title="Ожидает">schedule</span>
                        {% elif st in ['failed','cancelled','expired'] %}
                            <span class="material-icons icon-lg icon-danger" title="{{ st }}">cancel</span>
                        {% else %}
                            <span class="material-icons icon-lg icon-muted" title="{{ st }}">help_outline</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <form method="post" action="/payments/{{ p.payment_id }}/recheck" data-action="payments-form" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-primary" title="Перепроверить">
                                    <span class="material-icons icon-small">refresh</span>
                                </button>
                            </form>
                            <a href="/payments/{{ p.payment_id }}" class="btn" title="Подробнее">
                                <span class="material-icons icon-small">visibility</span>
                            </a>
                            <form method="post" action="/payments/{{ p.payment_id }}/delete" data-action="delete-payment" data-payment-id="{{ p.payment_id }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-danger" title="Удалить" type="submit">
                                    <span class="material-icons icon-small">delete</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
            <span class="material-icons icon-small">chevron_left</span>
        </a>
    {% endif %}
    
    {% for p in range(1, pages + 1) %}
        {% if p == page %}
            <a href="#" class="active">{{ p }}</a>
        {% elif p <= 3 or p >= pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?page={{ p }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
            <span>...</span>
        {% elif p == pages - 3 and page < pages - 4 %}
            <span>...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < pages %}
        <a href="?page={{ page + 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}">
            <span class="material-icons icon-small">chevron_right</span>
        </a>
    {% endif %}
</div>
{% endif %}

{% block extra_scripts %}
    {{ super() }}
    <script type="module" src="/static/js/payments.js"></script>
{% endblock %}
{% endblock %}
{% extends "base.html" %}

{% block title %}–ü–ª–∞—Ç–µ–∂–∏{% endblock %}
{% block page_title %}–ü–ª–∞—Ç–µ–∂–∏{% endblock %}

{% block content %}
{% set current_status = status or '' %}
{% set current_preset = preset or '' %}

<!-- Stats Cards -->
<div class="stats-grid">
    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter=""
        data-preset-filter=""
        aria-pressed="{{ 'true' if (current_status == '' and current_preset == '') else 'false' }}"
        aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏">
        <div class="stat-value">{{ total_payments_all }}</div>
        <div class="stat-label">–í—Å–µ –ø–ª–∞—Ç–µ–∂–∏</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter="pending"
        data-preset-filter=""
        aria-pressed="{{ 'true' if current_status == 'pending' or current_preset == 'pending' else 'false' }}"
        aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏">
        <div class="stat-value">{{ pending_count_all }}</div>
        <div class="stat-label">–û–∂–∏–¥–∞–µ—Ç</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter="paid"
        data-preset-filter=""
        aria-pressed="{{ 'true' if current_status == 'paid' else 'false' }}"
        aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏">
        <div class="stat-value">{{ paid_count_all }}</div>
        <div class="stat-label">–û–ø–ª–∞—á–µ–Ω–æ</div>
    </button>

    <button type="button"
        class="stat-card stat-card--action"
        data-status-filter=""
        data-preset-filter=""
        aria-pressed="false"
        aria-label="–û–±—â–∞—è —Å—É–º–º–∞ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º">
        <div class="stat-value">
            {{ (completed_total_amount_rub if completed_total_amount_rub is defined else completed_total_amount) | rub }}
            {% if completed_total_amount_usd is defined and completed_total_amount_usd %}
                <div class="text-muted" style="font-size: 12px; margin-top: 2px;">
                    + ${{ "%.2f"|format(completed_total_amount_usd / 100.0) }}
                </div>
            {% endif %}
        </div>
        <div class="stat-label">–°—É–º–º–∞ (completed)</div>
    </button>
</div>

<!-- Payments Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">–ü–ª–∞—Ç–µ–∂–∏</h2>
        <p class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏</p>
        <div class="mt-2">
            <button class="btn btn-primary" data-action="reconcile" data-csrf="{{ csrf_token }}">
                <span class="material-icons icon-small">sync</span>
                –†–µ–∫–æ–Ω—Å–∏–ª—è—Ü–∏—è
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <div class="filter-bar__group flex-1">
            <form method="get" action="/payments" id="search-form" style="display: flex; gap: 8px; flex: 1; align-items: center;">
                <select name="status" id="status-filter" class="filter-input" style="min-width: 180px;">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã</option>
                    <option value="paid" {% if status == 'paid' %}selected{% endif %}>‚úÖ –û–ø–ª–∞—á–µ–Ω</option>
                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω</option>
                    <option value="failed" {% if status == 'failed' %}selected{% endif %}>‚ùå –ù–µ—É–¥–∞—á–µ–Ω</option>
                    <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>üö´ –û—Ç–º–µ–Ω–µ–Ω</option>
                    <option value="refunded" {% if status == 'refunded' %}selected{% endif %}>‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—â–µ–Ω</option>
                    <option value="expired" {% if status == 'expired' %}selected{% endif %}>‚è∞ –ò—Å—Ç–µ–∫</option>
                </select>
                <input type="text" id="global-search" name="q" value="{{ search_query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, payment_id, email, user_id..." class="filter-input filter-input--grow" data-server-search="1" data-auto-search="1">
                <input type="hidden" name="page" value="1" id="search-page-input">
                {% if user_id %}<input type="hidden" name="user_id" value="{{ user_id }}">{% endif %}
                {% if tariff_id %}<input type="hidden" name="tariff_id" value="{{ tariff_id }}">{% endif %}
                {% if provider %}<input type="hidden" name="provider" value="{{ provider }}">{% endif %}
                {% if protocol %}<input type="hidden" name="protocol" value="{{ protocol }}">{% endif %}
                {% if country %}<input type="hidden" name="country" value="{{ country }}">{% endif %}
                {% if preset %}<input type="hidden" name="preset" value="{{ preset }}">{% endif %}
                <button type="submit" class="btn btn-primary" style="display: none;" id="search-submit-btn">–ü–æ–∏—Å–∫</button>
            </form>
            <button type="button" class="btn" id="reset-search-btn">
                <span class="material-icons icon-small">clear</span>
                –°–±—Ä–æ—Å–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-scroll">
        <table class="material-table" id="payments-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                    <th>–¢–∞—Ä–∏—Ñ</th>
                    <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payments %}
                <tr>
                    <td>{{ p.id }}</td>
                    <td>
                        {% set prov = (p.provider.value if (p.provider is not none and (p.provider is not string)) else (p.provider or 'yookassa')) %}
                        <div class="cell-primary">{{ prov|replace('_', ' ')|capitalize }}</div>
                        <div class="cell-secondary">
                            <a href="/payments/{{ p.payment_id }}" class="link-plain text-muted" title="–û—Ç–∫—Ä—ã—Ç—å –ø–ª–∞—Ç–µ–∂">
                                ID: {{ p.payment_id|string|truncate(18) }}
                            </a>
                        </div>
                    </td>
                    <td>
                        <div class="cell-primary">#{{ p.tariff_id or '‚Äî' }}</div>
                    </td>
                    <td>
                        {% if p.subscription_id %}
                            <div class="cell-primary">
                                <a href="/subscriptions?q={{ p.subscription_id }}&page=1" class="link-plain" title="–û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–ø–∏—Å–∫—É #{{ p.subscription_id }}">
                                    #{{ p.subscription_id }}
                                </a>
                            </div>
                        {% else %}
                            <div class="cell-primary text-muted">‚Äî</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if p.user_id %}
                            <div class="cell-primary">TG: {{ p.user_id }}</div>
                        {% else %}
                            <div class="cell-primary text-muted">‚Äî</div>
                        {% endif %}
                        {% if p.email %}
                            <div class="cell-secondary text-muted" title="{{ p.email }}">{{ p.email }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {# currency –º–æ–∂–µ—Ç –±—ã—Ç—å –∏ —Å—Ç—Ä–æ–∫–æ–π ('USD'), –∏ enum-–æ–º —Å .value #}
                        {% set currency_value = (p.currency.value if (p.currency is not none and p.currency.value is defined) else (p.currency or 'RUB')) %}
                        {% if currency_value == 'USD' %}
                            <div class="cell-primary">${{ "%.2f"|format(p.amount / 100.0) }}</div>
                        {% else %}
                            <div class="cell-primary">{{ p.amount|rub }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="cell-primary">{{ (p.created_at.timestamp() if p.created_at else 0) | timestamp }}</div>
                    </td>
                    <td>
                        {% set st = (p.status | status_text) %}
                        <div class="cell-primary">{{ st }}</div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <form method="post" action="/payments/{{ p.payment_id }}/recheck" data-action="payments-form" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-primary" title="–ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å">
                                    <span class="material-icons icon-small">refresh</span>
                                </button>
                            </form>
                            <a href="/payments/{{ p.payment_id }}" class="btn" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                                <span class="material-icons icon-small">visibility</span>
                            </a>
                            <form method="post" action="/payments/{{ p.payment_id }}/delete" data-action="delete-payment" data-payment-id="{{ p.payment_id }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                                <button class="btn btn-danger" title="–£–¥–∞–ª–∏—Ç—å" type="submit">
                                    <span class="material-icons icon-small">delete</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">
            <span class="material-icons icon-small">chevron_left</span>
        </a>
    {% endif %}
    
    {% for p in range(1, pages + 1) %}
        {% if p == page %}
            <a href="#" class="active">{{ p }}</a>
        {% elif p <= 3 or p >= pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="?page={{ p }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
            <span>...</span>
        {% elif p == pages - 3 and page < pages - 4 %}
            <span>...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < pages %}
        <a href="?page={{ page + 1 }}{% if email %}&email={{ email }}{% endif %}{% if user_id %}&user_id={{ user_id }}{% endif %}{% if payment_id %}&payment_id={{ payment_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">
            <span class="material-icons icon-small">chevron_right</span>
        </a>
    {% endif %}
</div>
{% endif %}

<style>
/* –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞ "–ü–æ–¥–ø–∏—Å–∫–∞" –≤ 2 —Ä–∞–∑–∞ */
#payments-table thead th:nth-child(4),
#payments-table tbody td:nth-child(4) {
    width: 80px;
    min-width: 80px;
    max-width: 80px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É */
#status-filter {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background: white;
    font-size: 14px;
    cursor: pointer;
    transition: border-color 0.2s ease;
}

#status-filter:hover {
    border-color: #1976d2;
}

#status-filter:focus {
    outline: none;
    border-color: #1976d2;
    box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
}
</style>

{% block extra_scripts %}
    {{ super() }}
    <script type="module" src="/static/js/payments.js"></script>
{% endblock %}
{% endblock %}
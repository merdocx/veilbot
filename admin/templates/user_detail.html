{% extends "base.html" %}

{% block page_title %}Пользователь {{ user.user_id }}{% endblock %}

{% block content %}
<div class="card mb-3">
  <div class="card-header">
    <h2 class="card-title">Информация о пользователе</h2>
  </div>
  <div class="card-body">
    <div class="grid-two">
      <div>
        <div class="kv-list"><b>User ID</b><span class="vv">{{ user.user_id }}</span></div>
      </div>
      <div>
        <div class="kv-list"><b>Email</b><span class="vv">{{ user.email or '—' }}</span></div>
      </div>
      <div>
        <div class="kv-list"><b>Ключей Outline</b><span class="vv">{{ user.outline_count }}</span></div>
      </div>
      <div>
        <div class="kv-list"><b>Ключей V2Ray</b><span class="vv">{{ user.v2ray_count }}</span></div>
      </div>
      <div>
        <div class="kv-list"><b>Рефералы</b><span class="vv">{{ user.referrals }}</span></div>
      </div>
      <div>
        <div class="kv-list"><b>Последняя активность</b><span class="vv">{{ user.last_activity|timestamp }}</span></div>
      </div>
    </div>
  </div>
</div>

<div class="table-container">
  <div class="table-header">
    <h2>Ключи пользователя</h2>
  </div>
  <div class="table-scroll">
    <table class="material-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Протокол</th>
          <th>Access URL</th>
          <th>Тариф</th>
          <th>Email</th>
          <th>Сервер</th>
          <th>Создан</th>
          <th>Истекает</th>
          <th>Статус</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for k in keys %}
        <tr>
          <td>{{ k[0] }}</td>
          <td class="text-center">
            {% if k[8] == 'outline' %}
              <span class="material-icons icon-lg icon-primary" title="Outline">lock</span>
            {% elif k[8] == 'v2ray' %}
              <span class="material-icons icon-lg icon-primary" title="V2Ray">security</span>
            {% else %}
              <span class="material-icons icon-lg icon-muted" title="{{ k[8] }}">help_outline</span>
            {% endif %}
          </td>
          <td><span class="code" title="{{ k[2] }}">{{ k[2]|truncate(40) }}</span></td>
          <td>{{ k[7] or '—' }}</td>
          <td>{{ k[6] or '—' }}</td>
          <td>{{ k[5] }}</td>
          <td>{{ k[3]|timestamp }}</td>
          <td>{{ k[4]|timestamp }}</td>
          <td class="text-center">
            {% if k[4] > (namespace().now_ts if false else 0) %}
              <span class="material-icons icon-lg icon-success" title="Активен">check_circle</span>
            {% else %}
              <span class="material-icons icon-lg icon-danger" title="Истек">cancel</span>
            {% endif %}
          </td>
          <td>
            <div class="action-buttons">
              <form method="post" action="/users/keys/{{ k[0] }}/resend" data-user-action="resend" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn" type="submit">Отправить</button>
              </form>
              <form method="post" action="/users/keys/{{ k[0] }}/extend" data-user-action="extend" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <input type="number" name="days" value="30" min="1" class="form-control input-inline" />
                <button class="btn" type="submit">Продлить</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not keys %}
        <tr><td colspan="10" class="text-center text-muted">Нет ключей</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="pagination">
    {% set pages = (total // limit) + (1 if (total % limit) else 0) %}
    {% if page > 1 %}
      <a class="btn" href="/users/{{ user.user_id }}?page={{ page-1 }}&limit={{ limit }}">←</a>
    {% endif %}
    {% for p in range(1, pages+1) %}
      {% if p == 1 or p == pages or (p >= page-2 and p <= page+2) %}
        <a class="btn {% if p==page %}active{% endif %}" href="/users/{{ user.user_id }}?page={{ p }}&limit={{ limit }}">{{ p }}</a>
      {% elif p == page-3 or p == page+3 %}
        <span class="text-muted">…</span>
      {% endif %}
    {% endfor %}
    {% if page < pages %}
      <a class="btn" href="/users/{{ user.user_id }}?page={{ page+1 }}&limit={{ limit }}">→</a>
    {% endif %}
  </div>
</div>

<div class="table-container mt-2">
  <div class="table-header">
    <h2>Платежи пользователя</h2>
  </div>
  <div class="table-scroll">
    <table class="material-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Payment ID</th>
          <th>Статус</th>
          <th>Сумма</th>
          <th>Провайдер</th>
          <th>Протокол</th>
          <th>Email</th>
          <th>Создан</th>
          <th>Оплачен</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for p in payments %}
        <tr>
          <td>{{ p.id }}</td>
          <td><a href="/payments/{{ p.payment_id }}" class="code">{{ p.payment_id }}</a></td>
          <td>
            {% set st = (p.status.value if p.status is not string and p.status.value is defined else p.status) %}
            {% if st == 'paid' %}
              <span class="badge badge-success">оплачен</span>
            {% elif st == 'pending' %}
              <span class="badge badge-warning">ожидает</span>
            {% else %}
              <span class="badge badge-error">ошибка</span>
            {% endif %}
          </td>
          <td>{{ (p.amount or 0) | int | rub }}</td>
          <td>{{ p.provider }}</td>
          <td>{{ p.protocol }}</td>
          <td>{{ p.email or '—' }}</td>
          <td>{{ p.created_at.timestamp() | int | timestamp }}</td>
          <td>{{ (p.paid_at.timestamp() if p.paid_at else 0) | int | timestamp }}</td>
          <td>
            {% if st == 'paid' %}
              <form method="post" action="/payments/{{ p.payment_id }}/issue" data-user-payment="issue" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn" type="submit">Выдать ключ</button>
              </form>
            {% elif st == 'pending' %}
              <form method="post" action="/payments/{{ p.payment_id }}/recheck" data-user-payment="recheck" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <button class="btn" type="submit">Перепроверить</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not payments %}
        <tr><td colspan="10" class="text-center text-muted">Нет платежей</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="table-container mt-2">
  <div class="table-header">
    <h2>Рефералы</h2>
  </div>
  <div class="table-scroll">
    <table class="material-table">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Email</th>
          <th>Дата приглашения</th>
          <th>Бонус</th>
        </tr>
      </thead>
      <tbody>
        {% for referral in referrals %}
        <tr>
          <td>
            <div class="cell-primary">{{ referral.user_id }}</div>
          </td>
          <td>
            {% if referral.email %}
              <div class="cell-primary" title="{{ referral.email }}">{{ referral.email }}</div>
            {% else %}
              <div class="cell-primary text-muted">—</div>
            {% endif %}
          </td>
          <td>
            {% if referral.created_at %}
              <div class="cell-primary">{{ referral.created_at|timestamp }}</div>
            {% else %}
              <div class="cell-primary text-muted">—</div>
            {% endif %}
          </td>
          <td>
            {% if referral.bonus_issued %}
              <span class="badge badge-success">Выдан</span>
            {% else %}
              <span class="badge badge-neutral">Не выдан</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if not referrals %}
        <tr><td colspan="4" class="text-center text-muted">Рефералы отсутствуют</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
    {{ super() }}
    <script type="module" src="/static/js/userDetail.js"></script>
{% endblock %}



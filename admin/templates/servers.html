{% extends "base.html" %}

{% block page_title %}–°–µ—Ä–≤–µ—Ä—ã{% endblock %}

{% block content %}
<!-- Servers Table -->
<div class="table-container">
    <table class="table servers-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                <th>API URL</th>
                <th>–í—ã–¥–∞–Ω–æ –∫–ª—é—á–µ–π</th>
                <th>–ú–∞–∫—Å. –∫–ª—é—á–µ–π</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°—Ç—Ä–∞–Ω–∞</th>
                <th></th>
            </tr>
            <tr>
                <th><input type="text" id="filter-id" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ ID" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-name" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-protocol" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-api-url" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ API URL" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-issued" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –≤—ã–¥–∞–Ω–æ" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-max-keys" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –º–∞–∫—Å." style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-status" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-country" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="servers-tbody">
            {% for s in servers %}
            <tr>
                <td>{{ s[0] }}</td>
                <td><strong>{{ s[1] }}</strong></td>
                <td>
                    {% if s[7] == 'v2ray' %}
                        <span class="badge badge-warning">üõ°Ô∏è V2Ray</span>
                    {% else %}
                        <span class="badge badge-primary">üîí Outline</span>
                    {% endif %}
                </td>
                <td><code class="code">{{ s[2] }}</code></td>
                <td>{% if s[11] %}{{ s[11] }}{% else %}<span class="text-muted">‚Äî</span>{% endif %}</td>
                <td>{{ s[4] }}</td>
                <td>
                    {% if s[5] %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                        <span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </td>
                <td><span class="badge badge-info">{{ s[6] }}</span></td>
                <td>
                    <div class="btn-group">
                        <a href="/servers/edit/{{ s[0] }}" class="btn btn-primary btn-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <span class="material-icons">edit</span>
                        </a>
                        <a href="/delete_server/{{ s[0] }}" class="btn btn-danger btn-sm" 
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')" title="–£–¥–∞–ª–∏—Ç—å">
                            <span class="material-icons">delete</span>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div id="pagination" style="display: flex; justify-content: center; align-items: center; margin: 1.5rem 0; gap: 0.5rem;"></div>

<!-- Add Server Form -->
<div class="form-container">
    <div class="card-header">
        <h2 class="card-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä</h2>
    </div>
    
    <!-- Step 1: Server Type Selection -->
    <div id="server-type-selection" class="server-type-container">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–µ—Ä–≤–µ—Ä–∞:</h3>
        <div class="server-type-options">
            <div class="server-type-option" data-type="outline">
                <div class="server-type-icon">üîí</div>
                <div class="server-type-title">Outline VPN</div>
                <div class="server-type-description">–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π VPN –ø—Ä–æ—Ç–æ–∫–æ–ª —Å –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é</div>
            </div>
            <div class="server-type-option" data-type="v2ray">
                <div class="server-type-icon">üõ°Ô∏è</div>
                <div class="server-type-title">V2Ray VLESS</div>
                <div class="server-type-description">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Å Reality –∏ –æ–±—Ñ—É—Å–∫–∞—Ü–∏–µ–π —Ç—Ä–∞—Ñ–∏–∫–∞</div>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Server Configuration Form -->
    <form id="server-form" method="post" action="/add_server" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="protocol" id="selected-protocol">
        
        <div class="form-header">
            <h3 id="form-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h3>
            <button type="button" id="back-to-selection" class="btn btn-secondary btn-sm">
                <span class="material-icons">arrow_back</span>
                –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø
            </button>
        </div>
        
        <div class="form-grid">
            <!-- Common Fields -->
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ *</label>
                <input type="text" name="name" class="form-input" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            
            <div class="form-group">
                <label class="form-label">API URL *</label>
                <input type="url" name="api_url" class="form-input" required placeholder="https://server.com:port/api">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ú–∞–∫—Å–∏–º—É–º –∫–ª—é—á–µ–π *</label>
                <input type="number" name="max_keys" class="form-input" required placeholder="100" min="1">
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                <input type="text" name="country" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É">
            </div>
            
            <!-- Outline-specific fields -->
            <div class="form-group outline-fields" style="display: none;">
                <label class="form-label">SHA256 —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ *</label>
                <input type="text" name="cert_sha256" class="form-input" placeholder="XX:XX:XX:XX:XX:XX:XX:XX">
            </div>
            
            <!-- V2Ray-specific fields -->
            <div class="form-group v2ray-fields" style="display: none;">
                <label class="form-label">–î–æ–º–µ–Ω *</label>
                <input type="text" name="domain" class="form-input" placeholder="example.com">
            </div>
            
            <div class="form-group v2ray-fields" style="display: none;">
                <label class="form-label">API –ö–ª—é—á *</label>
                <input type="text" name="api_key" class="form-input" placeholder="QBDMqDzCRh17NIGUsKDtWtoUmvwRVvSHHp4W8OCMcOM=" required>
                <small class="form-help">API –∫–ª—é—á –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ V2Ray —Å–µ—Ä–≤–µ—Ä–∞</small>
            </div>
            
            <div class="form-group v2ray-fields" style="display: none;">
                <label class="form-label">V2Ray –ü—É—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" name="v2ray_path" class="form-input" value="/v2ray" placeholder="/v2ray">
                <small class="form-help">–ü—É—Ç—å –¥–ª—è V2Ray API, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é /v2ray</small>
            </div>
            
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="active" checked>
                    <span>–ê–∫—Ç–∏–≤–µ–Ω</span>
                </label>
            </div>
        </div>
        
        <div class="card-actions">
            <button type="submit" class="btn btn-primary">
                <span class="material-icons">add</span>
                –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
            </button>
        </div>
    </form>
</div>

<style>
.server-type-container {
    text-align: center;
    margin-bottom: 2rem;
}

.server-type-container h3 {
    margin-bottom: 1.5rem;
    color: #333;
}

.server-type-options {
    display: flex;
    gap: 2rem;
    justify-content: center;
    flex-wrap: wrap;
}

.server-type-option {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 200px;
    background: white;
}

.server-type-option:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.server-type-option.selected {
    border-color: #007bff;
    background: #f8f9ff;
}

.server-type-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.server-type-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
}

.server-type-description {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.4;
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.form-header h3 {
    margin: 0;
    color: #333;
}

#back-to-selection {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
</style>

<script>
// Server type selection
document.querySelectorAll('.server-type-option').forEach(option => {
    option.addEventListener('click', function() {
        const selectedType = this.dataset.type;
        
        // Update UI
        document.querySelectorAll('.server-type-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        
        // Hide selection, show form
        document.getElementById('server-type-selection').style.display = 'none';
        document.getElementById('server-form').style.display = 'block';
        
        // Set protocol and form title
        document.getElementById('selected-protocol').value = selectedType;
        document.getElementById('form-title').textContent = 
            selectedType === 'outline' ? '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Outline VPN —Å–µ—Ä–≤–µ—Ä–∞' : '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ V2Ray VLESS —Å–µ—Ä–≤–µ—Ä–∞';
        
        // Show/hide specific fields
        const outlineFields = document.querySelectorAll('.outline-fields');
        const v2rayFields = document.querySelectorAll('.v2ray-fields');
        
        outlineFields.forEach(field => field.style.display = 'none');
        v2rayFields.forEach(field => field.style.display = 'none');
        
        if (selectedType === 'outline') {
            outlineFields.forEach(field => field.style.display = 'block');
        } else if (selectedType === 'v2ray') {
            v2rayFields.forEach(field => field.style.display = 'block');
        }
    });
});

// Back to selection
document.getElementById('back-to-selection').addEventListener('click', function() {
    document.getElementById('server-type-selection').style.display = 'block';
    document.getElementById('server-form').style.display = 'none';
    document.querySelectorAll('.server-type-option').forEach(opt => opt.classList.remove('selected'));
});
</script>
{% endblock %}

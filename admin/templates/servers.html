{% extends "base.html" %}

{% block title %}Серверы{% endblock %}
{% block page_title %}Серверы{% endblock %}

{% block content %}
<!-- Messages -->
{% if error %}
<div class="card" style="border-left: 4px solid #f44336; background: #ffebee;">
    <div class="card-header">
        <h3 style="color: #c62828; margin: 0;">
            <span class="material-icons icon">error</span>
            Ошибка
        </h3>
    </div>
    <div style="padding: 0 24px 20px 24px;">
        {{ error }}
    </div>
</div>
{% endif %}

{% if success %}
<div class="card" style="border-left: 4px solid #4caf50; background: #e8f5e8;">
    <div class="card-header">
        <h3 style="color: #2e7d32; margin: 0;">
            <span class="material-icons icon">check_circle</span>
            Успешно
        </h3>
    </div>
    <div style="padding: 0 24px 20px 24px;">
        {{ success }}
    </div>
</div>
{% endif %}

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ servers|length }}</div>
        <div class="stat-label">Всего серверов</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ active_servers }}</div>
        <div class="stat-label">Активных</div>
    </div>
</div>

<!-- Servers Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Серверы</h2>
        <p class="card-subtitle">Управление VPN серверами</p>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <div style="display: flex; gap: 16px; align-items: center; flex: 1; flex-wrap: wrap;">
            <input type="text" id="filter-id" placeholder="Фильтр по ID" class="filter-input">
            <input type="text" id="filter-name" placeholder="Фильтр по названию" class="filter-input">
            <input type="text" id="filter-protocol" placeholder="Фильтр по протоколу" class="filter-input">
            <input type="text" id="filter-country" placeholder="Фильтр по стране" class="filter-input">
            <button class="btn" onclick="clearFilters()">
                <span class="material-icons icon-small">clear</span>
                Очистить
            </button>
        </div>
    </div>

    <!-- Table -->
    <div style="overflow-x: auto;">
        <table class="material-table" id="servers-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Протокол</th>
                    <th>API URL</th>
                    <th>Ключей</th>
                    <th>Макс.</th>
                    <th>Статус</th>
                    <th>Страна</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for s in servers %}
                <tr>
                    <td>{{ s[0] }}</td>
                    <td>
                        <strong>{{ s[1] }}</strong>
                    </td>
                    <td style="text-align: center;">
                        {% if s[7] == 'v2ray' %}
                            <span class="material-icons" style="color: #1565c0;" title="V2Ray">security</span>
                        {% else %}
                            <span class="material-icons" style="color: #1565c0;" title="Outline">lock</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="code" title="{{ s[2] }}">{{ s[2]|truncate(30) }}</span>
                    </td>
                    <td>
                        {% if s[11] %}
                            <span class="badge badge-neutral">{{ s[11] }}</span>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>{{ s[4] }}</td>
                    <td style="text-align: center;">
                        {% if s[5] %}
                            <span class="material-icons" style="color: #2e7d32; font-size: 20px;" title="Активен">check_circle</span>
                        {% else %}
                            <span class="material-icons" style="color: #c62828; font-size: 20px;" title="Неактивен">cancel</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-info">
                            <span class="material-icons icon-small">public</span>
                            {{ s[6] }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/servers/edit/{{ s[0] }}" class="btn btn-primary" title="Редактировать">
                                <span class="material-icons icon-small">edit</span>
                            </a>
                            <a href="/delete_server/{{ s[0] }}" class="btn btn-danger" 
                               onclick="return confirm('Удалить сервер?')" title="Удалить">
                                <span class="material-icons icon-small">delete</span>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Server Form -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Добавить новый сервер</h2>
        <p class="card-subtitle">Создание нового VPN сервера</p>
    </div>
    
    <div style="padding: 24px;">
        <form method="post" action="/add_server">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div>
                    <label for="name" style="display: block; margin-bottom: 8px; font-weight: 500;">Название сервера:</label>
                    <input type="text" id="name" name="name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label for="api_url" style="display: block; margin-bottom: 8px; font-weight: 500;">API URL:</label>
                    <input type="url" id="api_url" name="api_url" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label for="max_keys" style="display: block; margin-bottom: 8px; font-weight: 500;">Максимум ключей:</label>
                    <input type="number" id="max_keys" name="max_keys" value="100" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label for="country" style="display: block; margin-bottom: 8px; font-weight: 500;">Страна:</label>
                    <input type="text" id="country" name="country" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                
                <div>
                    <label for="protocol" style="display: block; margin-bottom: 8px; font-weight: 500;">Протокол:</label>
                    <select id="protocol" name="protocol" onchange="toggleProtocolFields()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="outline" selected>Outline</option>
                        <option value="v2ray">V2Ray</option>
                    </select>
                </div>
            </div>
            
            <!-- Outline-specific fields -->
            <div id="outline-fields">
                <h3 style="margin: 24px 0 16px 0; color: #666;">Параметры Outline</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label for="cert_sha256" style="display: block; margin-bottom: 8px; font-weight: 500;">SHA256 сертификата (опционально):</label>
                        <input type="text" id="cert_sha256" name="cert_sha256" placeholder="Оставьте пустым для Outline" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            </div>
            
            <!-- V2Ray-specific fields -->
            <div id="v2ray-fields" style="display: none;">
                <h3 style="margin: 24px 0 16px 0; color: #666;">Параметры V2Ray</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label for="domain" style="display: block; margin-bottom: 8px; font-weight: 500;">Домен:</label>
                        <input type="text" id="domain" name="domain" placeholder="veil-bird.ru" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div>
                        <label for="v2ray_path" style="display: block; margin-bottom: 8px; font-weight: 500;">V2Ray путь:</label>
                        <input type="text" id="v2ray_path" name="v2ray_path" value="/usr/local/bin/xray" placeholder="/usr/local/bin/xray" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div>
                        <label for="api_key" style="display: block; margin-bottom: 8px; font-weight: 500;">API ключ (обязательно для V2Ray):</label>
                        <input type="text" id="api_key" name="api_key" placeholder="Вставьте API ключ V2Ray" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons icon-small">add</span>
                    Добавить сервер
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function clearFilters() {
    document.getElementById('filter-id').value = '';
    document.getElementById('filter-name').value = '';
    document.getElementById('filter-protocol').value = '';
    document.getElementById('filter-country').value = '';
    filterTable();
}

function filterTable() {
    const table = document.getElementById('servers-table');
    const rows = table.getElementsByTagName('tr');
    const idFilter = document.getElementById('filter-id').value.toLowerCase();
    const nameFilter = document.getElementById('filter-name').value.toLowerCase();
    const protocolFilter = document.getElementById('filter-protocol').value.toLowerCase();
    const countryFilter = document.getElementById('filter-country').value.toLowerCase();

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        const id = cells[0].textContent.toLowerCase();
        const name = cells[1].textContent.toLowerCase();
        const protocol = cells[2].textContent.toLowerCase();
        const country = cells[7].textContent.toLowerCase();
        
        const show = (!idFilter || id.includes(idFilter)) &&
                    (!nameFilter || name.includes(nameFilter)) &&
                    (!protocolFilter || protocol.includes(protocolFilter)) &&
                    (!countryFilter || country.includes(countryFilter));
        
        row.style.display = show ? '' : 'none';
    }
}

function toggleProtocolFields() {
    const protocol = document.getElementById('protocol').value;
    const outlineFields = document.getElementById('outline-fields');
    const v2rayFields = document.getElementById('v2ray-fields');
    const certSha256 = document.getElementById('cert_sha256');
    const apiKey = document.getElementById('api_key');
    
    if (protocol === 'v2ray') {
        outlineFields.style.display = 'none';
        v2rayFields.style.display = 'block';
        certSha256.required = false;
        apiKey.required = true;
    } else {
        outlineFields.style.display = 'block';
        v2rayFields.style.display = 'none';
        certSha256.required = false;
        apiKey.required = false;
    }
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('filter-id').addEventListener('input', filterTable);
    document.getElementById('filter-name').addEventListener('input', filterTable);
    document.getElementById('filter-protocol').addEventListener('input', filterTable);
    document.getElementById('filter-country').addEventListener('input', filterTable);
});
</script>
{% endblock %}
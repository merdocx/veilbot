{% extends "base.html" %}

{% block page_title %}–°–µ—Ä–≤–µ—Ä—ã{% endblock %}

{% block content %}
<!-- Messages -->
{% if error %}
<div class="alert alert-danger" style="margin-bottom: 1rem; padding: 1rem; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 0.375rem; color: #721c24;">
    <strong>–û—à–∏–±–∫–∞:</strong> {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success" style="margin-bottom: 1rem; padding: 1rem; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 0.375rem; color: #155724;">
    <strong>–£—Å–ø–µ—à–Ω–æ:</strong> {{ success }}
</div>
{% endif %}

<!-- Servers Table -->
<div class="table-container">
    <table class="table servers-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                <th>API URL</th>
                <th>–í—ã–¥–∞–Ω–æ –∫–ª—é—á–µ–π</th>
                <th>–ú–∞–∫—Å. –∫–ª—é—á–µ–π</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°—Ç—Ä–∞–Ω–∞</th>
                <th></th>
            </tr>
            <tr>
                <th><input type="text" id="filter-id" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ ID" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-name" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-protocol" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-api-url" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ API URL" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-issued" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –≤—ã–¥–∞–Ω–æ" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-max-keys" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –º–∞–∫—Å." style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-status" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th><input type="text" id="filter-country" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="servers-tbody">
            {% for s in servers %}
            <tr>
                <td>{{ s[0] }}</td>
                <td><strong>{{ s[1] }}</strong></td>
                <td>
                    {% if s[7] == 'v2ray' %}
                        <span class="badge badge-warning">üõ°Ô∏è V2Ray</span>
                    {% else %}
                        <span class="badge badge-primary">üîí Outline</span>
                    {% endif %}
                </td>
                <td><code class="code">{{ s[2] }}</code></td>
                <td>{% if s[11] %}{{ s[11] }}{% else %}<span class="text-muted">‚Äî</span>{% endif %}</td>
                <td>{{ s[4] }}</td>
                <td>
                    {% if s[5] %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                        <span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </td>
                <td><span class="badge badge-info">{{ s[6] }}</span></td>
                <td>
                    <div class="btn-group">
                        <a href="/servers/edit/{{ s[0] }}" class="btn btn-primary btn-sm" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <span class="material-icons">edit</span>
                        </a>
                        <a href="/delete_server/{{ s[0] }}" class="btn btn-danger btn-sm" 
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')" title="–£–¥–∞–ª–∏—Ç—å">
                            <span class="material-icons">delete</span>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div id="pagination" style="display: flex; justify-content: center; align-items: center; margin: 1.5rem 0; gap: 0.5rem;"></div>

<!-- Add Server Form -->
<div class="form-container">
    <div class="card-header">
        <h2 class="card-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä</h2>
    </div>
    
    <form id="server-form" method="post" action="/add_server">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <!-- Protocol selector -->
        <div class="form-group">
            <label class="form-label">–ü—Ä–æ—Ç–æ–∫–æ–ª *</label>
            <div style="display:flex; gap:1rem; align-items:center;">
                <label class="form-radio">
                    <input type="radio" name="protocol" value="outline" checked>
                    <span>Outline</span>
                </label>
                <label class="form-radio">
                    <input type="radio" name="protocol" value="v2ray">
                    <span>V2Ray VLESS</span>
                </label>
            </div>
        </div>
        
        <div class="form-grid">
            <!-- Common Fields -->
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ *</label>
                <input type="text" name="name" class="form-input" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
            </div>
            
            <div class="form-group">
                <label class="form-label">API URL *</label>
                <input type="url" name="api_url" class="form-input" required placeholder="https://host:port/api">
            </div>
            
            <div class="form-group">
                <label class="form-label">–ú–∞–∫—Å–∏–º—É–º –∫–ª—é—á–µ–π *</label>
                <input type="number" name="max_keys" class="form-input" required placeholder="100" min="1">
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                <input type="text" name="country" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, Netherlands)">
            </div>
            
            <!-- Outline-specific fields -->
            <div class="form-group outline-only">
                <label class="form-label">SHA256 —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (Outline) *</label>
                <input type="text" name="cert_sha256" class="form-input" placeholder="HEX –∏–ª–∏ HEX:HEX:...">
            </div>
            
            <!-- V2Ray-specific fields -->
            <div class="form-group v2ray-only" style="display:none;">
                <label class="form-label">–î–æ–º–µ–Ω (V2Ray) *</label>
                <input type="text" name="domain" class="form-input" placeholder="example.com">
            </div>
            <div class="form-group v2ray-only" style="display:none;">
                <label class="form-label">API –ö–ª—é—á (V2Ray) *</label>
                <input type="text" name="api_key" class="form-input" placeholder="–í–∞—à API –∫–ª—é—á">
            </div>
            <div class="form-group v2ray-only" style="display:none;">
                <label class="form-label">V2Ray –ü—É—Ç—å</label>
                <input type="text" name="v2ray_path" class="form-input" value="/v2ray" placeholder="/v2ray">
            </div>
        </div>
        
        <div class="card-actions">
            <button id="add-server-btn" type="submit" class="btn btn-primary">
                <span class="material-icons">add</span>
                –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
            </button>
        </div>
    </form>
</div>

<style>
.server-type-container {
    text-align: center;
    margin-bottom: 2rem;
}

.server-type-container h3 {
    margin-bottom: 1.5rem;
    color: #333;
}

.server-type-options {
    display: flex;
    gap: 2rem;
    justify-content: center;
    flex-wrap: wrap;
}

.server-type-option {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 200px;
    background: white;
}

.server-type-option:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.server-type-option.selected {
    border-color: #007bff;
    background: #f8f9ff;
}

.server-type-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.server-type-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
}

.server-type-description {
    font-size: 0.9rem;
    color: #666;
    line-height: 1.4;
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #6c757d;
}

.form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.form-header h3 {
    margin: 0;
    color: #333;
}

#back-to-selection {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
</style>

<script>
// Protocol toggle logic (no hidden steps)
document.addEventListener('DOMContentLoaded', function() {
    try {
        const radios = document.querySelectorAll('input[name="protocol"]');
        const showFor = (proto) => {
            document.querySelectorAll('.outline-only').forEach(el => el.style.display = proto === 'outline' ? 'block' : 'none');
            document.querySelectorAll('.v2ray-only').forEach(el => el.style.display = proto === 'v2ray' ? 'block' : 'none');
        };
        const current = document.querySelector('input[name="protocol"]:checked');
        showFor(current ? current.value : 'outline');
        radios.forEach(r => r.addEventListener('change', e => showFor(e.target.value)));
    } catch(e) {
        console.error('Init error:', e);
    }
});

// Simple client-side validation for V2Ray required fields
document.getElementById('server-form').addEventListener('submit', function(e) {
    const proto = document.querySelector('input[name="protocol"]:checked')?.value || 'outline';
    if (proto === 'v2ray') {
        const domain = document.querySelector('input[name="domain"]').value.trim();
        const apiKey = document.querySelector('input[name="api_key"]').value.trim();
        if (!domain) { e.preventDefault(); alert('–î–æ–º–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è V2Ray'); return false; }
        if (!apiKey) { e.preventDefault(); alert('API –∫–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è V2Ray'); return false; }
    }
});

// Form submission validation
document.getElementById('server-form').addEventListener('submit', function(e) {
    const protocol = document.getElementById('selected-protocol').value;
    
    if (!protocol) {
        e.preventDefault();
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–µ—Ä–≤–µ—Ä–∞');
        return false;
    }
    
    // Validate required fields based on protocol
    if (protocol === 'v2ray') {
        const domain = document.querySelector('input[name="domain"]').value;
        const apiKey = document.querySelector('input[name="api_key"]').value;
        
        if (!domain.trim()) {
            e.preventDefault();
            alert('–ü–æ–ª–µ "–î–æ–º–µ–Ω" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è V2Ray —Å–µ—Ä–≤–µ—Ä–æ–≤');
            return false;
        }
        
        if (!apiKey.trim()) {
            e.preventDefault();
            alert('–ü–æ–ª–µ "API –ö–ª—é—á" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è V2Ray —Å–µ—Ä–≤–µ—Ä–æ–≤');
            return false;
        }
    }
    
    console.log('Form submitting with protocol:', protocol);
    return true;
});
</script>
{% endblock %}

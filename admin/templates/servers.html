{% extends "base.html" %}

{% block page_title %}Серверы{% endblock %}

{% block content %}
<!-- Servers Table -->
<div class="table-container">
    <table class="table servers-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Название</th>
      <th>API URL</th>
      <th>Выдано ключей</th>
      <th>Макс. ключей</th>
      <th>Статус</th>
      <th>Страна</th>
      <th></th>
    </tr>
    <tr>
      <th><input type="text" id="filter-id" placeholder="Фильтр по ID" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th><input type="text" id="filter-name" placeholder="Фильтр по названию" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th><input type="text" id="filter-api-url" placeholder="Фильтр по API URL" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th><input type="text" id="filter-issued" placeholder="Фильтр по выдано" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th><input type="text" id="filter-max-keys" placeholder="Фильтр по макс." style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th><input type="text" id="filter-status" placeholder="Фильтр по статусу" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th><input type="text" id="filter-country" placeholder="Фильтр по стране" style="width: 100%; box-sizing: border-box; border-radius: 3px; box-shadow: none; padding: 4px 8px;"></th>
      <th></th>
    </tr>
  </thead>
  <tbody id="servers-tbody">
    {% for s in servers %}
    <tr>
      <td>{{ s[0] }}</td>
      <td><strong>{{ s[1] }}</strong></td>
      <td><code class="code">{{ s[2] }}</code></td>
      <td>{% if s[7] %}{{ s[7] }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
      <td>{{ s[4] }}</td>
      <td>
        {% if s[5] %}
          <span class="badge badge-success">Активен</span>
        {% else %}
          <span class="badge badge-danger">Неактивен</span>
        {% endif %}
      </td>
      <td><span class="badge badge-info">{{ s[6] }}</span></td>
      <td>
        <div class="btn-group">
          <a href="/servers/edit/{{ s[0] }}" class="btn btn-primary btn-sm" title="Редактировать">
            <span class="material-icons">edit</span>
          </a>
          <a href="/delete_server/{{ s[0] }}" class="btn btn-danger btn-sm" 
             onclick="return confirm('Удалить сервер?')" title="Удалить">
            <span class="material-icons">delete</span>
          </a>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<!-- Пагинация -->
<div id="pagination" style="display: flex; justify-content: center; align-items: center; margin: 1.5rem 0; gap: 0.5rem;"></div>

<!-- Add Server Form -->
<div class="form-container">
    <div class="card-header">
        <h2 class="card-title">Добавить новый сервер</h2>
    </div>
    <form method="post" action="/add_server">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Название сервера</label>
                <input type="text" name="name" class="form-input" required placeholder="Введите название">
            </div>
            
            <div class="form-group">
                <label class="form-label">API URL</label>
                <input type="url" name="api_url" class="form-input" required placeholder="https://server.com:port/api">
            </div>
            
            <div class="form-group">
                <label class="form-label">SHA256 сертификата</label>
                <input type="text" name="cert_sha256" class="form-input" required placeholder="XX:XX:XX:XX:XX:XX:XX:XX">
            </div>
            
            <div class="form-group">
                <label class="form-label">Максимум ключей</label>
                <input type="number" name="max_keys" class="form-input" required placeholder="100" min="1">
            </div>
            
            <div class="form-group">
                <label class="form-label">Страна</label>
                <input type="text" name="country" class="form-input" placeholder="Введите страну">
            </div>
            
            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="active" checked>
        <span>Активен</span>
      </label>
    </div>
    </div>
        
        <div class="card-actions">
            <button type="submit" class="btn btn-primary">
                <span class="material-icons">add</span>
                Добавить сервер
            </button>
  </div>
</form>
</div>

<script>
const filters = [
  document.getElementById('filter-id'),
  document.getElementById('filter-name'),
  document.getElementById('filter-api-url'),
  document.getElementById('filter-issued'),
  document.getElementById('filter-max-keys'),
  document.getElementById('filter-status'),
  document.getElementById('filter-country')
];
const table = document.querySelector('.servers-table');
const tbody = document.getElementById('servers-tbody');
const rows = Array.from(tbody.rows);
const pageSize = 10;
let currentPage = 1;
let filteredRows = rows.slice();

function filterServersTable() {
  filteredRows = rows.filter(row => {
    for (let i = 0; i < filters.length; i++) {
      const filterValue = filters[i].value.trim().toLowerCase();
      let cellText = row.cells[i].textContent.toLowerCase();
      // Для статуса и страны убираем лишние пробелы и символы
      if (i === 5) cellText = cellText.replace(/\s+/g, '');
      if (!cellText.includes(filterValue)) {
        return false;
      }
    }
    return true;
  });
  currentPage = 1;
  renderPage();
  renderPagination();
}
filters.forEach(input => input.addEventListener('input', filterServersTable));

function renderPage() {
  tbody.innerHTML = '';
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  filteredRows.slice(start, end).forEach(row => tbody.appendChild(row));
}

function renderPagination() {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const pageCount = Math.ceil(filteredRows.length / pageSize);
  if (pageCount <= 1) return;
  for (let i = 1; i <= pageCount; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = 'btn btn-sm' + (i === currentPage ? ' btn-primary' : ' btn-secondary');
    btn.style.margin = '0 2px';
    btn.onclick = () => {
      currentPage = i;
      renderPage();
      renderPagination();
    };
    pagination.appendChild(btn);
  }
}

// Инициализация при загрузке
renderPage();
renderPagination();
</script>
{% endblock %}

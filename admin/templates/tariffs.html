{% extends "base.html" %}

{% block title %}–¢–∞—Ä–∏—Ñ—ã{% endblock %}
{% block page_title %}–¢–∞—Ä–∏—Ñ—ã{% endblock %}

{% block content %}
<!-- Tariffs Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">–¢–∞—Ä–∏—Ñ—ã</h2>
        <p class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏</p>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <div class="filter-bar__group flex-1">
            <form method="get" action="/tariffs" id="search-form" style="display: flex; gap: 8px; flex: 1;">
                <input type="text" id="global-search" name="q" value="{{ search_query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID, –Ω–∞–∑–≤–∞–Ω–∏—é, —Ü–µ–Ω–µ..." class="filter-input filter-input--grow" data-server-search="1" data-auto-search="1">
                <input type="hidden" name="page" value="1" id="search-page-input">
                <button type="submit" class="btn btn-primary" style="display: none;" id="search-submit-btn">–ü–æ–∏—Å–∫</button>
            </form>
            <button type="button" class="btn" id="reset-search-btn">
                <span class="material-icons icon-small">clear</span>
                –°–±—Ä–æ—Å–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-scroll">
        <table class="material-table" id="tariffs-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–¢—Ä–∞—Ñ–∏–∫</th>
                    <th>–û–ø–ª–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for t in tariffs %}
                <tr>
                    <td>{{ t[0] }}</td>
                    <td>
                        <div class="cell-primary" title="{{ t[1] }}">{{ t[1] }}</div>
                    </td>
                    <td>
                        {% set duration = t[2] %}
                        {% if duration >= 86400 %}
                            <div class="cell-primary">{{ (duration // 86400) }} –¥–Ω.</div>
                        {% elif duration >= 3600 %}
                            <div class="cell-primary">{{ (duration // 3600) }} —á.</div>
                        {% else %}
                            <div class="cell-primary">{{ (duration // 60) }} –º–∏–Ω.</div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="tariff-price">
                            {% if t[3] == 0 %}
                                <span class="tariff-price__line">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                            {% else %}
                                <span class="tariff-price__line">{{ t[3] }} ‚ÇΩ</span>
                                {% if t|length > 5 and t[5] and t[5] > 0 %}
                                    <span class="tariff-price__line">${{ "%.2f"|format(t[5]) }}</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% set traffic_limit = t[4] if t|length > 4 else None %}
                        {% if traffic_limit and traffic_limit > 0 %}
                            <div class="cell-primary">{{ traffic_limit }} –ú–ë</div>
                        {% else %}
                            <div class="cell-primary">–ë–µ–∑–ª–∏–º–∏—Ç</div>
                        {% endif %}
                    </td>
                    <td>
                        {# t: (id, name, duration_sec, price_rub, traffic_limit_mb, price_crypto_usd, enable_yookassa, enable_platega, enable_cryptobot) #}
                        {% set price_rub = t[3] %}
                        {% set price_crypto = t[5] if t|length > 5 else None %}
                        {% set enable_yookassa = t[6] if t|length > 6 else 1 %}
                        {% set enable_platega = t[7] if t|length > 7 else 1 %}
                        {% set enable_cryptobot = t[8] if t|length > 8 else 1 %}
                        <div class="tariff-price">
                            {% if price_rub == 0 %}
                                <span class="tariff-price__line">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ (–æ–ø–ª–∞—Ç—ã –Ω–µ—Ç)</span>
                            {% else %}
                                {% if enable_yookassa %}
                                    <span class="tariff-price__line">üí≥ YooKassa</span>
                                {% endif %}
                                {% if enable_platega %}
                                    <span class="tariff-price__line">üí≥ Platega</span>
                                {% endif %}
                                {% if enable_cryptobot and price_crypto and price_crypto > 0 %}
                                    <span class="tariff-price__line">‚Çø Crypto (USDT)</span>
                                {% endif %}
                                {% if (not enable_yookassa and not enable_platega and (not enable_cryptobot or not price_crypto or price_crypto <= 0)) %}
                                    <span class="tariff-price__line">–û–ø–ª–∞—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/tariffs/edit/{{ t[0] }}" class="btn btn-primary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <span class="material-icons icon-small">edit</span>
                            </a>
                            <a href="/delete_tariff/{{ t[0] }}" class="btn btn-danger" 
                               data-confirm="–£–¥–∞–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ?" title="–£–¥–∞–ª–∏—Ç—å">
                                <span class="material-icons icon-small">delete</span>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Tariff Form -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ</h2>
        <p class="card-subtitle">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞</p>
    </div>
    
    <div class="card-body">
        <form method="post" action="/add_tariff">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            
            <div class="form-grid mb-3">
                <div>
                    <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞:</label>
                    <input type="text" id="name" name="name" required class="form-control">
                </div>
                
                <div>
                    <label for="duration_sec" class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫—É–Ω–¥—ã):</label>
                    <input type="number" id="duration_sec" name="duration_sec" required min="1" class="form-control">
                    <small class="form-hint">–ù–∞–ø—Ä–∏–º–µ—Ä: 86400 = 1 –¥–µ–Ω—å, 2592000 = 30 –¥–Ω–µ–π</small>
                </div>
                
                <div>
                    <label for="traffic_limit_mb" class="form-label">–õ–∏–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (–ú–ë):</label>
                    <input type="number" id="traffic_limit_mb" name="traffic_limit_mb" min="0" class="form-control">
                    <small class="form-hint">0 = –±–µ–∑–ª–∏–º–∏—Ç</small>
                </div>
                
                <div>
                    <label for="price_rub" class="form-label">–¶–µ–Ω–∞ (—Ä—É–±–ª–∏):</label>
                    <input type="number" id="price_rub" name="price_rub" min="0" value="0" class="form-control">
                    <small class="form-hint">0 = –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ</small>
                </div>
                
                <div>
                    <label for="price_crypto_usd" class="form-label">–¶–µ–Ω–∞ –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–µ (USD):</label>
                    <input type="number" id="price_crypto_usd" name="price_crypto_usd" step="0.01" min="0" class="form-control">
                    <small class="form-hint">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –∫—Ä–∏–ø—Ç–æ-–æ–ø–ª–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞</small>
                </div>
            </div>

            <div class="form-grid mb-3">
                <div>
                    <label class="form-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="add_enable_yookassa" name="enable_yookassa" value="1" checked>
                        <label class="form-check-label" for="add_enable_yookassa">
                            –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ YooKassa (–∫–∞—Ä—Ç–∞ –†–§ / –°–ë–ü)
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="add_enable_platega" name="enable_platega" value="1" checked>
                        <label class="form-check-label" for="add_enable_platega">
                            –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ Platega (–∫–∞—Ä—Ç–∞ –†–§ / –∫–∞—Ä—Ç–∞ –∑–∞—Ä—É–±–µ–∂ / –°–ë–ü)
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="add_enable_cryptobot" name="enable_cryptobot" value="1" checked>
                        <label class="form-check-label" for="add_enable_cryptobot">
                            –†–∞–∑—Ä–µ—à–∏—Ç—å –æ–ø–ª–∞—Ç—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π (CryptoBot / USDT)
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="justify-end">
                <button type="submit" class="btn btn-primary">
                    <span class="material-icons icon-small">add</span>
                    –î–æ–±–∞–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ
                </button>
            </div>
        </form>
    </div>
</div>
{% block extra_scripts %}
    {{ super() }}
    <script type="module" src="/static/js/tariffs.js?v=20251202"></script>
{% endblock %}
{% endblock %}
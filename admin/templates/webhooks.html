{% extends "base.html" %}
{% block page_title %}Вебхуки{% endblock %}
{% block content %}
<style>
.keys-table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 0.8rem; }
.keys-table th { background: #f8fafc; padding: 8px 6px; text-align: left; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; white-space: nowrap; }
.keys-table td { padding: 8px 6px; border-bottom: 1px solid #f3f4f6; font-size: 0.75rem; vertical-align: top; }
.filter-row { background: #f8fafc; padding: 12px; border-bottom: 1px solid #e5e7eb; }
.filter-row input { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.8rem; box-sizing: border-box; }
.code { font-family: 'Courier New', monospace; background: #f3f4f6; padding: 4px 6px; border-radius: 4px; font-size: 0.75rem; word-break: break-all; }
.pagination { display: flex; justify-content: center; gap: 8px; margin: 1rem 0; }
.btn { padding: 6px 10px; border: 1px solid #d1d5db; background: #f3f4f6; border-radius: 4px; cursor: pointer; }
.btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
</style>

<div class="table-container">
  <div class="table-header">
    <h2>Журнал вебхуков</h2>
    {% if status %}
    <div style="margin-top:8px; padding:8px 10px; border-radius:6px; font-size:0.85rem; color:#fff; display:inline-block; background: {{ 'linear-gradient(90deg,#10b981,#34d399)' if status=='ok' else '#ef4444' }};">
      {{ 'Replay выполнен' if status=='ok' else 'Ошибка при повторной обработке' }}
    </div>
    {% endif %}
  </div>

  <div class="filter-row sticky">
    <form method="get" action="/webhooks" style="display:flex; gap:8px; align-items:center;">
      <input type="text" name="provider" placeholder="Провайдер" value="{{ filters.provider }}" />
      <input type="text" name="event" placeholder="Событие" value="{{ filters.event }}" />
      <input type="text" name="payment_id" placeholder="payment_id" value="{{ payment_id }}" />
      <input type="hidden" name="page" value="1" />
      <button class="btn" type="submit">Фильтр</button>
    </form>
  </div>

  <div style="overflow-x:auto; margin-top:1rem;">
    <table class="table keys-table">
      <thead>
        <tr>
          <th style="width:60px;">#</th>
          <th style="width:140px;">Время</th>
          <th style="width:120px;">Провайдер</th>
          <th style="width:120px;">Событие</th>
          <th style="width:80px;">Код</th>
          <th style="width:120px;">IP</th>
          <th>Payload</th>
          <th style="width:130px;">Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.id }}</td>
          <td>{{ log.ts | timestamp }}</td>
          <td>{{ log.provider }}</td>
          <td>{{ log.event }}</td>
          <td>{{ log.status_code }}</td>
          <td>{{ log.ip or '—' }}</td>
          <td><pre class="code">{{ log.payload | pretty_json }}</pre></td>
          <td>
            <form method="post" action="/webhooks/{{ log.id }}/replay" onsubmit="return confirm('Повторно обработать этот вебхук?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
              <button class="btn" type="submit">Replay</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        {% if not logs %}
        <tr><td colspan="7" style="text-align:center; color:#6b7280;">Нет записей</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="pagination">
    {% set pages = (total // limit) + (1 if (total % limit) else 0) %}
    {% if page > 1 %}
      <a class="btn" href="/webhooks?page={{ page-1 }}&limit={{ limit }}&provider={{ filters.provider }}&event={{ filters.event }}&sort_by={{ sort.by }}&sort_order={{ sort.order }}">←</a>
    {% endif %}
    {% for p in range(1, pages+1) %}
      {% if p == 1 or p == pages or (p >= page-2 and p <= page+2) %}
        <a class="btn {% if p==page %}active{% endif %}" href="/webhooks?page={{ p }}&limit={{ limit }}&provider={{ filters.provider }}&event={{ filters.event }}&sort_by={{ sort.by }}&sort_order={{ sort.order }}">{{ p }}</a>
      {% elif p == page-3 or p == page+3 %}
        <span style="padding:4px 8px; color:#6b7280;">…</span>
      {% endif %}
    {% endfor %}
    {% if page < pages %}
      <a class="btn" href="/webhooks?page={{ page+1 }}&limit={{ limit }}&provider={{ filters.provider }}&event={{ filters.event }}&sort_by={{ sort.by }}&sort_order={{ sort.order }}">→</a>
    {% endif %}
  </div>
</div>
{% endblock %}



# Анализ флоу покупки подписки

## Проблема пользователя 6358556135

**Симптом:** Пользователь купил подписку, но она ему не пришла.

**Причина:** Платеж был оплачен (статус `paid`), подписка была создана, но платеж не был помечен как `completed`. Это происходило из-за того, что подписка была создана через один механизм (например, `wait_for_payment_with_protocol`), но платеж не был обновлен из-за ошибки или исключения.

**Решение:** Добавлена дополнительная проверка в `process_paid_payments_without_keys()`: если подписка уже существует и была создана после оплаты платежа, платеж автоматически помечается как `completed`.

## Флоу покупки подписки (шаг за шагом)

### 1. Создание платежа
**Файл:** `bot/handlers/subscriptions.py:handle_email_for_subscription()`

- Пользователь выбирает тариф подписки
- Вводит email
- Создается платеж через `PaymentService.create_payment()` с:
  - `protocol='v2ray'`
  - `metadata={'key_type': 'subscription'}`
- Пользователю отправляется ссылка на оплату

### 2. Оплата платежа
**Файл:** `payments/services/webhook_service.py:handle_yookassa_webhook()`

- YooKassa отправляет webhook о статусе платежа
- Если статус `succeeded`, вызывается `process_payment_success()`
- Платеж помечается как `paid` в БД

### 3. Обработка оплаченного платежа
**Файлы:**
- `payments/services/payment_service.py:process_paid_payments_without_keys()`
- `bot/services/key_creation.py:wait_for_payment_with_protocol()`
- `bot/services/background_tasks.py:process_pending_paid_payments()`

**Логика обработки:**

1. **Проверка статуса платежа:**
   - Если статус `completed` → пропуск
   - Если статус не `paid` → обновление на `paid`

2. **Определение типа ключа:**
   - Проверка `metadata.get('key_type') == 'subscription'` и `protocol == 'v2ray'`
   - Если это подписка → переход к созданию/продлению подписки

3. **Проверка существующей подписки:**
   - **НОВОЕ:** Если подписка существует и была создана после оплаты → помечаем платеж как `completed` и завершаем
   - Если подписка существует и активна → продлеваем её
   - Если подписки нет → создаем новую

4. **Создание/продление подписки:**
   - Вызов `SubscriptionService.create_subscription()`
   - Создание ключей на всех активных V2Ray серверах
   - Обновление `expires_at` для всех ключей подписки

5. **Отправка уведомления:**
   - Формирование сообщения с ссылкой на подписку
   - Отправка через `safe_send_message()`

6. **Помечание платежа как completed:**
   - Вызов `payment.mark_as_completed()`
   - Сохранение в БД через `payment_repo.update()`

## Исправления

### 1. Дополнительная проверка существующей подписки
**Файл:** `payments/services/payment_service.py:508-531`

Добавлена проверка: если подписка уже существует и была создана после оплаты платежа (с запасом в 1 час), платеж автоматически помечается как `completed`. Это защищает от случаев, когда подписка была создана, но платеж не был обновлен из-за ошибки.

### 2. Исправление для пользователя 6358556135
Платеж `30afd348-000f-5000-b000-1e22ad127913` был помечен как `completed` вручную, так как подписка уже существовала.

## Автотесты

Создан файл `payments/tests/test_subscription_purchase_flow.py` с тестами для:
- Создания платежа для подписки
- Обработки оплаченного платежа и создания подписки
- Продления существующей подписки
- Помечания платежа как completed, если подписка уже существует

## Рекомендации

1. **Мониторинг:** Добавить алерты на платежи со статусом `paid`, которые не были обработаны в течение 1 часа
2. **Логирование:** Улучшить логирование всех шагов обработки платежа подписки
3. **Idempotency:** Убедиться, что все операции идемпотентны (можно безопасно повторять)

## Проверка флоу

### Успешный сценарий:
1. ✅ Пользователь выбирает тариф → платеж создан
2. ✅ Пользователь оплачивает → платеж помечен как `paid`
3. ✅ Фоновая задача обрабатывает → подписка создана/продлена
4. ✅ Платеж помечен как `completed`
5. ✅ Пользователь получает сообщение с ссылкой на подписку

### Защита от ошибок:
1. ✅ Если подписка уже существует → платеж помечается как `completed`
2. ✅ Если создание подписки не удалось → платеж остается `paid` для повторной попытки
3. ✅ Retry механизм при создании подписки (3 попытки с exponential backoff)








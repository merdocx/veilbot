# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ V2Ray API - –ê–≤–≥—É—Å—Ç 2025

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è V2Ray –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–æ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π API, –∫–æ—Ç–æ—Ä–∞—è –≤–∫–ª—é—á–∞–µ—Ç:

### üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- **–¢–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ø–æ—Ä—Ç–∞–º** (100% —Ç–æ—á–Ω–æ—Å—Ç—å)
- **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞ (10001-10020)
- **–°–∏—Å—Ç–µ–º–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray

### üîÑ –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
- `/api/traffic/exact` ‚Üí `/api/traffic/ports/exact`
- `/api/keys/{key_id}/traffic/exact` ‚Üí `/api/keys/{key_id}/traffic/port/exact`
- `/api/keys/{key_id}/traffic/reset` ‚Üí `/api/keys/{key_id}/traffic/port/reset`

## üîß –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤ `vpn_protocols.py`

### 1. **get_traffic_stats()** - –û–±–Ω–æ–≤–ª–µ–Ω
```python
# –ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç: /api/traffic/ports/exact
# Fallback: /api/traffic/exact (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/traffic/ports/exact`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback –∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É API
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è: `port`, `key_name`, `total_ports`, `active_ports`
- –£–ª—É—á—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ —Å —Ç–æ—á–Ω—ã–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –ø–æ—Ä—Ç–æ–≤

### 2. **get_key_traffic_stats()** - –û–±–Ω–æ–≤–ª–µ–Ω
```python
# –ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç: /api/keys/{key_id}/traffic/port/exact
# Fallback: /api/keys/{key_id}/traffic/exact (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/keys/{key_id}/traffic/port/exact`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback –∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É API
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è: `port`, `key_name`
- –£–ª—É—á—à–µ–Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### 3. **reset_key_traffic()** - –û–±–Ω–æ–≤–ª–µ–Ω
```python
# –ù–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç: /api/keys/{key_id}/traffic/port/reset
# Fallback: /api/keys/{key_id}/traffic/reset (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/keys/{key_id}/traffic/port/reset`
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback –∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É API
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

## üÜï –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

### 4. **get_ports_status()** - –ù–æ–≤—ã–π
```python
async def get_ports_status(self) -> Dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/ports
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è—Ö –ø–æ—Ä—Ç–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö/–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤
- –î–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ (10001-10020)

### 5. **reset_all_ports()** - –ù–æ–≤—ã–π
```python
async def reset_all_ports(self) -> bool:
    """–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö)"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/ports/reset
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö –ø–æ—Ä—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö

### 6. **get_ports_validation_status()** - –ù–æ–≤—ã–π
```python
async def get_ports_validation_status(self) -> Dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ—Ä—Ç–æ–≤"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/ports/status
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –ø–æ—Ä—Ç–æ–≤
- –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

### 7. **get_xray_config_status()** - –ù–æ–≤—ã–π
```python
async def get_xray_config_status(self) -> Dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/xray/config-status
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray
- –°—Ç–∞—Ç—É—Å inbounds –∏ –ø–æ—Ä—Ç–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 8. **sync_xray_config()** - –ù–æ–≤—ã–π
```python
async def sync_xray_config(self) -> bool:
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Xray"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/xray/sync-config
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ Xray

### 9. **validate_xray_sync()** - –ù–æ–≤—ã–π
```python
async def validate_xray_sync(self) -> Dict:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Xray —Å –∫–ª—é—á–∞–º–∏"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/xray/validate-sync
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–µ–π –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –í—ã—è–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π

### 10. **get_system_traffic_summary()** - –ù–æ–≤—ã–π
```python
async def get_system_traffic_summary(self) -> Dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é —Å–≤–æ–¥–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞"""
    # –≠–Ω–¥–ø–æ–∏–Ω—Ç: /api/system/traffic/summary
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º

## üîÑ Fallback –º–µ—Ö–∞–Ω–∏–∑–º

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:
1. **–ü–æ–ø—ã—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ API** - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥
2. **Fallback –∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É API** - –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–∏–º–µ—Ä fallback:
```python
# –ü–æ–ø—ã—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ API
response = await session.get(f"{self.api_url}/traffic/ports/exact")

if response.status != 200:
    # Fallback –∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–º—É API
    logger.warning("New traffic API failed, trying legacy endpoint")
    return await self._get_legacy_traffic_stats()
```

## üìä –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤

### –¢–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ä—Ç–æ–≤:
```json
{
  "ports_traffic": {
    "total_ports": 2,
    "ports_traffic": {
      "uuid": {
        "port": 10001,
        "key_name": "–ú–æ–π VPN –∫–ª—é—á",
        "traffic": {
          "port": 10001,
          "connections": 2,
          "total_bytes": 1048576,
          "total_formatted": "1.0 MB",
          "rx_bytes": 524288,
          "tx_bytes": 524288,
          "rx_formatted": "512.0 KB",
          "tx_formatted": "512.0 KB",
          "timestamp": 1234567890
        }
      }
    },
    "total_traffic": 1048576,
    "total_connections": 2,
    "total_traffic_formatted": "1.0 MB"
  },
  "system_summary": {
    "total_system_traffic": 10485760,
    "total_system_traffic_formatted": "10.0 MB",
    "active_ports": 2
  }
}
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å:
- **100% —Ç–æ—á–Ω–æ—Å—Ç—å** –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
- **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞
- **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è** —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø–æ—Ä—Ç–∞–º–∏
- **–ü—Ä–æ—Å—Ç–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –ø—Ä–æ–±–ª–µ–º
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –¥–æ 20 –∫–ª—é—á–µ–π

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **–¢–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —Ç—Ä–∞—Ñ–∏–∫–∞ –ø–æ –ø–æ—Ä—Ç–∞–º
- **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞
- **–°–∏—Å—Ç–µ–º–Ω–∞—è —Å–≤–æ–¥–∫–∞** —Ç—Ä–∞—Ñ–∏–∫–∞

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞:
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- Fallback –∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ç–µ–∫—É—â–∏–º –∫–æ–¥–æ–º

### üÜï –î–æ–±–∞–≤–ª–µ–Ω–æ:
- –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```python
# –ù–æ–≤—ã–π –º–µ—Ç–æ–¥
stats = await v2ray_protocol.get_traffic_stats()

# –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∫–ª—é—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Ä—Ç–∞—Ö
for stat in stats:
    print(f"Port: {stat['port']}")
    print(f"Key: {stat['key_name']}")
    print(f"Traffic: {stat['total_formatted']}")
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞–º–∏:
```python
# –°—Ç–∞—Ç—É—Å –ø–æ—Ä—Ç–æ–≤
ports_status = await v2ray_protocol.get_ports_status()
print(f"Used ports: {ports_status['used_ports']}")
print(f"Available ports: {ports_status['available_ports']}")

# –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
xray_status = await v2ray_protocol.get_xray_config_status()
print(f"Config valid: {xray_status['config_status']['config_valid']}")
```

## üöÄ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ V2Ray API –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

1. **–ü–æ–≤—ã—à–µ–Ω–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å** –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
2. **–õ—É—á—à–µ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø–æ—Ä—Ç–∞–º–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
3. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏** –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
4. **–ü–æ–ª–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 4 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–í–µ—Ä—Å–∏—è API:** 1.0.0 (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ—Ä—Ç–∞–º–∏) 
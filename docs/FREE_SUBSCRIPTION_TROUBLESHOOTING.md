# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å –≤—ã–¥–∞—á–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ /start

## –û–±–∑–æ—Ä

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/start` –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é V2Ray –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `issue_free_v2ray_subscription_on_start`. –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –≤—ã–¥–∞–ª–∞—Å—å, –≤–æ–∑–º–æ–∂–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∏—á–∏–Ω—ã.

## –õ–æ–≥–∏–∫–∞ –≤—ã–¥–∞—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

–ü—É—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
1. `bot/handlers/start.py` ‚Üí `handle_start()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `issue_free_v2ray_key_on_start()`
2. `bot/services/free_tariff.py` ‚Üí `issue_free_v2ray_subscription_on_start()`
3. `bot/services/subscription_service.py` ‚Üí `create_subscription()`

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞

### 1. –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ —É–∂–µ –∏—Å—á–µ—Ä–ø–∞–Ω ‚ö†Ô∏è

**–°—Ç–∞—Ç—É—Å**: `already_issued`

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: –§—É–Ω–∫—Ü–∏—è `check_free_tariff_limit_by_protocol_and_country()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True`

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø–æ–ª—É—á–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Ä–∞–Ω–µ–µ
- –í —Ç–∞–±–ª–∏—Ü–µ `free_key_usage` –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í —Ç–∞–±–ª–∏—Ü–∞—Ö `keys` –∏–ª–∏ `v2ray_keys` –µ—Å—Ç—å –∫–ª—é—á–∏ —Å —Ç–∞—Ä–∏—Ñ–æ–º, –≥–¥–µ `price_rub = 0`

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏**:
```python
# bot/services/free_tariff.py:373-380
if check_free_tariff_limit_by_protocol_and_country(
    cursor,
    user_id,
    protocol="v2ray",
    country=FREE_V2RAY_COUNTRY,
    enforce_global=True,  # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞
):
    return {"status": "already_issued"}
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:
```
–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
```sql
SELECT * FROM free_key_usage WHERE user_id = ?;
SELECT k.*, t.price_rub 
FROM v2ray_keys k 
JOIN tariffs t ON k.tariff_id = t.id 
WHERE k.user_id = ? AND t.price_rub = 0;
```

**–†–µ—à–µ–Ω–∏–µ**: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –≤—ã–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.

---

### 2. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ ‚ùå

**–°—Ç–∞—Ç—É—Å**: `tariff_missing`

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –¢–∞—Ä–∏—Ñ —Å ID –∏–∑ `FREE_V2RAY_TARIFF_ID` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `2`) –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ `tariffs`
- –¢–∞—Ä–∏—Ñ —É–¥–∞–ª–µ–Ω –∏–ª–∏ ID –∏–∑–º–µ–Ω–µ–Ω

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏**:
```python
# bot/services/free_tariff.py:382-393
cursor.execute(
    "SELECT id, name, duration_sec, traffic_limit_mb, price_rub "
    "FROM tariffs WHERE id = ?",
    (FREE_V2RAY_TARIFF_ID,),
)
row = cursor.fetchone()
if not row:
    logging.error("Tariff with id %s not found for free issuance", FREE_V2RAY_TARIFF_ID)
    return {
        "status": "tariff_missing",
        "message": "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.",
    }
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:
```
–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
```sql
SELECT * FROM tariffs WHERE id = 2;  -- –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ FREE_V2RAY_TARIFF_ID
```

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –≤ –±–∞–∑–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `FREE_V2RAY_TARIFF_ID` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. –°–æ–∑–¥–∞—Ç—å/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞—Ä–∏—Ñ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç

---

### 3. –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö V2Ray —Å–µ—Ä–≤–µ—Ä–æ–≤ ‚ùå

**–°—Ç–∞—Ç—É—Å**: `no_server`

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –í —Ç–∞–±–ª–∏—Ü–µ `servers` –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å `protocol = 'v2ray'` –∏ `active = 1`
- –í—Å–µ V2Ray —Å–µ—Ä–≤–µ—Ä—ã –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏**:
```python
# bot/services/free_tariff.py:403-410
cursor.execute(
    "SELECT COUNT(*) FROM servers WHERE protocol = 'v2ray' AND active = 1"
)
server_count = cursor.fetchone()[0]
if server_count == 0:
    logging.warning("No active V2Ray servers available for free subscription issuance")
    return {"status": "no_server"}
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:
```
–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
```sql
SELECT id, name, country, active, protocol 
FROM servers 
WHERE protocol = 'v2ray' AND active = 1;
```

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏ —Å—Ç–∞—Ç—É—Å V2Ray —Å–µ—Ä–≤–µ—Ä–æ–≤
2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω V2Ray —Å–µ—Ä–≤–µ—Ä (`UPDATE servers SET active = 1 WHERE id = ?`)

---

### 4. –û—à–∏–±–∫–∞ –≤ SubscriptionService.create_subscription() ‚ùå

**–°—Ç–∞—Ç—É—Å**: `error`

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –í–Ω—É—Ç—Ä–∏ `create_subscription()` –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –≤ `create_subscription()` –≤–µ—Ä–Ω—É–ª–∞ `True` (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
- –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î
- –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö
- –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å

**–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏**:
```python
# bot/services/subscription_service.py:558-582
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ (–¥—É–±–ª–∏–∫–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑ free_tariff.py)
is_free_tariff = False
cursor.execute("SELECT price_rub FROM tariffs WHERE id = ?", (tariff_id,))
tariff_row = cursor.fetchone()
if tariff_row and tariff_row[0] == 0:
    is_free_tariff = True
    if check_free_tariff_limit_by_protocol_and_country(...):
        logger.warning(f"User {user_id} attempted to create duplicate free subscription")
        return None  # –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –Ω–µ —Å–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º!
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:
```
–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
- –ò—Å–∫–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: `Failed to create free V2Ray subscription for user`
- –ò—Å–∫–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: `Failed to create subscription for user`

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–¥–∞—á—É
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º V2Ray
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

---

### 5. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚ùå

**–°—Ç–∞—Ç—É—Å**: `error`

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –õ—é–±–æ–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ `issue_free_v2ray_subscription_on_start()`
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `{"status": "error"}`

**–ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏**:
```python
# bot/services/free_tariff.py:460-462
except Exception as exc:
    logging.exception("Failed to create free V2Ray subscription for user %s: %s", user_id, exc)
    return {"status": "error"}
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:
```
–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø¬ª –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
```

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –ò—Å–∫–∞—Ç—å `Failed to auto-issue free V2Ray subscription`

**–†–µ—à–µ–Ω–∏–µ**:
1. –ò–∑—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π traceback –≤ –ª–æ–≥–∞—Ö
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã

---

### 6. –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç üîÑ

**–°—Ç–∞—Ç—É—Å**: –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ—á–µ–≤–∏–¥–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `create_subscription()` –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π
- –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –Ω–µ –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**–ö–æ–¥**:
```python
# bot/services/subscription_service.py:584-786
existing = await self.repository.get_active_subscription_async(user_id)
if existing:
    # –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É
    new_expires_at = existing_expires_at + duration_sec
    await self.repository.extend_subscription_async(existing_id, new_expires_at)
    # ...
```

**–ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:
- –ú–æ–∂–µ—Ç –Ω–µ –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—ã–¥–∞—á–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –°—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–º

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å**:
```sql
SELECT * FROM subscriptions 
WHERE user_id = ? AND is_active = 1 
ORDER BY created_at DESC;
```

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

–î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```bash
python3 scripts/diagnose_free_subscription.py <user_id>
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
2. –ù–∞–ª–∏—á–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –≤ –±–∞–∑–µ
3. –ù–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö V2Ray —Å–µ—Ä–≤–µ—Ä–æ–≤
4. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. –ö–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
6. –†–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞

## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –≤—ã–¥–∞–ª–∞—Å—å –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `scripts/diagnose_free_subscription.py <user_id>`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –æ—à–∏–±–∫–∏
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–∞—Ä–∏—Ñ ID=2 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ `price_rub = 0`
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ V2Ray —Å–µ—Ä–≤–µ—Ä—ã

**–†–µ—à–µ–Ω–∏–µ**:
- –ï—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω, —Ç–∞—Ä–∏—Ñ –µ—Å—Ç—å, —Å–µ—Ä–≤–µ—Ä—ã –µ—Å—Ç—å - –ø—Ä–æ–±–ª–µ–º–∞ –≤ `create_subscription()` –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–µ–π
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞

**–û–ø–∏—Å–∞–Ω–∏–µ**: 
–í `issue_free_v2ray_subscription_on_start()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ª–∏–º–∏—Ç, –∑–∞—Ç–µ–º –≤ `create_subscription()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–Ω–æ–≤–∞. –ï—Å–ª–∏ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–∞ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ: `User {user_id} attempted to create duplicate free subscription`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–ø–∏—Å—å –≤ `free_key_usage` —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ**: 
–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î, –Ω–æ –∫–ª—é—á–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ API.

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```sql
-- –ü–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å, –Ω–æ –∫–ª—é—á–µ–π –Ω–µ—Ç
SELECT s.* FROM subscriptions s
LEFT JOIN v2ray_keys k ON s.id = k.subscription_id
WHERE s.user_id = ? AND k.id IS NULL;
```

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —Å–µ—Ä–≤–µ—Ä–æ–≤ V2Ray
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π
- –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–æ–∫: `sync_subscription_keys_with_active_servers()`

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É

1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –ø–æ–ª–Ω—ã–º traceback
2. **–ú–µ—Ç—Ä–∏–∫–∏**: –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–¥–∞—á
3. **–ê–ª–µ—Ä—Ç—ã**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –≤ –±–∞–∑–µ

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `bot/handlers/start.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
- `bot/services/free_tariff.py` - –ª–æ–≥–∏–∫–∞ –≤—ã–¥–∞—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
- `bot/services/subscription_service.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- `scripts/diagnose_free_subscription.py` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
- `scripts/get_user_info.py` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ


# Техническое задание: Оптимизация функции "Синхронизировать ключи"

## Цель
Оптимизировать функцию синхронизации ключей, упростив логику и обеспечив выполнение всех требований к состоянию ключей в системе.

## Требования к результату синхронизации

### 1. Удаление ключей для недоступных серверов
**Условие**: Сервер считается недоступным, если выполняется одно из условий:
- `active = 0` в таблице `servers`
- Сервер удален из таблицы `servers` (не существует в БД)
- Сервер недоступен по API (не отвечает на запросы в течение таймаута)

**Важно**: Серверы с `active = 1 AND available_for_purchase = 0` **НЕ** считаются недоступными. Ключи с таких серверов **НЕ** удаляются.

**Действие**: 
- Удалить из БД все ключи (`v2ray_keys` и `keys`), связанные с недоступными серверами
- **НЕ** удалять ключи с серверов (они могут быть восстановлены при повторной активации сервера)

### 2. Удаление лишних ключей с серверов
**Условие**: На сервере есть ключ, которого нет в БД

**Действие**:
- Удалить такой ключ с сервера через API
- Применяется как для V2Ray, так и для Outline серверов

### 3. Обеспечение наличия ключей для подписок

#### 3.1. V2Ray ключи
**Требование**: У каждой активной подписки (`is_active = 1 AND expires_at > NOW()`) должен быть ключ на каждом V2Ray сервере, который:
- `active = 1`
- `available_for_purchase = 1`
- `protocol = 'v2ray'`

**Важно**: На серверах с `active = 1 AND available_for_purchase = 0` новые ключи **НЕ** создаются, но существующие ключи синхронизируются (обновление конфигураций).

**Действие**:
- Для каждой пары (подписка, доступный V2Ray сервер с `available_for_purchase = 1`):
  - Проверить наличие ключа в БД (`v2ray_keys` с `subscription_id` и `server_id`)
  - Если ключа нет в БД:
    - Создать ключ на сервере через API
    - Сохранить ключ в БД с актуальной `client_config`
  - Если ключ есть в БД, но отсутствует на сервере:
    - Удалить ключ из БД
    - Создать новый ключ на сервере
    - Сохранить в БД

#### 3.2. Outline ключи
**Требование**: У каждой активной подписки должен быть ровно 1 Outline ключ на сервере с `id = 8` (если такой сервер существует и активен).

**Действие**:
- Для каждой активной подписки:
  - Проверить наличие Outline ключа в БД (`keys` с `subscription_id` и `server_id = 8`)
  - Если ключа нет:
    - Создать ключ на сервере №8 через API
    - Сохранить ключ в БД
  - Если ключ есть, но отсутствует на сервере:
    - Удалить ключ из БД
    - Создать новый ключ на сервере
    - Сохранить в БД
  - Если у подписки есть Outline ключи на других серверах (не №8):
    - Удалить такие ключи с серверов
    - Удалить записи из БД

### 4. Синхронизация конфигураций ключей

#### 4.1. Синхронизация V2Ray конфигураций (VLESS ссылки)
**Требование**: VLESS ссылка (`client_config` в БД) должна всегда совпадать с актуальной ссылкой, полученной с сервера.

**Область применения**: Все активные V2Ray серверы (`active = 1`), независимо от `available_for_purchase`.

**Действие**:
- Для каждого V2Ray ключа в БД на активном сервере (`active = 1`):
  - Получить актуальную конфигурацию с сервера через `get_user_config`
  - Извлечь VLESS URL из ответа (строка, начинающаяся с `vless://`)
  - Нормализовать ссылку через `normalize_vless_host`
  - Удалить фрагмент (email) через `remove_fragment_from_vless`
  - Если полученная ссылка отличается от `client_config` в БД:
    - Обновить `client_config` в БД
    - Инвалидировать кэш подписки (`invalidate_subscription_cache`)

#### 4.2. Синхронизация Outline конфигураций (access_url)
**Требование**: Access URL (`access_url` в БД) должен всегда совпадать с актуальным URL, полученным с сервера.

**Область применения**: Все активные Outline серверы (`active = 1`), независимо от `available_for_purchase`.

**Действие**:
- Для каждого Outline ключа в БД на активном сервере (`active = 1`):
  - Получить актуальную конфигурацию с сервера через `get_user_config` или `get_access_url`
  - Если полученный URL отличается от `access_url` в БД:
    - Обновить `access_url` в БД
    - Инвалидировать кэш подписки (если ключ связан с подпиской)

## Алгоритм синхронизации

### Этап 1: Подготовка данных
1. Получить список всех серверов из БД
2. Получить список всех активных подписок (`is_active = 1 AND expires_at > NOW()`)
3. Получить список всех ключей из БД (V2Ray и Outline)

### Этап 2: Удаление ключей для недоступных серверов
1. Для каждого сервера с `active = 0` или отсутствующего в БД:
   - Найти все ключи в БД с `server_id = <id_сервера>`
   - Удалить найденные ключи из БД (с отключением foreign keys)
   - Логировать количество удаленных ключей

**Важно**: Серверы с `active = 1 AND available_for_purchase = 0` обрабатываются на этапах синхронизации конфигураций, но ключи с них не удаляются.

### Этап 3: Синхронизация V2Ray ключей

#### 3.1. Получение списка активных V2Ray серверов
- Фильтр: `protocol = 'v2ray' AND active = 1`
- Разделить на две группы:
  - **Доступные к покупке**: `available_for_purchase = 1` (для создания новых ключей)
  - **Недоступные к покупке**: `available_for_purchase = 0` (только синхронизация конфигураций)

#### 3.2. Проверка доступности серверов
- Для каждого активного V2Ray сервера попытаться подключиться к API (таймаут 10 секунд)
- Если сервер недоступен:
  - Пометить сервер как недоступный
  - Удалить все ключи этого сервера из БД
  - Пропустить сервер на всех последующих этапах

#### 3.3. Создание недостающих ключей (только для серверов с `available_for_purchase = 1`)
- Для каждой пары (подписка, доступный V2Ray сервер с `available_for_purchase = 1`):
  - Проверить наличие ключа в БД
  - Если ключа нет:
    - Создать ключ на сервере через `create_user`
    - Получить `client_config` через `get_user_config`
    - Сохранить ключ в БД
  - Если ключ есть в БД, но отсутствует на сервере:
    - Удалить ключ из БД
    - Создать новый ключ на сервере
    - Сохранить в БД

#### 3.4. Удаление лишних ключей с серверов
- Для каждого активного V2Ray сервера (независимо от `available_for_purchase`):
  - Получить список всех ключей с сервера через `get_all_keys`
  - Для каждого ключа с сервера:
    - Проверить наличие в БД по UUID
    - Если ключа нет в БД:
      - Удалить ключ с сервера через `delete_user`
      - Логировать удаление

#### 3.5. Синхронизация VLESS ссылок (для всех активных серверов)
- Для каждого V2Ray ключа в БД на активном сервере (`active = 1`):
  - Получить актуальную конфигурацию с сервера
  - Сравнить с `client_config` в БД
  - Если отличается - обновить в БД

### Этап 4: Синхронизация Outline ключей

#### 4.1. Получение списка активных Outline серверов
- Фильтр: `protocol = 'outline' AND active = 1`
- Разделить на две группы:
  - **Сервер №8**: для создания ключей подписок (если `available_for_purchase = 1`)
  - **Остальные серверы**: только синхронизация конфигураций

#### 4.2. Проверка доступности серверов
- Для каждого активного Outline сервера попытаться подключиться к API (таймаут 10 секунд)
- Если сервер недоступен:
  - Пометить сервер как недоступный
  - Удалить все ключи этого сервера из БД
  - Пропустить сервер на всех последующих этапах

#### 4.3. Создание недостающих Outline ключей (только для сервера №8 с `available_for_purchase = 1`)
- Проверить существование сервера с `id = 8`, `protocol = 'outline'`, `active = 1`, `available_for_purchase = 1`
- Если сервер существует и доступен:
  - Для каждой активной подписки:
    - Проверить наличие Outline ключа на сервере №8 в БД
    - Если ключа нет:
      - Создать ключ на сервере через `create_user`
      - Получить `access_url` через API
      - Сохранить ключ в БД
    - Если ключ есть в БД, но отсутствует на сервере:
      - Удалить ключ из БД
      - Создать новый ключ на сервере
      - Сохранить в БД

#### 4.4. Удаление лишних Outline ключей
- Удалить Outline ключи подписок на серверах, отличных от №8 (если такие есть)
- Для каждого активного Outline сервера:
  - Получить список всех ключей с сервера через `get_all_keys`
  - Для каждого ключа с сервера:
    - Проверить наличие в БД по `key_id` или `email`
    - Если ключа нет в БД:
      - Удалить ключ с сервера через `delete_user`
      - Логировать удаление

#### 4.5. Синхронизация Outline конфигураций (для всех активных серверов)
- Для каждого Outline ключа в БД на активном сервере (`active = 1`):
  - Получить актуальный `access_url` с сервера
  - Сравнить с `access_url` в БД
  - Если отличается - обновить в БД
  - Если ключ связан с подпиской - инвалидировать кэш подписки

## Оптимизации производительности

### Параллельная обработка
- Обработка серверов параллельно (до 5 серверов одновременно)
- Обработка ключей одного сервера параллельно (до 10 ключей одновременно)
- Использование `asyncio.Semaphore` для ограничения параллелизма

### Батчинг операций БД
- Группировка обновлений `client_config` в батчи (до 50 записей)
- Использование `executemany` для массовых обновлений
- Группировка инвалидации кэша подписок (собрать все токены, затем инвалидировать)

### Таймауты
- Таймаут подключения к серверу: 10 секунд
- Таймаут получения конфигурации ключа: 30 секунд
- Общий таймаут синхронизации: 10 минут (на уровне вызова функции)

### Кэширование
- Кэшировать список доступных серверов на время синхронизации
- Кэшировать список активных подписок на время синхронизации
- Кэшировать токены подписок для инвалидации кэша

## Обработка ошибок

### Недоступные серверы
- Логировать предупреждение
- Удалять ключи из БД
- Продолжать обработку других серверов

### Ошибки создания ключей
- Логировать ошибку с деталями (подписка, сервер)
- Продолжать обработку других ключей
- Увеличить счетчик ошибок в статистике

### Ошибки обновления конфигураций
- Логировать предупреждение
- Продолжать обработку других ключей
- Не блокировать синхронизацию

### Таймауты
- Логировать предупреждение
- Пометить ключ/сервер как проблемный
- Продолжать обработку

## Статистика выполнения

Функция должна возвращать словарь со следующей статистикой:

```python
{
    "servers_processed": int,           # Количество обработанных серверов
    "servers_unavailable": int,         # Количество недоступных серверов
    "keys_deleted_from_db": int,        # Количество ключей, удаленных из БД
    "keys_deleted_from_servers": int,   # Количество ключей, удаленных с серверов
    "v2ray_keys_created": int,          # Количество созданных V2Ray ключей
    "v2ray_configs_updated": int,        # Количество обновленных V2Ray конфигураций (VLESS ссылок)
    "outline_keys_created": int,         # Количество созданных Outline ключей
    "outline_configs_updated": int,       # Количество обновленных Outline конфигураций (access_url)
    "outline_keys_removed": int,         # Количество удаленных Outline ключей (не с сервера №8)
    "errors": int,                       # Общее количество ошибок
    "errors_details": List[Dict],        # Детали ошибок (до 50 записей)
    "duration_seconds": float,          # Время выполнения в секундах
}
```

## Логирование

### Уровни логирования
- **INFO**: Основные этапы синхронизации, статистика
- **WARNING**: Недоступные серверы, таймауты, пропущенные ключи
- **ERROR**: Ошибки создания/удаления ключей, ошибки API

### Формат логов
```
[INFO] Начало синхронизации ключей
[INFO] Обработка V2Ray сервера #1: Server Name (доступен к покупке)
[INFO]   Создано ключей: 5
[INFO]   Обновлено конфигураций: 10
[INFO] Обработка V2Ray сервера #2: Server Name 2 (недоступен к покупке)
[INFO]   Обновлено конфигураций: 3 (новые ключи не создаются)
[INFO] Обработка Outline сервера #8: Outline Server
[INFO]   Создано ключей: 2
[INFO]   Обновлено конфигураций: 5
[WARNING] Сервер #3 недоступен, удалено ключей из БД: 3
[ERROR] Ошибка создания ключа для подписки #123 на сервере #1: <детали>
[INFO] Итого: создано 7, обновлено конфигураций 18, ошибок 1
```

## Интеграция с админ-панелью

### API endpoint
- **Метод**: POST
- **Путь**: `/admin/subscriptions/sync-keys`
- **Таймаут**: 10 минут
- **Ответ**: JSON со статистикой синхронизации

### UI
- Кнопка "Синхронизировать ключи" должна:
  - Показывать индикатор загрузки во время выполнения
  - Отображать прогресс (если возможно)
  - Показывать результат после завершения (статистика)
  - Обрабатывать таймауты и ошибки

## Тестирование

### Тестовые сценарии
1. Синхронизация с полностью синхронизированной системой (без изменений)
2. Синхронизация с недоступным сервером
3. Синхронизация с лишними ключами на серверах
4. Синхронизация с отсутствующими ключами для подписок
5. Синхронизация с устаревшими VLESS ссылками
6. Синхронизация с неактивным сервером №8 (Outline)
7. Синхронизация с таймаутами на серверах

## Примечания

1. Функция должна быть идемпотентной: повторный запуск с теми же данными не должен изменять состояние системы
2. Функция должна быть безопасной: не должна удалять ключи без необходимости
3. Функция должна быть отказоустойчивой: ошибки на одном сервере не должны блокировать обработку других
4. Функция должна быть эффективной: минимизировать количество запросов к API и БД


# Исправления процесса покупки и продления подписок

Дата: 2026-01-19

## Выполненные исправления

### 1. Обновление tariff_id в _get_or_create_subscription()

**Проблема:**
При использовании существующей подписки обновлялся только traffic_limit_mb, но не tariff_id.

**Исправление:**
Добавлено обновление tariff_id при использовании существующей подписки.

**Файл:** payments/services/subscription_purchase_service.py, строка 2070-2075

### 2. Обновление traffic_limit_mb в _recalculate_and_update_subscription_expires_at()

**Проблема:**
Метод обновлял expires_at и tariff_id, но не обновлял traffic_limit_mb.

**Исправление:**
Добавлено обновление traffic_limit_mb через безопасный метод.

**Файл:** payments/services/subscription_purchase_service.py, строка 2601-2642

## Проверка всех требований

### 1. Тариф всегда верно устанавливается
- При создании новой подписки: tariff_id устанавливается из тарифа
- При продлении подписки: tariff_id обновляется из тарифа
- При использовании существующей подписки: tariff_id обновляется из тарифа
- При неизменном expires_at: tariff_id обновляется из тарифа

### 2. Срок всегда верно устанавливается
- При создании новой подписки: expires_at рассчитывается из тарифа
- При продлении подписки: expires_at увеличивается на длительность тарифа
- При пересчете: expires_at пересчитывается на основе всех платежей

### 3. Лимит трафика всегда верно устанавливается
- При создании новой подписки: traffic_limit_mb устанавливается из тарифа
- При продлении подписки: traffic_limit_mb обновляется безопасно (сохраняет реферальный бонус)
- При использовании существующей подписки: traffic_limit_mb обновляется безопасно

### 4. К платежу всегда приписывается номер подписки
- В process_subscription_purchase(): обновление на строке 350
- В _create_subscription(): обновление на строках 1463, 1483
- В _create_subscription_as_renewal(): обновление на строке 586

## Итоговый статус

Все требования выполнены:
1. Тариф всегда верно устанавливается
2. Срок всегда верно устанавливается
3. Лимит трафика всегда верно устанавливается
4. К платежу всегда приписывается номер подписки

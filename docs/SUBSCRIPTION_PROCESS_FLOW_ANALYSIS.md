# –ê–ù–ê–õ–ò–ó –ü–†–û–¶–ï–°–°–ê –ü–û–ö–£–ü–ö–ò –ò –ü–†–û–î–õ–ï–ù–ò–Ø –ü–û–î–ü–ò–°–û–ö
## –í—ã—è–≤–ª–µ–Ω–∏–µ —É–∑–∫–∏—Ö –º–µ—Å—Ç –¥–ª—è –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è

---

## üìã –û–ë–©–ò–ô FLOW –û–ë–†–ê–ë–û–¢–ö–ò –ü–õ–ê–¢–ï–ñ–ê –ó–ê –ü–û–î–ü–ò–°–ö–£

### 1. –°–û–ó–î–ê–ù–ò–ï –ü–õ–ê–¢–ï–ñ–ê (–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)

**–ú–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:**
- `bot/handlers/subscriptions.py` ‚Üí `handle_buy_subscription()` ‚Üí `wait_for_payment_with_protocol()`
- `payments/services/payment_service.py` ‚Üí `create_payment()`
- `payments/adapters/legacy_adapter.py` ‚Üí `create_payment_legacy()`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –ø–æ–¥–ø–∏—Å–∫–∏
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
3. Metadata —Å–æ–¥–µ—Ä–∂–∏—Ç: `{'key_type': 'subscription'}`
4. Protocol: `'v2ray'`
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É

**–°—Ç–∞—Ç—É—Å:** `PENDING` ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã

---

### 2. –û–ë–†–ê–ë–û–¢–ö–ê –û–ü–õ–ê–ß–ï–ù–ù–û–ì–û –ü–õ–ê–¢–ï–ñ–ê (4 –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–´–• –ü–£–¢–ò!)

#### üîµ –ü–£–¢–¨ #1: Webhook –æ—Ç YooKassa (`/yookassa/webhook`)

**–§–∞–π–ª:** `admin/routes/webhooks.py` ‚Üí `yookassa_webhook()`

**Flow:**
```
1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Üí admin/routes/webhooks.py:yookassa_webhook()
2. ‚Üí payments/services/webhook_service.py:handle_yookassa_webhook()
3. ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (PENDING ‚Üí PAID, –∞—Ç–æ–º–∞—Ä–Ω–æ —á–µ—Ä–µ–∑ try_update_status)
4. ‚Üí payment_service.process_payment_success() ‚Üí —Å—Ç–∞—Ç—É—Å PENDING ‚Üí PAID
5. ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ metadata['key_type'] == 'subscription' –ò protocol == 'v2ray'
6. ‚Üí subscription_service.process_subscription_purchase(payment_id) ‚ö†Ô∏è
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #1:** 
- –í —Å—Ç—Ä–æ–∫–µ 91-100 `webhook_service.py` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å `COMPLETED`, –Ω–æ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –≤—ã–∑–æ–≤–æ–º `process_subscription_purchase` –º–æ–∂–µ—Ç –±—ã—Ç—å race condition
- –ï—Å–ª–∏ webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–≤–∞–∂–¥—ã (YooKassa –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã), –≤—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏

---

#### üü¢ –ü–£–¢–¨ #2: Webhook –æ—Ç Platega (`/platega/webhook`)

**–§–∞–π–ª:** `admin/routes/webhooks.py` ‚Üí `platega_webhook()`

**Flow:**
```
1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Üí admin/routes/webhooks.py:platega_webhook()
2. ‚Üí payments/services/webhook_service.py:handle_platega_webhook()
3. ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (PENDING ‚Üí PAID, –∞—Ç–æ–º–∞—Ä–Ω–æ —á–µ—Ä–µ–∑ try_update_status)
4. ‚Üí payment_service.process_payment_success() ‚Üí —Å—Ç–∞—Ç—É—Å PENDING ‚Üí PAID
5. ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ metadata['key_type'] == 'subscription' –ò protocol == 'v2ray'
6. ‚Üí subscription_service.process_subscription_purchase(tx_id) ‚ö†Ô∏è
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #2:**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ YooKassa, –Ω–æ –≤ —Å—Ç—Ä–æ–∫–µ 259 `webhook_service.py` –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `COMPLETED` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º!
- –ï—Å–ª–∏ webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ, `process_subscription_purchase` –≤—ã–∑–æ–≤–µ—Ç—Å—è —Å–Ω–æ–≤–∞

---

#### üü° –ü–£–¢–¨ #3: Polling –≤ `wait_for_payment_with_protocol()`

**–§–∞–π–ª:** `bot/services/key_creation.py` ‚Üí `wait_for_payment_with_protocol()`

**Flow:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª /buy_subscription
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ asyncio.create_task(wait_for_payment_with_protocol(...))
3. –í —Ü–∏–∫–ª–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑:
   - payment_service.wait_for_payment() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ YooKassa/Platega
   - –ò–õ–ò payment_service.process_payment_success()
4. –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –æ–ø–ª–∞—á–µ–Ω (status = 'paid'):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ metadata['key_type'] == 'subscription' –ò protocol == 'v2ray'
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î: –µ—Å–ª–∏ status = 'completed' ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
   - –ò–ù–ê–ß–ï ‚Üí subscription_service.process_subscription_purchase(payment_id) ‚ö†Ô∏è
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #3:**
- –í —Å—Ç—Ä–æ–∫–µ 1488 `key_creation.py` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å `completed`, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞!
- –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ –∏ –≤—ã–∑–æ–≤–æ–º `process_subscription_purchase` –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏:
  - Webhook –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø–ª–∞—Ç–µ–∂ ‚Üí —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–ª `completed`
  - Polling —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª —Å—Ç–∞—Ç—É—Å (–µ—â–µ `paid`) ‚Üí –∑–∞–ø—É—Å—Ç–∏–ª `process_subscription_purchase`
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞!

---

#### üî¥ –ü–£–¢–¨ #4: –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `process_pending_paid_payments()`

**–§–∞–π–ª:** `bot/services/background_tasks.py` ‚Üí `process_pending_paid_payments()`

**Flow:**
```
1. –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
2. –ò—â–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'paid', –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ metadata['key_type'] == 'subscription' –ò protocol == 'v2ray'
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: –µ—Å–ª–∏ status = 'completed' ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (—Å—Ç—Ä–æ–∫–∞ 345)
   - –ò–ù–ê–ß–ï ‚Üí subscription_service.process_subscription_purchase(payment_uuid) ‚ö†Ô∏è
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #4:**
- –í —Å—Ç—Ä–æ–∫–µ 345 `background_tasks.py` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å `completed`, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞!
- Race condition:
  - Webhook –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø–ª–∞—Ç–µ–∂ ‚Üí —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–ª `completed` (–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞)
  - –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É ‚Üí —Å—á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `paid`
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞!

---

#### üü† –ü–£–¢–¨ #5: –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `retry_failed_subscription_notifications()`

**–§–∞–π–ª:** `bot/services/background_tasks.py` ‚Üí `retry_failed_subscription_notifications()`

**Flow:**
```
1. –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
2. –ò—â–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'paid' (–ù–ï 'completed') –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: –µ—Å–ª–∏ status != 'paid' ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (—Å—Ç—Ä–æ–∫–∞ 1334)
   - subscription_service.process_subscription_purchase(payment.payment_id) ‚ö†Ô∏è
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #5:**
- –í —Å—Ç—Ä–æ–∫–µ 1334 `background_tasks.py` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å, –Ω–æ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–æ!
- –ï—Å–ª–∏ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –≤—ã–∑–æ–≤–æ–º `process_subscription_purchase` –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–º–µ—Ç–∏–ª –ø–ª–∞—Ç–µ–∂ –∫–∞–∫ `completed`, –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –¥–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

---

### 3. –û–ë–†–ê–ë–û–¢–ö–ê –í `process_subscription_purchase()`

**–§–∞–π–ª:** `payments/services/subscription_purchase_service.py` ‚Üí `process_subscription_purchase()`

**Flow:**
```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:
   - –ï—Å–ª–∏ status == COMPLETED ‚Üí –≤–æ–∑–≤—Ä–∞—Ç (skip) ‚úÖ –ó–∞—â–∏—Ç–∞ –µ—Å—Ç—å
   - –ï—Å–ª–∏ status != PAID ‚Üí –æ—à–∏–±–∫–∞
   
2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –∏–∑ –ë–î

3. ‚ö†Ô∏è –ü–û–í–¢–û–†–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê (—Å—Ç—Ä–æ–∫–∞ 108-111):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ race condition
   - –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞! –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å

4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ø–æ–∫—É–ø–∫–∞ –ò–õ–ò –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ —Å grace_period (24 —á–∞—Å–∞)
   - –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å ‚Üí –ü–†–û–î–õ–ï–ù–ò–ï
   - –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Üí –ü–û–ö–£–ü–ö–ê

5. –ï—Å–ª–∏ –ü–†–û–î–õ–ï–ù–ò–ï:
   - –í—ã–∑–æ–≤ _extend_subscription() ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç duration_sec –∫ —Ç–µ–∫—É—â–µ–º—É expires_at
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –≤ –ë–î
   
6. –ï—Å–ª–∏ –ü–û–ö–£–ü–ö–ê:
   - –í—ã–∑–æ–≤ _create_subscription() ‚Üí —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
   - –°—Ä–æ–∫: now + duration_sec
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #6:**
- –í —Å—Ç—Ä–æ–∫–µ 181-309 `subscription_purchase_service.py` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞! –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏:
  - –ü—Ä–æ—Ü–µ—Å—Å #1: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç (expires_at = now + duration)
  - –ü—Ä–æ—Ü–µ—Å—Å #2: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ ‚Üí —Å–æ–∑–¥–∞–µ—Ç (expires_at = now + duration)
  - –ò–õ–ò:
  - –ü—Ä–æ—Ü–µ—Å—Å #1: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å (expires_at = T) ‚Üí –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç (expires_at = T + duration)
  - –ü—Ä–æ—Ü–µ—Å—Å #2: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å (expires_at = T) ‚Üí –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç (expires_at = T + duration)
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: expires_at = T + 2*duration (–¥–≤–æ–π–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ!)

---

### 4. –ü–†–û–î–õ–ï–ù–ò–ï –ü–û–î–ü–ò–°–ö–ò (`_extend_subscription()`)

**–§–∞–π–ª:** `payments/services/subscription_purchase_service.py` ‚Üí `_extend_subscription()`

**Flow:**
```
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ expires_at –∏–∑ –ë–î (—Å—Ç—Ä–æ–∫–∞ 647)

2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å—Ä–æ–∫–∞ (VIP, 2100 –≥–æ–¥ –∏ —Ç.–¥.)
   - –ï—Å–ª–∏ —Å—Ä–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é ‚Üí –Ω–µ –∏–∑–º–µ–Ω—è—Ç—å

3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ä–æ–∫–∞:
   - new_expires_at = existing_expires_at + duration_sec ‚ö†Ô∏è

4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:
   - extend_subscription_async(subscription_id, new_expires_at, tariff_id)
```

**‚ö†Ô∏è –£–ó–ö–û–ï –ú–ï–°–¢–û #7:**
- –í —Å—Ç—Ä–æ–∫–µ 687 `subscription_purchase_service.py` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∞: `new_expires_at = existing_expires_at + duration_sec`
- –ù–æ –º–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º `existing_expires_at` (—Å—Ç—Ä–æ–∫–∞ 647) –∏ –∑–∞–ø–∏—Å—å—é –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏:
  - –ü—Ä–æ—Ü–µ—Å—Å #1: —á–∏—Ç–∞–µ—Ç expires_at = T ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç new = T + duration ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç T + duration
  - –ü—Ä–æ—Ü–µ—Å—Å #2: —á–∏—Ç–∞–µ—Ç expires_at = T (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!) ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç new = T + duration ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç T + duration
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–º–µ—Å—Ç–æ T + 2*duration –ø–æ–ª—É—á–∞–µ–º T + duration (–ø–æ—Ç–µ—Ä—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è)

**–ò–õ–ò:**

- –ü—Ä–æ—Ü–µ—Å—Å #1: —á–∏—Ç–∞–µ—Ç expires_at = T ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç new = T + duration ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç T + duration (–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞)
- –ü—Ä–æ—Ü–µ—Å—Å #2: —á–∏—Ç–∞–µ—Ç expires_at = T (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!) ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç new = T + duration ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç T + duration
- –ü—Ä–æ—Ü–µ—Å—Å #1: –∫–æ–º–º–∏—Ç–∏—Ç ‚Üí expires_at = T + duration
- –ü—Ä–æ—Ü–µ—Å—Å #2: –∫–æ–º–º–∏—Ç–∏—Ç ‚Üí expires_at = T + duration (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç!)
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–¥–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ

**–ò–õ–ò (–ø—Ä–∏ –¥—Ä—É–≥–æ–º –ø–æ—Ä—è–¥–∫–µ –∫–æ–º–º–∏—Ç–æ–≤):**

- –ü—Ä–æ—Ü–µ—Å—Å #1: —á–∏—Ç–∞–µ—Ç expires_at = T ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç new = T + duration ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç T + duration ‚Üí –∫–æ–º–º–∏—Ç–∏—Ç ‚Üí expires_at = T + duration
- –ü—Ä–æ—Ü–µ—Å—Å #2: —á–∏—Ç–∞–µ—Ç expires_at = T + duration ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç new = (T + duration) + duration = T + 2*duration ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç T + 2*duration
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ!

---

## üö® –í–´–Ø–í–õ–ï–ù–ù–´–ï –£–ó–ö–ò–ï –ú–ï–°–¢–ê

### 1. **–ù–ï–ê–¢–û–ú–ê–†–ù–´–ï –ü–†–û–í–ï–†–ö–ò –°–¢–ê–¢–£–°–ê –ü–õ–ê–¢–ï–ñ–ê**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å `paid` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –≤—ã–∑–æ–≤ `process_subscription_purchase` –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã

**–ú–µ—Å—Ç–∞:**
- `webhook_service.py:91-100` (YooKassa) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞
- `webhook_service.py:259` (Platega) - –ø—Ä–æ–≤–µ—Ä–∫–∏ –ù–ï–¢ –≤–æ–æ–±—â–µ!
- `key_creation.py:1488` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞
- `background_tasks.py:345` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞
- `background_tasks.py:1334` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞

---

### 2. **–ù–ï–ê–¢–û–ú–ê–†–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û–ö–£–ü–ö–ò/–ü–†–û–î–õ–ï–ù–ò–Ø**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Å–æ–∑–¥–∞—Ç—å –µ—ë –¥–≤–∞–∂–¥—ã
- –ò–ª–∏ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É

**–ú–µ—Å—Ç–æ:**
- `subscription_purchase_service.py:132-309` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞

---

### 3. **RACE CONDITION –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò EXPIRES_AT**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º `existing_expires_at` –∏ –∑–∞–ø–∏—Å—å—é –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∞: `new_expires_at = existing_expires_at + duration_sec`
- –≠—Ç–æ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ –ë–î!

**–ú–µ—Å—Ç–æ:**
- `subscription_purchase_service.py:647-687` - —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```
–ü—Ä–æ—Ü–µ—Å—Å 1: SELECT expires_at = 100 ‚Üí –≤—ã—á–∏—Å–ª–∏–ª new = 130 ‚Üí UPDATE expires_at = 130
–ü—Ä–æ—Ü–µ—Å—Å 2: SELECT expires_at = 100 (–¥–æ –∫–æ–º–º–∏—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ 1) ‚Üí –≤—ã—á–∏—Å–ª–∏–ª new = 130 ‚Üí UPDATE expires_at = 130
–†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–º–µ—Å—Ç–æ 160 (–¥–≤–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è) –ø–æ–ª—É—á–∞–µ–º 130 (–æ–¥–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ)

–ò–õ–ò

–ü—Ä–æ—Ü–µ—Å—Å 1: SELECT expires_at = 100 ‚Üí –≤—ã—á–∏—Å–ª–∏–ª new = 130 ‚Üí UPDATE expires_at = 130 ‚Üí COMMIT
–ü—Ä–æ—Ü–µ—Å—Å 2: SELECT expires_at = 130 (–ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞) ‚Üí –≤—ã—á–∏—Å–ª–∏–ª new = 160 ‚Üí UPDATE expires_at = 160
–†–µ–∑—É–ª—å—Ç–∞—Ç: 160 (–¥–≤–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è) - –Ω–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –æ–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –ø—Ä–æ–¥–ª–∏—Ç—å
```

---

### 4. **–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï WEBHOOK'–û–í**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (YooKassa, Platega) –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ webhook'–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –µ—Å—Ç—å (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞), –Ω–æ –æ–Ω–∞ –Ω–µ –∏–¥–µ–∞–ª—å–Ω–∞

**–ú–µ—Å—Ç–∞:**
- `webhook_service.py:64-79` - –µ—Å—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ `try_update_status`, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ `COMPLETED` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ

---

### 5. **–ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –¢–û–ß–ö–ò –í–•–û–î–ê**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–ª–∞—Ç–µ–∂ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ 5 —Ä–∞–∑–Ω—ã—Ö –ø—É—Ç–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
  1. YooKassa webhook
  2. Platega webhook
  3. Polling –≤ `wait_for_payment_with_protocol`
  4. –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `process_pending_paid_payments`
  5. –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `retry_failed_subscription_notifications`

- –í—Å–µ —ç—Ç–∏ –ø—É—Ç–∏ –º–æ–≥—É—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞!

---

## üîç –ö–û–ù–ö–†–ï–¢–ù–´–ô –°–õ–£–ß–ê–ô –° –ü–û–î–ü–ò–°–ö–û–ô #224

**–í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è:**
1. **2026-01-06 22:11:42** - –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ (–∫–µ–º? –∫–∞–∫?)
2. **2026-01-08 20:27:23** - –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω
3. –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (webhook –∏–ª–∏ polling)
4. –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∏—Å–∫—É ‚Üí –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ –∫–∞–∫ **–ü–†–û–î–õ–ï–ù–ò–ï**
5. –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç: expires_at = 2026-01-06 22:11:42 + 30 –¥–Ω–µ–π + 30 –¥–Ω–µ–π = **2026-03-10 22:11:42**

**–ì–∏–ø–æ—Ç–µ–∑–∞:**
- –ü–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø—Ä–æ–±–Ω–∞—è? –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª—é—á–µ?)
- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ —Å–∏—Å—Ç–µ–º–∞ —É–≤–∏–¥–µ–ª–∞ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (—Å grace_period 24 —á–∞—Å–∞)
- –û–ø—Ä–µ–¥–µ–ª–∏–ª–∞ —ç—Ç–æ –∫–∞–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- –ü—Ä–æ–¥–ª–∏–ª–∞ –Ω–∞ 30 –¥–Ω–µ–π
- –ù–æ –≤–æ–∑–º–æ–∂–Ω–æ, –±—ã–ª –¥–≤–æ–π–Ω–æ–π –≤—ã–∑–æ–≤ `_extend_subscription`:
  - –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: expires_at = created_at + 30 –¥–Ω–µ–π + 30 –¥–Ω–µ–π (–Ω–æ created_at –±—ã–ª 6 —è–Ω–≤–∞—Ä—è, –∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –±—ã–ª–æ 8 —è–Ω–≤–∞—Ä—è, –ø–æ—ç—Ç–æ–º—É +30 +30 = 63 –¥–Ω—è)

**–ò–õ–ò:**
- –ü–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –∫–ª—é—á–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–ª–∏–ª–∞ –µ—ë
- –ù–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –¥–≤–æ–π–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ ‚Üí –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –¥–≤–∞–∂–¥—ã

---

## ‚úÖ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ (–í–´–ü–û–õ–ù–ï–ù–û)

### 1. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞** - –í–´–ü–û–õ–ù–ï–ù–û
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `try_update_status` –≤ webhook'–∞—Ö (YooKassa, Platega)
- –ü—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —É–ª—É—á—à–µ–Ω—ã –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö –≤—Ö–æ–¥–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ COMPLETED –≤ Platega webhook (–±—ã–ª–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ)

### 2. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏/–ø—Ä–æ–¥–ª–µ–Ω–∏—è** - –£–õ–£–ß–®–ï–ù–û
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ COMPLETED –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- BEGIN IMMEDIATE TRANSACTION –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ _create_subscription –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è

### 3. ‚úÖ **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ expires_at** - –í–´–ü–û–õ–ù–ï–ù–û (–ö–†–ò–¢–ò–ß–ù–û!)
- –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `extend_subscription_by_duration_async` —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º SQL-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: `UPDATE subscriptions SET expires_at = expires_at + ? WHERE id = ?`
- –≠—Ç–æ –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤ –ë–î, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions!

### 4. ‚úÖ **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å process_subscription_purchase** - –£–õ–£–ß–®–ï–ù–û
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏: –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É–∂–µ COMPLETED ‚Üí skip
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç race condition)
- –í—Å–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Å—Ç–∞—Ç—É—Å COMPLETED –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

### 5. ‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–æ –≤—Å–µ—Ö —Ç–æ—á–∫–∞—Ö –≤—Ö–æ–¥–∞** - –í–´–ü–û–õ–ù–ï–ù–û
- YooKassa webhook: –ø—Ä–æ–≤–µ—Ä–∫–∞ COMPLETED –¥–æ–±–∞–≤–ª–µ–Ω–∞
- Platega webhook: –ø—Ä–æ–≤–µ—Ä–∫–∞ COMPLETED –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–±—ã–ª–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ!)
- wait_for_payment_with_protocol: —É–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ PaymentRepository
- process_pending_paid_payments: —É–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ PaymentRepository
- retry_failed_subscription_notifications: —É–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ PaymentRepository –∏ enum

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–û–ó–ú–û–ñ–ù–´–• –î–í–û–ô–ù–´–• –°–†–ê–ë–ê–¢–´–í–ê–ù–ò–ô

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è:**

1. **Webhook + Polling:** –í—ã—Å–æ–∫–∞—è (webhook –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –≤–æ –≤—Ä–µ–º—è polling)
2. **Webhook + Background task:** –°—Ä–µ–¥–Ω—è—è (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏)
3. **Polling + Background task:** –°—Ä–µ–¥–Ω—è—è (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏)
4. **–î–≤–∞ webhook'–∞:** –°—Ä–µ–¥–Ω—è—è (YooKassa/Platega –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã)
5. **–î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ background task:** –ù–∏–∑–∫–∞—è (–Ω–æ –≤–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ)

**–ù–∞–∏–±–æ–ª–µ–µ –æ–ø–∞—Å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:**
- Webhook + Polling (–≤—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
- Webhook + Background task (—Å—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)
- –î–≤–∞ webhook'–∞ –ø–æ–¥—Ä—è–¥ (—Å—Ä–µ–¥–Ω—è—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)

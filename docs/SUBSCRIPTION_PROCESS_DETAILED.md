# –î–ï–¢–ê–õ–¨–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–¶–ï–°–°–ê –°–û–ó–î–ê–ù–ò–Ø –ò –ü–†–û–î–õ–ï–ù–ò–Ø –ü–û–î–ü–ò–°–û–ö

## üìã –û–ë–©–ò–ô FLOW

### 1. –°–û–ó–î–ê–ù–ò–ï –ü–õ–ê–¢–ï–ñ–ê

**–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞:**
- `bot/handlers/subscriptions.py` ‚Üí `handle_buy_subscription()` ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `PaymentService`

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –ø–æ–¥–ø–∏—Å–∫–∏
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
3. `metadata` —Å–æ–¥–µ—Ä–∂–∏—Ç: `{'key_type': 'subscription', 'user_id': ..., 'tariff_id': ..., 'protocol': 'v2ray'}`
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É (YooKassa/Platega/CryptoBot)

**–°—Ç–∞—Ç—É—Å:** `PENDING` ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã

---

## 2. –û–ë–†–ê–ë–û–¢–ö–ê –û–ü–õ–ê–ß–ï–ù–ù–û–ì–û –ü–õ–ê–¢–ï–ñ–ê

–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–ª–∞—Ç–µ–∂ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ **5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π**:

### üîµ –ü–£–¢–¨ #1: Webhook –æ—Ç YooKassa

**–§–∞–π–ª:** `admin/routes/webhooks.py` ‚Üí `yookassa_webhook()`  
**–°–µ—Ä–≤–∏—Å:** `payments/services/webhook_service.py` ‚Üí `handle_yookassa_webhook()`

**Flow:**
```
1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç YooKassa
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (PENDING ‚Üí PAID, –∞—Ç–æ–º–∞—Ä–Ω–æ —á–µ—Ä–µ–∑ try_update_status)
3. –ï—Å–ª–∏ metadata['key_type'] == 'subscription' –ò protocol == 'v2ray':
   ‚Üí subscription_service.process_subscription_purchase(payment_id)
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ `try_update_status`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `process_subscription_purchase` (—Å—Ç—Ä–æ–∫–∞ 91-100)

---

### üü¢ –ü–£–¢–¨ #2: Webhook –æ—Ç Platega

**–§–∞–π–ª:** `admin/routes/webhooks.py` ‚Üí `platega_webhook()`  
**–°–µ—Ä–≤–∏—Å:** `payments/services/webhook_service.py` ‚Üí `handle_platega_webhook()`

**Flow:**
```
1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç Platega
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (PENDING ‚Üí PAID, –∞—Ç–æ–º–∞—Ä–Ω–æ —á–µ—Ä–µ–∑ try_update_status)
3. –ï—Å–ª–∏ metadata['key_type'] == 'subscription' –ò protocol == 'v2ray':
   ‚Üí subscription_service.process_subscription_purchase(tx_id)
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ `try_update_status`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º (–¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö)

---

### üü° –ü–£–¢–¨ #3: Webhook –æ—Ç CryptoBot

**–§–∞–π–ª:** `admin/routes/webhooks.py` ‚Üí `cryptobot_webhook()`

**Flow:**
```
1. Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç CryptoBot
2. –ü–∞—Ä—Å–∏–Ω–≥ metadata (JSON –∏–ª–∏ Python dict —Å—Ç—Ä–æ–∫–∞)
3. –ï—Å–ª–∏ key_type == 'subscription' –ò protocol == 'v2ray':
   ‚Üí subscription_service.process_subscription_purchase(invoice_id)
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚ö†Ô∏è –ù–µ—Ç —è–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- ‚úÖ –ù–æ `process_subscription_purchase` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤–Ω—É—Ç—Ä–∏

---

### üü† –ü–£–¢–¨ #4: Polling –≤ `wait_for_payment_with_protocol()`

**–§–∞–π–ª:** `bot/services/key_creation.py` ‚Üí `wait_for_payment_with_protocol()`

**Flow:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª /buy_subscription
2. –°–æ–∑–¥–∞–µ—Ç—Å—è asyncio –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä–∞—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
3. –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –æ–ø–ª–∞—á–µ–Ω (status = 'paid'):
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ status = 'completed' ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
   - –ò–ù–ê–ß–ï ‚Üí subscription_service.process_subscription_purchase(payment_id)
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `completed` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- ‚ö†Ô∏è –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞ (–º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –≤—ã–∑–æ–≤–æ–º –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å)

---

### üî¥ –ü–£–¢–¨ #5: –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `process_pending_paid_payments()`

**–§–∞–π–ª:** `bot/services/background_tasks.py` ‚Üí `process_pending_paid_payments()`

**Flow:**
```
1. –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
2. –ò—â–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'paid', –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ status = 'completed' ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
   - –ò–ù–ê–ß–ï ‚Üí subscription_service.process_subscription_purchase(payment_uuid)
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `completed` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
- ‚ö†Ô∏è –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞

---

## 3. –û–ë–†–ê–ë–û–¢–ö–ê –í `process_subscription_purchase()`

**–§–∞–π–ª:** `payments/services/subscription_purchase_service.py` ‚Üí `process_subscription_purchase()`

### –®–∞–≥ 1: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü–ª–∞—Ç–µ–∂ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
payment = await self.payment_repo.get_by_payment_id(payment_id)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –≠—Ç–æ –ø–ª–∞—Ç–µ–∂ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É
if not (payment.metadata and payment.metadata.get('key_type') == 'subscription'):
    return False, "Not a subscription payment"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ü—Ä–æ—Ç–æ–∫–æ–ª v2ray
if payment.protocol != 'v2ray':
    return False, "Protocol is not v2ray"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ (–ö–†–ò–¢–ò–ß–ù–û!)
if payment.status == PaymentStatus.COMPLETED:
    logger.info("Payment already completed, skipping")
    return True, None  # ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

if payment.status != PaymentStatus.PAID:
    return False, "Payment is not paid"
```

**‚úÖ –ó–∞—â–∏—Ç–∞:** –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É–∂–µ `COMPLETED`, —Ñ—É–Ω–∫—Ü–∏—è —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è.

---

### –®–∞–≥ 2: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç race condition)

```python
# –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
payment_check = await self.payment_repo.get_by_payment_id(payment_id)
if payment_check and payment_check.status == PaymentStatus.COMPLETED:
    logger.info("Payment was completed by another process, skipping")
    return True, None
```

**‚úÖ –ó–∞—â–∏—Ç–∞:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ (–º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏ –≤—Ä–µ–º—è).

---

### –®–∞–≥ 3: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏/–ø—Ä–æ–¥–ª–µ–Ω–∏—è

**–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:**
   ```python
   grace_threshold = now - DEFAULT_GRACE_PERIOD  # 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
   
   # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (expires_at > grace_threshold)
   existing_subscription = await conn.execute(
       "SELECT ... FROM subscriptions WHERE user_id = ? AND is_active = 1 AND expires_at > ?",
       (payment.user_id, grace_threshold)
   )
   ```

2. **–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ—á–µ–Ω—å –Ω–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫:**
   ```python
   VERY_RECENT_THRESHOLD = 3600  # 1 —á–∞—Å
   
   if existing_subscription:
       subscription_age = now - created_at
       expected_expires_at = created_at + duration_sec
       is_very_recent = subscription_age < VERY_RECENT_THRESHOLD
       expires_at_matches_expected = abs(existing_expires_at - expected_expires_at) < 3600
       
       # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –º–µ–Ω–µ–µ 1 —á–∞—Å–∞ –Ω–∞–∑–∞–¥ –∏ —Å—Ä–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
       # —ç—Ç–æ –ü–û–ö–£–ü–ö–ê, –∞ –Ω–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è)
       if is_very_recent and expires_at_matches_expected:
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥—Ä—É–≥–∏–µ completed –ø–ª–∞—Ç–µ–∂–∏
           if other_completed_count == 0:
               # –≠—Ç–æ –ø–æ–∫—É–ø–∫–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –ù–ï –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º
               return await self._send_purchase_notification_for_existing_subscription(...)
   ```

3. **–ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
   - –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (–∏ –æ–Ω–∞ –Ω–µ –æ—á–µ–Ω—å –Ω–µ–¥–∞–≤–Ω—è—è) ‚Üí **–ü–†–û–î–õ–ï–ù–ò–ï**
   - –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Üí **–ü–û–ö–£–ü–ö–ê**

**‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º
- –î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Å–æ–∑–¥–∞—Ç—å –µ—ë –¥–≤–∞–∂–¥—ã
- **–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞:** –í `_create_subscription` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `BEGIN IMMEDIATE TRANSACTION` —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º

---

## 4. –°–û–ó–î–ê–ù–ò–ï –ü–û–î–ü–ò–°–ö–ò (`_create_subscription()`)

**–§–∞–π–ª:** `payments/services/subscription_purchase_service.py` ‚Üí `_create_subscription()`

### –®–∞–≥ 1: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º (–∑–∞—â–∏—Ç–∞ –æ—Ç race condition)
async with open_async_connection(self.db_path) as conn:
    await conn.execute("BEGIN IMMEDIATE")  # ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
    existing = await conn.execute(
        "SELECT id FROM subscriptions WHERE user_id = ? AND is_active = 1 AND expires_at > ?",
        (payment.user_id, grace_threshold)
    )
    
    if existing:
        # –ü–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
        subscription_id = existing[0]
        await conn.commit()
        # –û–±–Ω–æ–≤–ª—è–µ–º subscription_id –≤ –ø–ª–∞—Ç–µ–∂–µ
        await self.payment_repo.update_subscription_id(payment.payment_id, subscription_id)
        return await self._send_purchase_notification_for_existing_subscription(...)
    else:
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
        cursor = await conn.execute(
            "INSERT INTO subscriptions (user_id, subscription_token, created_at, expires_at, tariff_id, is_active, notified, traffic_limit_mb) VALUES (?, ?, ?, ?, ?, 1, 0, ?)",
            (payment.user_id, subscription_token, now, expires_at, tariff['id'], traffic_limit_mb)
        )
        subscription_id = cursor.lastrowid
        await conn.commit()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º subscription_id –≤ –ø–ª–∞—Ç–µ–∂–µ
        await self.payment_repo.update_subscription_id(payment.payment_id, subscription_id)
```

**‚úÖ –ó–∞—â–∏—Ç–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `BEGIN IMMEDIATE TRANSACTION` —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º.

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö

```python
# –°–æ–∑–¥–∞–µ–º –∫–ª—é—á–∏ –Ω–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö V2Ray —Å–µ—Ä–≤–µ—Ä–∞—Ö
for server in v2ray_servers:
    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ ProtocolFactory
    # ...
```

---

### –®–∞–≥ 3: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

```python
# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–µ
await self._send_notification_simple(payment.user_id, msg)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ COMPLETED
await self.payment_repo.try_update_status(
    payment.payment_id,
    PaymentStatus.COMPLETED,
    PaymentStatus.PAID
)
```

---

## 5. –ü–†–û–î–õ–ï–ù–ò–ï –ü–û–î–ü–ò–°–ö–ò (`_extend_subscription()`)

**–§–∞–π–ª:** `payments/services/subscription_purchase_service.py` ‚Üí `_extend_subscription()`

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å—Ä–æ–∫–∞

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –∏–∑–º–µ–Ω—è–µ–º —Å—Ä–æ–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é (VIP, 2100 –≥–æ–¥ –∏ —Ç.–¥.)
MANUAL_EXPIRY_THRESHOLD = 4102434000  # 01.01.2100
is_manually_set = existing_expires_at >= MANUAL_EXPIRY_THRESHOLD

if is_manually_set:
    # –ù–µ –∏–∑–º–µ–Ω—è–µ–º —Å—Ä–æ–∫
    new_expires_at = existing_expires_at
    await self.subscription_repo.extend_subscription_async(subscription_id, new_expires_at, tariff['id'])
else:
    # –û–±—ã—á–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
    # ...
```

---

### –®–∞–≥ 2: –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–ö–†–ò–¢–ò–ß–ù–û!)

```python
# ‚úÖ –ê–¢–û–ú–ê–†–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ expires_at –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ SQL
new_expires_at = await self.subscription_repo.extend_subscription_by_duration_async(
    subscription_id, 
    tariff['duration_sec'], 
    tariff['id'],
    max_expires_at=MAX_REASONABLE_EXPIRY
)
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `extend_subscription_by_duration_async`:**

```python
# app/repositories/subscription_repository.py

async def extend_subscription_by_duration_async(self, subscription_id: int, duration_sec: int, ...):
    """–ê—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥"""
    
    async with open_async_connection(self.db_path) as conn:
        # ‚úÖ –ê–¢–û–ú–ê–†–ù–û–ï SQL-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ë–î
        await conn.execute(
            """
            UPDATE subscriptions
            SET expires_at = expires_at + ?,
                tariff_id = ?,
                last_updated_at = ?
            WHERE id = ?
            """,
            (duration_sec, tariff_id, now, subscription_id)
        )
        await conn.commit()
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ expires_at
        async with conn.execute("SELECT expires_at FROM subscriptions WHERE id = ?", (subscription_id,)) as cursor:
            new_expires_at = (await cursor.fetchone())[0]
        
        return new_expires_at
```

**‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ–µ SQL-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `expires_at = expires_at + duration_sec`. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions:
- –ï—Å–ª–∏ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–¥–ª–µ–≤–∞—é—Ç –ø–æ–¥–ø–∏—Å–∫—É:
  - –ü—Ä–æ—Ü–µ—Å—Å 1: `UPDATE expires_at = expires_at + 30` ‚Üí expires_at = 100 + 30 = 130
  - –ü—Ä–æ—Ü–µ—Å—Å 2: `UPDATE expires_at = expires_at + 30` ‚Üí expires_at = 130 + 30 = 160 ‚úÖ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–±–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —É—á—Ç–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

---

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞

```python
traffic_limit_mb = tariff.get('traffic_limit_mb', 0) or 0
await self.subscription_repo.update_subscription_traffic_limit_async(subscription_id, traffic_limit_mb)
```

---

### –®–∞–≥ 4: –°–±—Ä–æ—Å —Ç—Ä–∞—Ñ–∏–∫–∞ –∫–ª—é—á–µ–π

```python
# –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
await reset_subscription_traffic(subscription_id)
```

---

### –®–∞–≥ 5: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

```python
# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
await self._send_notification_simple(payment.user_id, msg)

# ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ subscription_id –≤ –ø–ª–∞—Ç–µ–∂–µ
await self.payment_repo.update_subscription_id(payment.payment_id, subscription_id)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ COMPLETED
await self.payment_repo.try_update_status(
    payment.payment_id,
    PaymentStatus.COMPLETED,
    PaymentStatus.PAID
)
```

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:** –ï—Å–ª–∏ `update_subscription_id` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –ø–ª–∞—Ç–µ–∂ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ `subscription_id` (–∫–∞–∫ –≤ —Å–ª—É—á–∞–µ —Å –ø–ª–∞—Ç–µ–∂–æ–º 296).

---

## üö® –ú–ï–°–¢–ê –í–û–ó–ú–û–ñ–ù–´–• –ó–ê–î–í–û–ï–ù–ò–ô

### 1. **–ù–ï–ê–¢–û–ú–ê–†–ù–´–ï –ü–†–û–í–ï–†–ö–ò –°–¢–ê–¢–£–°–ê –ü–õ–ê–¢–ï–ñ–ê**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å `paid` –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –≤—ã–∑–æ–≤ `process_subscription_purchase` –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã

**–ú–µ—Å—Ç–∞:**
- `key_creation.py:wait_for_payment_with_protocol()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞
- `background_tasks.py:process_pending_paid_payments()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ `process_subscription_purchase` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å `COMPLETED` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞

---

### 2. **–ù–ï–ê–¢–û–ú–ê–†–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û–ö–£–ü–ö–ò/–ü–†–û–î–õ–ï–ù–ò–Ø**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Å–æ–∑–¥–∞—Ç—å –µ—ë –¥–≤–∞–∂–¥—ã
- –ò–ª–∏ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É

**–ú–µ—Å—Ç–æ:**
- `subscription_purchase_service.py:132-309` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ –í `_create_subscription` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `BEGIN IMMEDIATE TRANSACTION` —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- ‚ö†Ô∏è –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `process_subscription_purchase` (–ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `_create_subscription`) –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```
–ü—Ä–æ—Ü–µ—Å—Å 1: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç _create_subscription
–ü—Ä–æ—Ü–µ—Å—Å 2: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí –ø–æ–¥–ø–∏—Å–∫–∏ –µ—â–µ –Ω–µ—Ç (–ø—Ä–æ—Ü–µ—Å—Å 1 –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª) ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç _create_subscription
–†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–µ –ø–æ–¥–ø–∏—Å–∫–∏ (–Ω–æ –∑–∞—â–∏—Ç–∞ –≤ _create_subscription –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ)
```

---

### 3. **RACE CONDITION –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò EXPIRES_AT (–ò–°–ü–†–ê–í–õ–ï–ù–û!)**

**–ü—Ä–æ–±–ª–µ–º–∞ (–ë–´–õ–ê):**
- –ú–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º `existing_expires_at` –∏ –∑–∞–ø–∏—Å—å—é –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Ñ–æ—Ä–º—É–ª–∞: `new_expires_at = existing_expires_at + duration_sec` (–≤ Python)

**–†–µ—à–µ–Ω–∏–µ (–í–´–ü–û–õ–ù–ï–ù–û):**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ–µ SQL-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `UPDATE subscriptions SET expires_at = expires_at + ? WHERE id = ?`
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ë–î, –∞ –Ω–µ –≤ Python
- ‚úÖ –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `app/repositories/subscription_repository.py:extend_subscription_by_duration_async()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `subscription_purchase_service.py:719`

---

### 4. **–û–¢–°–£–¢–°–¢–í–ò–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø subscription_id –í –ü–õ–ê–¢–ï–ñ–ï**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `update_subscription_id` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –ø–ª–∞—Ç–µ–∂ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ `subscription_id`
- –≠—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å –ø–ª–∞—Ç–µ–∂–æ–º 296

**–ú–µ—Å—Ç–æ:**
- `subscription_purchase_service.py:890` - –≤—ã–∑–æ–≤ `update_subscription_id` –≤ `_extend_subscription`
- `subscription_purchase_service.py:1349` - –≤—ã–∑–æ–≤ `update_subscription_id` –≤ `_create_subscription`

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ –í—ã–∑–æ–≤ `update_subscription_id` –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–±–∞ –º–µ—Ç–æ–¥–∞
- ‚ö†Ô∏è –ù–æ –µ—Å–ª–∏ –≤—ã–∑–æ–≤ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø–ª–∞—Ç–µ–∂ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ `subscription_id`

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```python
try:
    await self.payment_repo.update_subscription_id(payment.payment_id, subscription_id)
except Exception as sub_id_error:
    logger.warning(f"Failed to update subscription_id: {sub_id_error}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ subscription_id –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω!
```

---

### 5. **–î–í–û–ô–ù–û–ï –ü–†–û–î–õ–ï–ù–ò–ï –î–õ–Ø –û–ß–ï–ù–¨ –ù–ï–î–ê–í–ù–û –°–û–ó–î–ê–ù–ù–´–• –ü–û–î–ü–ò–°–û–ö**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –æ—á–µ–Ω—å –Ω–µ–¥–∞–≤–Ω–æ (–º–µ–Ω–µ–µ 1 —á–∞—Å–∞) –∏ —Å—Ä–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É (`created_at + duration`), —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∫—É–ø–∫–∞, –∞ –Ω–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- –ù–æ –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ–¥–ø–∏—Å–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∞ –¥–≤–∞–∂–¥—ã

**–ú–µ—Å—Ç–æ:**
- `subscription_purchase_service.py:199-273` - –ø—Ä–æ–≤–µ—Ä–∫–∞ `is_very_recent` –∏ `expires_at_matches_expected`

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `VERY_RECENT_THRESHOLD = 3600` (1 —á–∞—Å)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `expires_at_matches_expected` (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–Ω–µ–µ —á–∞—Å–∞)
- ‚úÖ –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `_send_purchase_notification_for_existing_subscription` (–ù–ï –ø—Ä–æ–¥–ª–µ–Ω–∏–µ)

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã (–ë–´–õ–ê):**
```
–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ 5 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥, expires_at = created_at + 30 –¥–Ω–µ–π
–ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚Üí —Å–∏—Å—Ç–µ–º–∞ –≤–∏–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É ‚Üí –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫ –ü–†–û–î–õ–ï–ù–ò–ï
‚Üí –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç: expires_at = (created_at + 30 –¥–Ω–µ–π) + 30 –¥–Ω–µ–π = created_at + 60 –¥–Ω–µ–π
–†–µ–∑—É–ª—å—Ç–∞—Ç: –ª–∏—à–Ω–∏–µ 30 –¥–Ω–µ–π!
```

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –æ—á–µ–Ω—å –Ω–µ–¥–∞–≤–Ω—è—è –∏ —Å—Ä–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É, —ç—Ç–æ –ø–æ–∫—É–ø–∫–∞, –∞ –Ω–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

---

### 6. **–î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï WEBHOOK'–û–í**

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (YooKassa, Platega, CryptoBot) –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ webhook'–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ `try_update_status`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –≤ `process_subscription_purchase`
- ‚ö†Ô∏è –ù–æ –µ—Å–ª–∏ webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–≤–∞–∂–¥—ã –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ, –æ–±–∞ –º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

---

## ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ó–ê–©–ò–¢–´

### 1. **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞**
- ‚úÖ `PaymentRepository.try_update_status()` - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö webhook'–∞—Ö

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ COMPLETED**
- ‚úÖ –í –Ω–∞—á–∞–ª–µ `process_subscription_purchase` - –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É–∂–µ `COMPLETED`, —Ñ—É–Ω–∫—Ü–∏—è —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞

### 3. **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ expires_at**
- ‚úÖ `extend_subscription_by_duration_async()` - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ SQL-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `expires_at = expires_at + duration_sec`
- ‚úÖ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ë–î, –∞ –Ω–µ –≤ Python

### 4. **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏**
- ‚úÖ `BEGIN IMMEDIATE TRANSACTION` –≤ `_create_subscription`
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º

### 5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ–Ω—å –Ω–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫**
- ‚úÖ –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –º–µ–Ω–µ–µ 1 —á–∞—Å–∞ –Ω–∞–∑–∞–¥ –∏ —Å—Ä–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É, —ç—Ç–æ –ø–æ–∫—É–ø–∫–∞, –∞ –Ω–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

---

## üîç –ö–û–ù–ö–†–ï–¢–ù–´–ô –°–õ–£–ß–ê–ô –° –ü–õ–ê–¢–ï–ñ–û–ú 296 –ò –ü–û–î–ü–ò–°–ö–û–ô #151

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:**

1. **–ü–æ–¥–ø–∏—Å–∫–∞ #151:**
   - –°–æ–∑–¥–∞–Ω–∞: 2025-12-14 20:55:24
   - –¢–∞—Ä–∏—Ñ: 1 –º–µ—Å—è—Ü (30 –¥–Ω–µ–π)
   - –û–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫: 60 –¥–Ω–µ–π (2 –ø—Ä–æ–¥–ª–µ–Ω–∏—è)
   - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫: 92.7 –¥–Ω–µ–π (–ª–∏—à–Ω–∏–µ 32.7 –¥–Ω—è)

2. **–ü–ª–∞—Ç–µ–∂ 252:**
   - –°–æ–∑–¥–∞–Ω: 2025-12-17 13:46:41
   - –°—Ç–∞—Ç—É—Å: `completed`
   - `subscription_id`: 151 ‚úÖ
   - –≠—Ç–æ –ø–µ—Ä–≤–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–ø–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ 3 –¥–Ω—è –Ω–∞–∑–∞–¥)

3. **–ü–ª–∞—Ç–µ–∂ 296:**
   - –°–æ–∑–¥–∞–Ω: 2026-01-16 12:54:52
   - –°—Ç–∞—Ç—É—Å: `completed`
   - `subscription_id`: `None` ‚ùå
   - –≠—Ç–æ –≤—Ç–æ—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ (–Ω–æ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –ø–æ–¥–ø–∏—Å–∫–µ)

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **–ü–ª–∞—Ç–µ–∂ 296 –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–¥–ø–∏—Å–∫–µ:**
   - `update_subscription_id` –Ω–µ –±—ã–ª –≤—ã–∑–≤–∞–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π
   - –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –Ω–æ `subscription_id` –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω

2. **–ü–æ–¥–ø–∏—Å–∫–∞ #151 –∏–º–µ–µ—Ç –ª–∏—à–Ω–∏–µ –¥–Ω–∏:**
   - –û–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫: 60 –¥–Ω–µ–π (created_at + 2 * duration_sec)
   - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫: 92.7 –¥–Ω–µ–π
   - –õ–∏—à–Ω–∏–µ: 32.7 –¥–Ω—è
   - –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
     - –î–≤–æ–π–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ 252 –∏–ª–∏ 296
     - –ò–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –ü–ª–∞—Ç–µ–∂ 296 –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–¥–ø–∏—Å–∫–µ #151
- ‚úÖ –°—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ #151 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω: 60 –¥–Ω–µ–π (created_at + 2 * duration_sec)

---

## üìä –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### 1. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ subscription_id**

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
```python
try:
    await self.payment_repo.update_subscription_id(payment.payment_id, subscription_id)
except Exception as sub_id_error:
    logger.warning(f"Failed to update subscription_id: {sub_id_error}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ subscription_id –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω!
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è `update_subscription_id`
- –ò–ª–∏ —Å–¥–µ–ª–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `subscription_id` —á–∞—Å—Ç—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

### 2. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É subscription_id –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `process_subscription_purchase` –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ `subscription_id` –æ–±–Ω–æ–≤–ª–µ–Ω
- –ï—Å–ª–∏ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –∏ –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å

### 3. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–≥–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `subscription_id`
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ `subscription_id` –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å

### 4. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `completed` –±–µ–∑ `subscription_id`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∞–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–¥–≤–æ–µ–Ω–∏–π:**
1. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ `try_update_status`
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –≤ –Ω–∞—á–∞–ª–µ `process_subscription_purchase`
3. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `expires_at` —á–µ—Ä–µ–∑ SQL (`expires_at = expires_at + duration_sec`)
4. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `BEGIN IMMEDIATE TRANSACTION`
5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–µ–Ω—å –Ω–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è)

**–û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–∏—Å–∫–∏:**
1. ‚ö†Ô∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `subscription_id` –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–∞–∫ –≤ —Å–ª—É—á–∞–µ —Å –ø–ª–∞—Ç–µ–∂–æ–º 296)
2. ‚ö†Ô∏è –ù–µ–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–æ—á–∫–∞—Ö –≤—Ö–æ–¥–∞ (polling, background tasks)
3. ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã webhook'–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `subscription_id`
- –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π –±–µ–∑ `subscription_id`
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `subscription_id` —á–∞—Å—Ç—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

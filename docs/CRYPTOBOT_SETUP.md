# Инструкция по настройке оплаты криптовалютой через CryptoBot

## Шаг 1: Регистрация и получение API токена в CryptoBot

1. Откройте Telegram и найдите бота **@CryptoBot** (официальный бот)
2. Запустите бота командой `/start`
3. Зарегистрируйтесь в системе (если еще не зарегистрированы)
4. Создайте кошелек через команду `/wallet` или `/new_wallet`
5. Получите API токен:
   - Отправьте команду `/api` или `/new_api`
   - Следуйте инструкциям бота для создания API токена
   - **ВАЖНО**: Сохраните токен в безопасном месте!

## Шаг 2: Настройка переменных окружения

1. Откройте файл `.env` в корне проекта
2. Добавьте следующие переменные:

```env
# CryptoBot настройки
CRYPTOBOT_API_TOKEN=ваш_токен_здесь
CRYPTOBOT_API_URL=https://pay.crypt.bot/api
CRYPTOBOT_DEFAULT_ASSET=USDT
CRYPTOBOT_DEFAULT_NETWORK=TRC20
```

3. Замените `ваш_токен_здесь` на реальный токен из CryptoBot
4. Сохраните файл

## Шаг 3: Запуск миграций базы данных

Запустите миграции для добавления новых полей в БД:

```bash
python3 db.py
```

Вы должны увидеть сообщения:
- "Поле price_crypto_usd добавлено в tariffs"
- "Добавлено полей для криптоплатежей: 5"

## Шаг 4: Настройка webhook для CryptoBot

### Вариант A: Через CryptoBot API (рекомендуется)

Создайте скрипт для настройки webhook:

```python
# setup_webhook.py
import requests
import os

API_TOKEN = os.getenv('CRYPTOBOT_API_TOKEN')
WEBHOOK_URL = "https://your-domain.com/cryptobot/webhook"  # Замените на ваш домен

response = requests.post(
    "https://pay.crypt.bot/api/setWebhook",
    headers={"Crypto-Pay-API-Token": API_TOKEN},
    json={"url": WEBHOOK_URL}
)

print(response.json())
```

Запустите:
```bash
export CRYPTOBOT_API_TOKEN="ваш_токен"
python3 setup_webhook.py
```

### Вариант B: Через панель CryptoBot (если доступна)

1. Войдите в панель управления CryptoBot
2. Найдите раздел "Webhooks" или "Уведомления"
3. Добавьте URL: `https://your-domain.com/cryptobot/webhook`
4. Выберите события: `invoice_paid`
5. Сохраните настройки

**ВАЖНО**: 
- Замените `your-domain.com` на ваш реальный домен
- Убедитесь, что ваш сервер доступен из интернета
- Webhook должен быть доступен по HTTPS

## Шаг 5: Добавление цен в криптовалюте для тарифов

1. Запустите админ-панель вашего бота
2. Войдите в админ-панель
3. Перейдите в раздел "Тарифы"
4. Для каждого тарифа, где нужна оплата криптой:
   - Нажмите "Редактировать"
   - В поле "Цена в криптовалюте (USD)" укажите цену в долларах
   - Например: если тариф 1000₽, а курс 100₽/$1, то укажите 10.00
   - Сохраните изменения

**Совет**: Для расчета цены в USD:
- Определите текущий курс USD/RUB
- Цена в USD = Цена в RUB / Курс USD/RUB
- Можно добавить небольшую скидку для стимулирования оплаты криптой

## Шаг 6: Тестирование

### 6.1. Проверка создания инвойса

1. Запустите бота
2. Пройдите процесс покупки:
   - Выберите тариф
   - Выберите "₿ Криптовалюта (USDT)"
   - Введите email
   - Должна появиться ссылка на оплату

### 6.2. Проверка webhook

1. Оплатите тестовый инвойс через CryptoBot
2. Проверьте логи в админ-панели:
   - Перейдите в раздел "Webhooks"
   - Найдите запись с provider="cryptobot"
   - Проверьте, что статус "ok"

3. Проверьте, что ключ был выдан:
   - Бот должен отправить сообщение с ключом пользователю
   - В админ-панели проверьте, что платеж имеет статус "paid"

### 6.3. Проверка без webhook (fallback)

Если webhook не работает, система автоматически проверяет статус инвойса каждые 10 секунд. Это работает как резервный вариант.

## Шаг 7: Мониторинг и настройка

### Проверка логов

Логи webhook доступны в админ-панели:
- Раздел "Webhooks"
- Фильтр по provider="cryptobot"

### Проверка платежей

Проверьте платежи в админ-панели:
- Раздел "Платежи"
- Фильтр по provider="cryptobot"
- Проверьте статусы: pending, paid, expired

### Настройка таймаутов

Инвойсы в CryptoBot истекают через 1 час (3600 секунд). Это можно изменить в коде:
- Файл: `payments/services/payment_service.py`
- Метод: `create_crypto_payment`
- Параметр: `expires_in=3600`

## Возможные проблемы и решения

### Проблема: Webhook не приходит

**Решение:**
1. Проверьте, что URL доступен из интернета
2. Проверьте, что используется HTTPS
3. Проверьте логи webhook в админ-панели
4. Система автоматически проверяет статус каждые 10 секунд как fallback

### Проблема: Ошибка "CryptoBot service is not available"

**Решение:**
1. Проверьте, что `CRYPTOBOT_API_TOKEN` установлен в `.env`
2. Проверьте правильность токена
3. Перезапустите бота после изменения `.env`

### Проблема: Ключ не выдается после оплаты

**Решение:**
1. Проверьте логи webhook в админ-панели
2. Проверьте логи бота на наличие ошибок
3. Убедитесь, что есть доступные серверы для выбранного протокола/страны
4. Проверьте, что платеж имеет статус "paid" в БД

### Проблема: Инвойс истекает слишком быстро

**Решение:**
Измените время истечения в `create_crypto_payment`:
```python
expires_in=7200  # 2 часа вместо 1
```

## Дополнительные настройки

### Изменение криптовалюты по умолчанию

В `.env` измените:
```env
CRYPTOBOT_DEFAULT_ASSET=BTC  # Вместо USDT
CRYPTOBOT_DEFAULT_NETWORK=  # Пусто для BTC
```

Доступные активы: USDT, BTC, ETH, LTC, BNB, TRX и другие

### Настройка комиссий

CryptoBot берет комиссию с каждой транзакции (обычно 1-2%). Учитывайте это при установке цен.

## Проверочный чеклист

- [ ] Получен API токен от CryptoBot
- [ ] Добавлены переменные окружения в `.env`
- [ ] Запущены миграции БД (`python3 db.py`)
- [ ] Настроен webhook на CryptoBot
- [ ] Добавлены цены в криптовалюте для тарифов
- [ ] Протестировано создание инвойса
- [ ] Протестирована оплата и выдача ключа
- [ ] Проверены логи webhook

## Контакты поддержки

При возникновении проблем:
1. Проверьте логи в админ-панели
2. Проверьте документацию CryptoBot: https://help.crypt.bot/
3. Проверьте логи бота на наличие ошибок


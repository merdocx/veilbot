# –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ: –ü—Ä–æ–±–ª–µ–º—ã —Å –ª–∏–º–∏—Ç–∞–º–∏ —Ç—Ä–∞—Ñ–∏–∫–∞

**–î–∞—Ç–∞:** 2025-12-17

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π (SQL –æ—à–∏–±–∫–∏!)

–í `bot/services/key_management.py` –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `v2ray_keys`:
- `traffic_over_limit_at` - **—É–¥–∞–ª–µ–Ω–æ**
- `traffic_over_limit_notified` - **—É–¥–∞–ª–µ–Ω–æ**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** SQL –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ INSERT –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** ‚ùå –ù–µ—Ç

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ traffic_limit_mb –≤ –∫–ª—é—á–∏

–õ–∏–º–∏—Ç—ã –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–æ–¥–ø–∏—Å–∫–∞—Ö, –Ω–æ –∫–æ–¥ –≤—Å–µ –µ—â–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `traffic_limit_mb` –≤ –∫–ª—é—á–∏:
- 9 –º–µ—Å—Ç –≤ INSERT –∑–∞–ø—Ä–æ—Å–∞—Ö
- 11 –º–µ—Å—Ç –≤ UPDATE –∑–∞–ø—Ä–æ—Å–∞—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** ‚ùå –ù–µ—Ç

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ expiry_at –≤ v2ray_keys

–í `payments/services/subscription_purchase_service.py` –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `expiry_at` –ø—Ä–∏ INSERT –≤ `v2ray_keys`, —Ö–æ—Ç—è –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–¥–∞–ª–µ–Ω (–∏–ª–∏ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è legacy).

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°—Ö–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ `expiry_at` –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `v2ray_keys`. –í–æ–∑–º–æ–∂–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –ø–æ–ª–µ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

## üìã –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç

### –§–∞–π–ª—ã —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏:

1. **bot/services/key_management.py**
   - INSERT —Å traffic_limit_mb: 6 –º–µ—Å—Ç
   - INSERT —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (traffic_over_limit_at/notified): 5 –º–µ—Å—Ç
   - UPDATE traffic_limit_mb: 6 –º–µ—Å—Ç
   - SELECT —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π: 1 –º–µ—Å—Ç–æ

2. **payments/services/subscription_purchase_service.py**
   - INSERT —Å traffic_limit_mb –∏ expiry_at: 2 –º–µ—Å—Ç–∞
   - UPDATE traffic_limit_mb: 2 –º–µ—Å—Ç–∞

3. **bot/services/background_tasks.py**
   - INSERT —Å traffic_limit_mb: 2 –º–µ—Å—Ç–∞
   - UPDATE traffic_limit_mb: 1 –º–µ—Å—Ç–æ

4. **bot/services/subscription_service.py**
   - INSERT —Å traffic_limit_mb: 1 –º–µ—Å—Ç–æ

5. **bot/services/key_creation.py**
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Å—Ç–∞—Ç–∫–∏

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ (–Ω–µ —Ç—Ä–æ–≥–∞—Ç—å)

1. **monitor_subscription_traffic_limits()** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥–ø–∏—Å–æ–∫
2. **admin/routes/keys.py** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏–º–∏—Ç –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏
3. **subscription_repository** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–∏–º–∏—Ç–∞–º–∏ –≤ –ø–æ–¥–ø–∏—Å–∫–∞—Ö
4. **traffic_usage_bytes –≤ –∫–ª—é—á–∞—Ö** - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

## üîß –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ö–†–ò–¢–ò–ß–ù–û (SQL –æ—à–∏–±–∫–∏):
1. ‚úÖ –£–±—Ä–∞—Ç—å traffic_over_limit_at –∏ traffic_over_limit_notified –∏–∑ INSERT –≤ v2ray_keys
2. ‚úÖ –£–±—Ä–∞—Ç—å SELECT —ç—Ç–∏—Ö –ø–æ–ª–µ–π

### –í–ê–ñ–ù–û (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö):
3. ‚úÖ –£–±—Ä–∞—Ç—å traffic_limit_mb –∏–∑ INSERT –≤ –∫–ª—é—á–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
4. ‚úÖ –£–±—Ä–∞—Ç—å UPDATE traffic_limit_mb –≤ –∫–ª—é—á–∞—Ö –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫

### –ú–û–ñ–ù–û –û–¢–õ–û–ñ–ò–¢–¨:
5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞ –¥–ª—è standalone –∫–ª—é—á–µ–π (background_tasks.py, bot.py)


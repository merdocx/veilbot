# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω: –£–¥–∞–ª–µ–Ω–∏–µ expiry_at –∏–∑ –∫–ª—é—á–µ–π

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-01-21  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω (–º–∏–≥—Ä–∞—Ü–∏—è –ë–î –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞)

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ `/root/veilbot/scripts/migrate_remove_expiry_at_from_keys.py`
- ‚ö†Ô∏è **–ù–ï –ó–ê–ü–£–©–ï–ù–ê** - –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 2. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `app/repositories/key_repository.py` - –≤—Å–µ –º–µ—Ç–æ–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `app/repositories/subscription_repository.py` - –º–µ—Ç–æ–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `app/repositories/user_repository.py` - resolve_user_email –æ–±–Ω–æ–≤–ª–µ–Ω

### 3. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ `admin/routes/payments.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ `admin/routes/dashboard.py` - –ø–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ `admin/routes/keys.py` - –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ `admin/routes/users.py` - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω–æ

### 4. –ü–ª–∞—Ç–µ–∂–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `payments/repositories/payment_repository.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ `payments/services/payment_service.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ `payments/services/subscription_purchase_service.py` - –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### 5. –ë–æ—Ç-—Å–µ—Ä–≤–∏—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `bot/handlers/keys.py` - –∑–∞–ø—Ä–æ—Å—ã –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `bot/handlers/key_management.py` - –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `bot/handlers/common.py` - –ø–æ–¥—Å—á–µ—Ç –∫–ª—é—á–µ–π
- ‚úÖ `bot/handlers/renewal.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ `bot/services/free_tariff.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π
- ‚úÖ `bot/services/background_tasks.py` - —É–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–ª—é—á–µ–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
- ‚úÖ `bot/services/subscription_migration.py` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –∏ —Å—Ä–æ–∫–∞
- ‚úÖ `bot/services/key_creation.py` - –≤—Å–µ SELECT –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `bot/services/key_management.py` - UPDATE –∏ SELECT –æ–±–Ω–æ–≤–ª–µ–Ω—ã (INSERT –æ—Å—Ç–∞–≤–ª–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å subscription_id)
- ‚úÖ `bot.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–ª—é—á–µ–π

### 6. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∫—Ä–∏–ø—Ç—ã
- ‚úÖ `validators.py` - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ `scripts/create_subscriptions_for_users_without.py` - –∑–∞–ø—Ä–æ—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

## üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### SELECT –∑–∞–ø—Ä–æ—Å—ã
–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–∏–ø–∞:
```sql
SELECT k.id, k.expiry_at, ...
FROM keys k
WHERE k.expiry_at > ?
```

–ó–∞–º–µ–Ω–µ–Ω—ã –Ω–∞:
```sql
SELECT k.id, COALESCE(sub.expires_at, 0) as expiry_at, ...
FROM keys k
LEFT JOIN subscriptions sub ON k.subscription_id = sub.id
WHERE sub.expires_at > ?
```

### UPDATE –∑–∞–ø—Ä–æ—Å—ã
–í—Å–µ UPDATE `expiry_at` –≤ –∫–ª—é—á–∞—Ö –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `SubscriptionRepository.extend_subscription()`.

### INSERT –∑–∞–ø—Ä–æ—Å—ã
INSERT –∑–∞–ø—Ä–æ—Å—ã –æ—Å—Ç–∞–ª–∏—Å—å —Å `expiry_at` –≤ —Å–ø–∏—Å–∫–µ –∫–æ–ª–æ–Ω–æ–∫, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –ø–æ–ª–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ, –∏ INSERT'—ã –Ω–µ –±—É–¥—É—Ç –ø—ã—Ç–∞—Ç—å—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –µ–≥–æ (–∏–ª–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏).

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–°–¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î**
2. **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å**
3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é**
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**
5. **–û–±–Ω–æ–≤–∏—Ç—å INSERT –∑–∞–ø—Ä–æ—Å—ã** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, —É–±—Ä–∞—Ç—å expiry_at –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–æ–ª–æ–Ω–æ–∫)

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é: `python scripts/migrate_remove_expiry_at_from_keys.py`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å INSERT –∑–∞–ø—Ä–æ—Å—ã (—É–±—Ä–∞—Ç—å expiry_at –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–æ–ª–æ–Ω–æ–∫)

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–∏–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç)
- –û—Å—Ç–∞–ª–∏—Å—å —É–ø–æ–º–∏–Ω–∞–Ω–∏—è `expiry_at` –≤ –∫–æ–¥–µ, –Ω–æ –æ–Ω–∏ –ª–∏–±–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö JOIN –∑–∞–ø—Ä–æ—Å–∞—Ö, –ª–∏–±–æ –≤ INSERT (–∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
- –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ `expiry_at` –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö `keys` –∏ `v2ray_keys`
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–µ–π —Ç–µ–ø–µ—Ä—å - `subscriptions.expires_at`



# –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ –° –ü–û–î–ü–ò–°–ö–û–ô #151

## üìã –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï

### –ü–æ–¥–ø–∏—Å–∫–∞ #151
- **ID:** 151
- **user_id:** 7126897452
- **tariff_id:** 4 (1 –º–µ—Å—è—Ü, 100 –ì–±)
- **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞:** 30 –¥–Ω–µ–π (2,592,000 —Å–µ–∫—É–Ω–¥)
- **created_at:** 2025-12-14 20:55:24 (timestamp: 1765734924)
- **expires_at (—Ç–µ–∫—É—â–∏–π, –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):** 2026-02-12 20:55:24 (timestamp: 1770918924)
- **expires_at (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):** 2026-03-17 13:46:00 (92.7 –¥–Ω–µ–π –≤–º–µ—Å—Ç–æ 60 –¥–Ω–µ–π)
- **is_active:** 1
- **purchase_notification_sent:** 0
- **last_updated_at:** 2026-01-16 15:41:25 (timestamp: 1768567285)

### –ü–ª–∞—Ç–µ–∂–∏

#### –ü–ª–∞—Ç–µ–∂ 252
- **ID:** 252
- **payment_id:** 30d49dd1-000f-5000-b000-1223d0eea1e7
- **tariff_id:** 4
- **status:** completed
- **subscription_id:** 151 ‚úÖ
- **amount:** 20,000 RUB
- **created_at:** 2025-12-17 13:46:41 (—á–µ—Ä–µ–∑ 2.7 –¥–Ω–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏)
- **updated_at:** 2026-01-11 18:11:38

#### –ü–ª–∞—Ç–µ–∂ 296
- **ID:** 296
- **payment_id:** 30fc1eac-000f-5000-b000-167ec8e1dbf5
- **tariff_id:** 4
- **status:** completed
- **subscription_id:** 151 ‚úÖ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é)
- **amount:** 20,000 RUB
- **created_at:** 2026-01-16 12:54:52 (—á–µ—Ä–µ–∑ 32.7 –¥–Ω–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏)
- **updated_at:** 2026-01-16 12:55:40

---

## üìÖ –í–†–ï–ú–ï–ù–ù–ê–Ø –õ–ò–ù–ò–Ø –°–û–ë–´–¢–ò–ô

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
**–î–∞—Ç–∞:** 2025-12-14 20:55:24

- –ü–æ–¥–ø–∏—Å–∫–∞ #151 —Å–æ–∑–¥–∞–Ω–∞
- –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π `expires_at` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: **2026-01-13 20:55:24** (created_at + 30 –¥–Ω–µ–π)
- –≠—Ç–æ –ø–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏

---

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ 252
**–î–∞—Ç–∞:** 2025-12-17 13:46:41 (—á–µ—Ä–µ–∑ 2.7 –¥–Ω—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏)

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- `expires_at` = 2026-01-13 20:55:24 (–ø–æ–¥–ø–∏—Å–∫–∞ –µ—â–µ –∞–∫—Ç–∏–≤–Ω–∞)
- –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω **–î–û –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞** –ø–æ–¥–ø–∏—Å–∫–∏

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:**
1. –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (expires_at > now - 24 —á–∞—Å–∞)
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —ç—Ç–æ –∫–∞–∫ **–ü–†–û–î–õ–ï–ù–ò–ï** (–Ω–µ –ø–æ–∫—É–ø–∫–∞)
3. –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: `expires_at = 2026-01-13 20:55:24 + 30 –¥–Ω–µ–π = 2026-02-12 20:55:24`
4. –û–±–Ω–æ–≤–∏—Ç—å `subscription_id` –≤ –ø–ª–∞—Ç–µ–∂–µ 252 ‚úÖ
5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
6. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ `COMPLETED` ‚úÖ

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚úÖ
- `subscription_id` –æ–±–Ω–æ–≤–ª–µ–Ω ‚úÖ
- –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞: `completed` ‚úÖ
- `expires_at` –ø–æ–¥–ø–∏—Å–∫–∏: **–¥–æ–ª–∂–µ–Ω –±—ã–ª —Å—Ç–∞—Ç—å 2026-02-12 20:55:24**

**‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê:** 
- –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è `expires_at` –±—ã–ª **2026-03-17 13:46:00** (92.7 –¥–Ω–µ–π)
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ **–ª–∏—à–Ω–∏—Ö 32.7 –¥–Ω–µ–π**

---

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ 296
**–î–∞—Ç–∞:** 2026-01-16 12:54:52 (—á–µ—Ä–µ–∑ 32.7 –¥–Ω–µ–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏)

**–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- `expires_at` –¥–æ–ª–∂–µ–Ω –±—ã–ª –±—ã—Ç—å: 2026-02-12 20:55:24 (–ø–æ—Å–ª–µ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–æ–º 252)
- –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω **–î–û –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞** –ø–æ–¥–ø–∏—Å–∫–∏

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:**
1. –°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —ç—Ç–æ –∫–∞–∫ **–ü–†–û–î–õ–ï–ù–ò–ï**
3. –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: `expires_at = 2026-02-12 20:55:24 + 30 –¥–Ω–µ–π = 2026-03-14 20:55:24`
4. –û–±–Ω–æ–≤–∏—Ç—å `subscription_id` –≤ –ø–ª–∞—Ç–µ–∂–µ 296 ‚ùå (–Ω–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ)
5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
6. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ `COMPLETED` ‚úÖ

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚úÖ
- `subscription_id` **–ù–ï –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω** ‚ùå (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é)
- –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞: `completed` ‚úÖ

---

## üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –õ–∏—à–Ω–∏–µ 32.7 –¥–Ω—è –≤ expires_at

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- `expires_at` = 2026-03-17 13:46:00 (92.7 –¥–Ω–µ–π)
- –û–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫ = 60 –¥–Ω–µ–π (2 –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ 30 –¥–Ω–µ–π)
- **–õ–∏—à–Ω–∏–µ –¥–Ω–∏:** 32.7 –¥–Ω—è

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

#### 1.1. –î–≤–æ–π–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ 252

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
1. –ü–ª–∞—Ç–µ–∂ 252 –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø–µ—Ä–≤—ã–π —Ä–∞–∑:
   - expires_at = 2026-01-13 20:55:24 + 30 –¥–Ω–µ–π = 2026-02-12 20:55:24 ‚úÖ

2. –ü–ª–∞—Ç–µ–∂ 252 –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ (–¥—É–±–ª–∏–∫–∞—Ç webhook –∏–ª–∏ retry):
   - –°–∏—Å—Ç–µ–º–∞ —Å–Ω–æ–≤–∞ –Ω–∞—à–ª–∞ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
   - –û–ø—Ä–µ–¥–µ–ª–∏–ª–∞ –∫–∞–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
   - expires_at = 2026-02-12 20:55:24 + 30 –¥–Ω–µ–π = 2026-03-14 20:55:24 ‚ùå
   
3. –ü–ª–∞—Ç–µ–∂ 296 –æ–±—Ä–∞–±–æ—Ç–∞–Ω:
   - expires_at = 2026-03-14 20:55:24 + 30 –¥–Ω–µ–π = 2026-04-13 20:55:24 ‚ùå
   
–†–µ–∑—É–ª—å—Ç–∞—Ç: expires_at = 2026-03-17 13:46:00 (–ø—Ä–∏–º–µ—Ä–Ω–æ 92.7 –¥–Ω–µ–π)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –º–æ–≥–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- Webhook –æ—Ç YooKassa –ø—Ä–∏—à–µ–ª –¥–≤–∞–∂–¥—ã (–¥—É–±–ª–∏–∫–∞—Ç)
- Polling –∏ webhook –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `process_pending_paid_payments` –æ–±—Ä–∞–±–æ—Ç–∞–ª–∞ –ø–ª–∞—Ç–µ–∂ –ø–æ—Å–ª–µ webhook'–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ (race condition)

#### 1.2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏/–ø—Ä–æ–¥–ª–µ–Ω–∏—è

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
1. –ü–ª–∞—Ç–µ–∂ 252 –æ–±—Ä–∞–±–æ—Ç–∞–Ω:
   - –°–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞—à–ª–∞ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (race condition)
   - –û–ø—Ä–µ–¥–µ–ª–∏–ª–∞ –∫–∞–∫ –ü–û–ö–£–ü–ö–£ –≤–º–µ—Å—Ç–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
   - –°–æ–∑–¥–∞–ª–∞ –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –ø—Ä–æ–¥–ª–∏–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
   
2. –ü–ª–∞—Ç–µ–∂ 252 –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ:
   - –°–∏—Å—Ç–µ–º–∞ –Ω–∞—à–ª–∞ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
   - –û–ø—Ä–µ–¥–µ–ª–∏–ª–∞ –∫–∞–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
   - –ü—Ä–æ–¥–ª–∏–ª–∞ –µ—â–µ —Ä–∞–∑
   
–†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–≤–æ–π–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –º–æ–≥–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –∞—Ç–æ–º–∞—Ä–Ω–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º
- –î–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –û–±–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ –∫–∞–∫ –ø–æ–∫—É–ø–∫—É/–ø—Ä–æ–¥–ª–µ–Ω–∏–µ

#### 1.3. –†—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- `last_updated_at` = 2026-01-16 15:41:25
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ `expires_at` —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
- –ù–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–∑–Ω–∏—Ü–∞ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 30 –¥–Ω—è–º

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü–ª–∞—Ç–µ–∂ 296 –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–¥–ø–∏—Å–∫–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–ª–∞—Ç–µ–∂ 296 –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚úÖ
- –°—Ç–∞—Ç—É—Å: `completed` ‚úÖ
- `subscription_id`: `None` ‚ùå (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 151)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

#### 2.1. –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `update_subscription_id`

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```python
# –í _extend_subscription():
try:
    await self.payment_repo.update_subscription_id(payment.payment_id, subscription_id)
except Exception as sub_id_error:
    logger.warning(f"Failed to update subscription_id: {sub_id_error}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ subscription_id –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω!
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –º–æ–≥–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "database is locked")
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –±—ã–ª–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–æ, –Ω–æ –ø–ª–∞—Ç–µ–∂ —É–∂–µ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ `completed`
- `subscription_id` –æ—Å—Ç–∞–ª—Å—è `None`

#### 2.2. –ü–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã–∑–æ–≤–∞ `update_subscription_id`

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –ü–ª–∞—Ç–µ–∂ 296 –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `update_subscription_id` –≤ `_extend_subscription`
- –ö–æ–¥ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω, –Ω–æ –ø–ª–∞—Ç–µ–∂ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –í—ã–∑–æ–≤ `update_subscription_id` –¥–æ–±–∞–≤–ª–µ–Ω –≤ v2.4.9
- –ü–ª–∞—Ç–µ–∂ 296 –æ–±—Ä–∞–±–æ—Ç–∞–Ω 2026-01-16 12:54:52
- –í–µ—Ä—Å–∏—è 2.4.9 –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ 2026-01-16 (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞)

**–í—ã–≤–æ–¥:** –ü–ª–∞—Ç–µ–∂ 296 –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã–∑–æ–≤–∞ `update_subscription_id` –≤ –∫–æ–¥.

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –ü–ª–∞—Ç–µ–∂ 296
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ü—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–¥–ø–∏—Å–∫–µ #151 (`subscription_id = 151`)

### 2. –ü–æ–¥–ø–∏—Å–∫–∞ #151
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** `expires_at` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Å 2026-03-17 13:46:00 –Ω–∞ 2026-02-12 20:55:24
- **–ù–æ–≤—ã–π —Å—Ä–æ–∫:** 60 –¥–Ω–µ–π (–æ–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫ –¥–ª—è 2 –ø—Ä–æ–¥–ª–µ–Ω–∏–π)
- **–õ–∏—à–Ω–∏–µ –¥–Ω–∏ —É–¥–∞–ª–µ–Ω—ã:** 32.7 –¥–Ω—è

---

## üîß –ö–û–†–ù–ï–í–´–ï –ü–†–ò–ß–ò–ù–´

### 1. –î–≤–æ–π–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ 252

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ü–ª–∞—Ç–µ–∂ 252 –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–≤–∞–∂–¥—ã (–¥—É–±–ª–∏–∫–∞—Ç webhook –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- –í—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–∏–ª–∞ –ª–∏—à–Ω–∏–µ 30 –¥–Ω–µ–π

**–ó–∞—â–∏—Ç–∞ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞):**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –≤ –Ω–∞—á–∞–ª–µ `process_subscription_purchase`
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `expires_at` —á–µ—Ä–µ–∑ SQL (`expires_at = expires_at + duration_sec`)
- ‚ö†Ô∏è –ù–æ –µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–≤–∞–∂–¥—ã –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞, –æ–±–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–ª—É—á—à–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `payment_id` + `status` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `subscription_id` –≤ –ø–ª–∞—Ç–µ–∂–µ 296

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ü–ª–∞—Ç–µ–∂ 296 –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã–∑–æ–≤–∞ `update_subscription_id` –≤ –∫–æ–¥
- –ö–æ–¥ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω –≤ v2.4.9, –Ω–æ –ø–ª–∞—Ç–µ–∂ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω

**–ó–∞—â–∏—Ç–∞ (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞):**
- ‚úÖ –í—ã–∑–æ–≤ `update_subscription_id` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `_extend_subscription` (v2.4.9)
- ‚úÖ –í—ã–∑–æ–≤ `update_subscription_id` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `_create_subscription`
- ‚ö†Ô∏è –ù–æ –µ—Å–ª–∏ –≤—ã–∑–æ–≤ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π, –ø–ª–∞—Ç–µ–∂ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ `subscription_id`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è `update_subscription_id`
- –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π –±–µ–∑ `subscription_id`
- –°–¥–µ–ª–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `subscription_id` —á–∞—Å—Ç—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

---

## üìä –í–´–í–û–î–´

1. **–ü–ª–∞—Ç–µ–∂ 252:** –í–µ—Ä–æ—è—Ç–Ω–æ, –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–≤–∞–∂–¥—ã, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –¥–≤–æ–π–Ω–æ–º—É –ø—Ä–æ–¥–ª–µ–Ω–∏—é (–ª–∏—à–Ω–∏–µ 30 –¥–Ω–µ–π)
2. **–ü–ª–∞—Ç–µ–∂ 296:** –ë—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—ã–∑–æ–≤–∞ `update_subscription_id` –≤ –∫–æ–¥, –ø–æ—ç—Ç–æ–º—É –Ω–µ –±—ã–ª –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–¥–ø–∏—Å–∫–µ
3. **–ü–æ–¥–ø–∏—Å–∫–∞ #151:** –ò–º–µ–ª–∞ –ª–∏—à–Ω–∏–µ 32.7 –¥–Ω—è –∏–∑-–∑–∞ –¥–≤–æ–π–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞ 252

**–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**
- ‚úÖ –ü–ª–∞—Ç–µ–∂ 296 –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–¥–ø–∏—Å–∫–µ
- ‚úÖ –°—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (60 –¥–Ω–µ–π –≤–º–µ—Å—Ç–æ 92.7 –¥–Ω–µ–π)

**–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è:**
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `expires_at` —á–µ—Ä–µ–∑ SQL
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ `COMPLETED` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- ‚úÖ –í—ã–∑–æ–≤ `update_subscription_id` –≤ –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–∞—Ö (`_create_subscription` –∏ `_extend_subscription`)

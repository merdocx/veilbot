# Техническое задание: VIP пользователи

## 1. Общая концепция

Добавить функциональность VIP пользователей, у которых подписки имеют безлимит на срок действия и трафик.

## 2. Вопросы для согласования

### 2.1. Хранение VIP статуса
**Вопрос:** Где хранить флаг VIP?
- **Вариант А (рекомендуется):** Добавить колонку `is_vip INTEGER DEFAULT 0` в таблицу `users`
- **Вариант Б:** Отдельная таблица `vip_users` с `user_id`

**Предложение:** Вариант А - проще и быстрее для проверки.

---

### 2.2. Механизм безлимита для VIP
**Вопрос:** Как реализовать безлимит для VIP?

**Вариант А:** Автоматически устанавливать значения при создании/обновлении подписки:
- `expires_at = 4102434000` (01.01.2100 00:00 UTC)
- `traffic_limit_mb = 0` (0 = безлимит)

**Вариант Б:** Проверять VIP статус в местах проверки лимитов:
- При проверке `expires_at <= now` → если VIP, пропускать проверку
- При проверке трафика → если VIP, пропускать проверку

**Вариант В:** Комбинированный подход:
- Автоматически устанавливать значения (как в А)
- Дополнительно проверять VIP статус в критических местах

**Предложение:** Вариант В - наиболее надежный.

---

### 2.3. Применение к существующим подпискам
**Вопрос:** Что делать с существующими подписками при назначении VIP?

- **Вариант А:** Автоматически обновить все активные подписки пользователя:
  - Установить `expires_at = 4102434000`
  - Установить `traffic_limit_mb = 0`

- **Вариант Б:** Не трогать существующие, только новые подписки будут безлимитными

**Предложение:** Вариант А - пользователь сразу получает безлимит.

---

### 2.4. Снятие VIP статуса
**Вопрос:** Что происходит при снятии VIP статуса?

- **Вариант А:** Оставить текущие значения (`expires_at` и `traffic_limit_mb`) как есть
- **Вариант Б:** Вернуть к исходным значениям (если они сохранялись)
- **Вариант В:** Установить стандартные значения (например, +1 месяц от текущей даты)

**Предложение:** Вариант А - не менять текущие значения.

---

### 2.5. Проверка VIP в фоновых задачах
**Вопрос:** Нужно ли исключать VIP из фоновых проверок?

**Места проверки:**
1. `auto_delete_expired_keys()` - удаление истекших ключей
2. `auto_delete_expired_subscriptions()` - удаление истекших подписок
3. `monitor_subscription_traffic_limits()` - мониторинг трафика
4. `notify_expiring_subscriptions()` - уведомления об истечении
5. `sync_subscription_keys_with_active_servers()` - синхронизация ключей

**Предложение:** Исключать VIP из всех проверок срока действия и трафика.

---

### 2.6. Отображение в админке
**Вопрос:** Как отображать VIP статус?

- **На странице Users:**
  - Чекбокс "VIP" для каждого пользователя
  - Визуальное выделение VIP пользователей (например, золотая звездочка)

- **На странице Subscriptions:**
  - Показывать VIP статус пользователя
  - Отображать "Безлимит" для VIP подписок

**Предложение:** Добавить чекбокс в таблице пользователей и визуальное выделение.

---

### 2.7. Уведомления пользователю
**Вопрос:** Нужно ли уведомлять пользователя о VIP статусе?

- **Вариант А:** Автоматически отправлять сообщение при назначении VIP
- **Вариант Б:** Не уведомлять

**Предложение:** Вариант А - пользователь должен знать о привилегиях.

---

### 2.8. Дополнительные привилегии
**Вопрос:** Нужны ли дополнительные привилегии для VIP (кроме безлимита)?

- Приоритетная поддержка?
- Дополнительные серверы?
- Что-то еще?

**Предложение:** Пока только безлимит, остальное можно добавить позже.

---

## 3. Предлагаемое решение (для согласования)

### 3.1. База данных
- Добавить колонку `is_vip INTEGER DEFAULT 0` в таблицу `users`
- Миграция для существующих пользователей (все = 0)

### 3.2. Админка
- На странице `/users` добавить колонку "VIP" с чекбоксом
- При изменении VIP статуса:
  - Если установлен VIP → обновить все активные подписки пользователя (expires_at, traffic_limit_mb)
  - Если снят VIP → оставить текущие значения

### 3.3. Логика безлимита
- При создании новой подписки для VIP:
  - Автоматически устанавливать `expires_at = 4102434000`
  - Автоматически устанавливать `traffic_limit_mb = 0`
- При проверке лимитов:
  - Проверять VIP статус пользователя
  - Если VIP → пропускать проверки срока и трафика

### 3.4. Фоновые задачи
- Исключать VIP подписки из:
  - `auto_delete_expired_keys()`
  - `auto_delete_expired_subscriptions()`
  - `monitor_subscription_traffic_limits()`
  - `notify_expiring_subscriptions()`

### 3.5. Уведомления
- При назначении VIP → отправлять сообщение пользователю
- При снятии VIP → отправлять сообщение (опционально)

---

## 4. Согласованные решения

1. ✅ **Хранение VIP статуса:** Колонка `is_vip INTEGER DEFAULT 0` в таблице `users`
2. ✅ **Механизм безлимита:** Вариант В (комбинированный)
   - Автоматически устанавливать `expires_at = 4102434000` и `traffic_limit_mb = 0`
   - Дополнительно проверять VIP статус в критических местах
3. ✅ **Применение к существующим подпискам:** Вариант А
   - При назначении VIP автоматически обновить все активные подписки пользователя
4. ✅ **Снятие VIP статуса:** Вариант А
   - Оставить текущие значения (`expires_at` и `traffic_limit_mb`) как есть
5. ✅ **Исключение VIP из фоновых проверок:** Да
   - Исключать из `auto_delete_expired_keys()`
   - Исключать из `auto_delete_expired_subscriptions()`
   - Исключать из `monitor_subscription_traffic_limits()`
   - Исключать из `notify_expiring_subscriptions()`
6. ✅ **Отображение в админке:**
   - Чекбокс "VIP" на странице `/users` для каждого пользователя
   - Визуальное выделение VIP пользователей (например, иконка звездочки)
   - На странице подписок показывать VIP статус пользователя
7. ✅ **Уведомления:** Отправлять сообщение пользователю при назначении VIP
8. ✅ **Дополнительные привилегии:** Пока только безлимит (срок и трафик)

---

## 5. План реализации

1. Создать миграцию БД для добавления колонки `is_vip`
2. Обновить `UserRepository` для работы с VIP статусом
3. Добавить чекбокс VIP на страницу `/users` в админке
4. Обновить логику создания подписок для VIP
5. Обновить все места проверки лимитов (срок, трафик)
6. Обновить фоновые задачи для исключения VIP
7. Добавить уведомления при изменении VIP статуса
8. Обновить отображение в админке (подписки, пользователи)

---

**Ожидаю согласования по всем пунктам перед началом реализации.**


# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ "–ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å –∫–ª—é—á" –∏ "–°–º–µ–Ω–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"

## ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã

### 1. –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–≤—ã–ø—É—Å—Ç–∏—Ç—å –∫–ª—é—á"

#### ‚úÖ –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª—é—á–∞:
- **–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–∂–¥–æ–º –∫–ª—é—á–µ
- **–ï—Å–ª–∏ –æ–¥–∏–Ω –∫–ª—é—á**: –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≤—ã–±–æ—Ä –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫—É
- **–ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–π**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫–∞"

#### ‚úÖ –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞:
- **–°–µ—Ä–≤–µ—Ä**: –ò—â–µ—Ç –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω—ã –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (`id != old_server_id`)
- **–ü—Ä–æ—Ç–æ–∫–æ–ª**: –û—Å—Ç–∞–µ—Ç—Å—è —Ç–æ—Ç –∂–µ (Outline ‚Üí Outline, V2Ray ‚Üí V2Ray)
- **–°—Ç—Ä–∞–Ω–∞**: –û—Å—Ç–∞–µ—Ç—Å—è —Ç–∞ –∂–µ

#### ‚úÖ –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞:
- **–ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π**: –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–ª—é—á, –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π
- **–£–¥–∞–ª–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞**: –£–¥–∞–ª—è–µ—Ç –∫–ª—é—á —Å VPN —Å–µ—Ä–≤–µ—Ä–∞
- **–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã**: –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–π –∫–ª—é—á —É–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ

### 2. –ö–Ω–æ–ø–∫–∞ "–°–º–µ–Ω–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"

#### ‚úÖ –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª—é—á–∞:
- **–ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–∂–¥–æ–º –∫–ª—é—á–µ
- **–ï—Å–ª–∏ –æ–¥–∏–Ω –∫–ª—é—á**: –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –≤—ã–±–æ—Ä –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–º–µ–Ω–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- **–ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–π**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è —Å–º–µ–Ω—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞"

#### ‚úÖ –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞:
- **–°–µ—Ä–≤–µ—Ä**: –ò—â–µ—Ç —Å–µ—Ä–≤–µ—Ä —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω—ã —Å –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
- **–ü—Ä–æ—Ç–æ–∫–æ–ª**: –ú–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π (Outline ‚Üí V2Ray, V2Ray ‚Üí Outline)
- **–°—Ç—Ä–∞–Ω–∞**: –û—Å—Ç–∞–µ—Ç—Å—è —Ç–∞ –∂–µ

#### ‚úÖ –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞:
- **–ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π**: –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–ª—é—á, –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π
- **–£–¥–∞–ª–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞**: –£–¥–∞–ª—è–µ—Ç –∫–ª—é—á —Å VPN —Å–µ—Ä–≤–µ—Ä–∞
- **–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã**: –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–π –∫–ª—é—á —É–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –≤–Ω–µ—Å–µ–Ω–Ω—ã–µ –≤ –∫–æ–¥

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫–∞ V2Ray –∫–ª—é—á–µ–π
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫–µ V2Ray –∫–ª—é—á–µ–π –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è —É–¥–∞–ª–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Outline –∫–ª—é—á
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∫–ª—é—á–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ `key_data['key_id']`

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–º–µ–Ω–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- **–ü—Ä–æ–±–ª–µ–º–∞**: –°—Ç–∞—Ä—ã–π –∫–ª—é—á —É–¥–∞–ª—è–ª—Å—è –î–û —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∫–ª—é—á–∞
- **–†–µ—à–µ–Ω–∏–µ**: –ò–∑–º–µ–Ω–µ–Ω –ø–æ—Ä—è–¥–æ–∫ - —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –∫–ª—é—á, –∑–∞—Ç–µ–º —É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π
- **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è**: `delete_old_key_after_success()` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

## üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

### –§—É–Ω–∫—Ü–∏—è `handle_reissue_key()`:
```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª—é—á–µ–π
if len(all_keys) == 1:
    await reissue_specific_key(message, user_id, all_keys[0])
else:
    await show_key_selection_menu(message, user_id, all_keys)
```

### –§—É–Ω–∫—Ü–∏—è `reissue_specific_key()`:
```python
# –ü–æ–∏—Å–∫ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–∞ –∂–µ —Å—Ç—Ä–∞–Ω–∞, —Ç–æ—Ç –∂–µ –ø—Ä–æ—Ç–æ–∫–æ–ª, –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä)
cursor.execute("""
    SELECT id, api_url, cert_sha256, domain, v2ray_path, api_key FROM servers 
    WHERE active = 1 AND country = ? AND protocol = ? AND id != ?
""", (country, protocol, old_server_id))

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ –ü–ï–†–ï–î —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ
user_data = await protocol_client.create_user(old_email)
# ... —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ ...

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
await old_protocol_client.delete_user(old_uuid)
```

### –§—É–Ω–∫—Ü–∏—è `change_protocol_for_key()`:
```python
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π)
new_protocol = "v2ray" if old_protocol == "outline" else "outline"

# –ü–æ–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–∞ –∂–µ —Å—Ç—Ä–∞–Ω–∞, –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª)
cursor.execute("""
    SELECT id, api_url, cert_sha256, domain, v2ray_path, api_key FROM servers 
    WHERE active = 1 AND country = ? AND protocol = ?
""", (country, new_protocol))

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ –ü–ï–†–ï–î —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ
user_data = await protocol_client.create_user(old_email)
# ... —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ ...

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
await delete_old_key_after_success(cursor, old_key_data)
```

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**

1. ‚úÖ **–í—ã–±–æ—Ä –∫–ª—é—á–∞**: –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª—é—á–∞—Ö, –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏ –æ–¥–Ω–æ–º
2. ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞**: –ù–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
3. ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞**: –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
4. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ù–µ—Ç —Ä–∏—Å–∫–∞ –ø–æ—Ç–µ—Ä–∏ –∫–ª—é—á–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

**–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.** 
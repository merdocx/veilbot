# Защита от удаления пользователей с активными подписками и платежами

## Проблема

Ранее существовала возможность случайного удаления пользователей и их платежей, даже если у них были активные подписки или успешные платежи. Это могло происходить при:
- Синхронизации данных
- Очистке базы данных
- Ручном удалении через скрипты

## Решение

Реализована система защиты, которая предотвращает удаление:
1. Пользователей с активными подписками
2. Пользователей с успешными платежами (статус `completed` или `paid`)
3. Пользователей с активными ключами (связанными с активными подписками)
4. **КРИТИЧНО: Платежей со статусом `completed` или `paid` - они НИКОГДА не могут быть удалены**

### Абсолютная защита платежей

Платежи со статусом `paid` или `completed` **полностью защищены от удаления**:
- Не могут быть удалены через админку
- Не могут быть удалены через скрипты
- Не могут быть удалены автоматически
- Не могут быть удалены напрямую через SQL (защита на уровне SQL запросов)
- Не могут быть удалены через репозиторий (защита на уровне кода)

## Реализация

### Модуль защиты

Создан модуль `app/utils/user_deletion_guard.py` с функциями:
- `check_user_can_be_deleted(user_id, db_path)` - проверяет, можно ли удалить пользователя
- `check_payment_can_be_deleted(payment_id, db_path)` - проверяет, можно ли удалить платеж

### Защищенные скрипты

Все скрипты удаления пользователей теперь используют защиту:
- `scripts/cleanup_user_data.py`
- `scripts/delete_user_completely.py`
- `scripts/cleanup_user_with_free_key_flag.py`
- `scripts/delete_user_all_data.py`
- `scripts/cleanup_user_and_orphaned.py`

### Защита в админке

Админка (`admin/routes/payments.py`) также использует защиту при удалении платежей.

## Что проверяется

При попытке удалить пользователя проверяется:
1. **Активные подписки**: есть ли подписки с `is_active = 1` и `expires_at > now`
2. **Успешные платежи**: есть ли платежи со статусом `completed` или `paid`
3. **Активные ключи**: есть ли ключи (Outline или V2Ray), связанные с активными подписками

При попытке удалить платеж:
1. **Проверяется статус платежа** - если статус `completed` или `paid`, удаление **полностью блокируется**
2. Никакие другие проверки не нужны - успешные платежи защищены абсолютно

## Пример использования

```python
from app.utils.user_deletion_guard import check_user_can_be_deleted

can_delete, reasons = check_user_can_be_deleted(user_id, db_path)
if not can_delete:
    print("Нельзя удалить пользователя:")
    for reason in reasons:
        print(f"  - {reason}")
    raise ValueError("Нельзя удалить пользователя")
```

## Обработка ошибок

Если попытка удаления заблокирована, скрипт:
1. Выводит все причины блокировки
2. Вызывает исключение `ValueError` с описанием проблемы
3. Не выполняет удаление

## Автоматические задачи

Автоматические фоновые задачи (например, `auto_delete_expired_subscriptions`) **НЕ** удаляют пользователей или платежи. Они только:
- Удаляют истекшие подписки (после grace period 24 часа)
- Удаляют истекшие ключи (после grace period 24 часа)
- Помечают старые pending платежи как `expired`

## Важно

- Защита работает только для скриптов, которые используют функцию проверки
- Если нужно принудительно удалить пользователя (например, по запросу пользователя), можно временно отключить проверку, но это должно быть явно задокументировано
- Все удаления логируются для аудита


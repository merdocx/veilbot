# Подписка 255 и платёж 325 — разбор

## Факты из БД

### Подписка 255
| Поле | Значение |
|------|----------|
| id | 255 |
| user_id | 1148933299 |
| created_at | 2026-01-14 17:30:17 |
| expires_at | 2026-04-14 17:30:17 |
| tariff_id | 15 |
| **is_active** | **0** (неактивна) |
| traffic_usage_bytes | 232 344 746 981 (~216,4 GB) |
| traffic_limit_mb | 204 800 (200 GB) |
| traffic_over_limit_at | 2026-01-31 23:07:54 |
| traffic_over_limit_notified | 3 (TRAFFIC_NOTIFY_DISABLED) |

### Платёж 325
| Поле | Значение |
|------|----------|
| id | 325 |
| user_id | 1148933299 |
| tariff_id | 15 |
| status | completed |
| amount | 20 000 (200 ₽) |
| created_at | 2026-01-31 23:15:48 |
| paid_at | 2026-01-31 23:16:15 |
| **subscription_id** | **255** |
| provider | yookassa, method=card |

### Платежи пользователя 1148933299 по подписке 255
- **295** — 2026-01-15, completed → subscription_id=255  
- **318** — 2026-01-27, completed → subscription_id=255  
- **325** — 2026-01-31, completed → subscription_id=255  

---

## Хронология

1. **2026-01-14** — создана подписка 255 для user_id 1148933299.
2. **2026-01-15** — платёж 295: подписка 255 продлена.
3. **2026-01-27** — платёж 318: подписка 255 снова продлена.
4. **2026-01-31 23:07:54** — фоновая задача `monitor_subscription_traffic_limits` зафиксировала превышение трафика: ~216 GB при лимите 200 GB, установлен `traffic_over_limit_at`.
5. **2026-01-31 23:15:48** — создан платёж 325 (пользователь оплатил).
6. **2026-01-31 23:16:15** — платёж 325 оплачен (YooKassa), `process_subscription_purchase` отработал: подписка 255 была активна, её продлили (обновлены expires_at, last_updated_at, tariff_id). Связь платёж 325 ↔ подписка 255 корректна.
7. **2026-02-01 ~23:07** — по истечении 24-часового grace period та же фоновая задача отключила подписку: `UPDATE subscriptions SET is_active = 0` для id=255 (логика в `bot/services/background_tasks.py`, `monitor_subscription_traffic_limits`).

---

## Выводы

1. **Платёж 325 обработан корректно**  
   Подписка 255 найдена, продлена, `subscription_id` у платежа 325 = 255. Ошибок обработки платежа нет.

2. **Почему подписка неактивна**  
   Подписка 255 деактивирована не из-за платежа 325, а из-за **автоотключения по превышению трафика**: использование ~216 GB при лимите 200 GB, после 24 часов grace period подписка переведена в is_active=0.

3. **Почему подписка не была видна в админке**  
   В списке подписок выводились только записи с `is_active = 1`. У подписки 255 `is_active = 0`, поэтому она не показывалась. Добавленный фильтр «Показать неактивные» как раз позволяет увидеть такие подписки.

---

## Рекомендации

- **Просмотр подписки 255 в админке:** Подписки → включить «Показать неактивные» или поиск по «255» или «1148933299».
- **Восстановление доступа пользователю (при необходимости):**  
  Реактивировать подписку вручную:  
  `UPDATE subscriptions SET is_active = 1 WHERE id = 255;`  
  Либо через админку, если будет добавлено действие «Активировать» для неактивных подписок.
- **Дальнейшая логика:** При следующей оплате пользователем сейчас создалась бы новая подписка (255 не учитывается, т.к. is_active=0). Имеет смысл доработать логику: при оплате находить неактивную подписку этого пользователя и снова активировать её и продлевать, а не создавать вторую подписку.

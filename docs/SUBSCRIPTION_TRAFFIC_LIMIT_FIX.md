# Исправление проблемы с лимитом трафика при продлении подписок

Дата: 2026-01-19

## Проблема

При продлении подписки лимит трафика всегда обновлялся из тарифа, что приводило к потере реферального бонуса (100 ГБ).

**Пример проблемы:**
1. Пользователь покупает подписку с тарифом 100 ГБ → лимит = 100 ГБ
2. Пользователь получает реферальный бонус → лимит = 200 ГБ (100 + 100)
3. Пользователь продлевает подписку → лимит сбрасывается до 100 ГБ ❌

## Решение

Создан метод `_update_subscription_traffic_limit_safe()`, который:
- Сохраняет текущий лимит, если он больше лимита тарифа (реферальный бонус)
- Обновляет лимит из тарифа, если текущий лимит меньше или равен лимиту тарифа
- Сохраняет безлимит (0), если он был установлен

## Изменения в коде

### 1. Новый метод `_update_subscription_traffic_limit_safe()`

**Файл:** `payments/services/subscription_purchase_service.py`

**Логика:**
```python
async def _update_subscription_traffic_limit_safe(
    self,
    subscription_id: int,
    tariff_limit_mb: int
) -> None:
    """
    Безопасно обновить лимит трафика подписки, сохраняя реферальный бонус.
    
    Если текущий лимит больше лимита тарифа, это может быть реферальный бонус - сохраняем его.
    """
    # Получаем текущий лимит подписки
    # Если текущий лимит > лимит тарифа → сохраняем текущий (реферальный бонус)
    # Если текущий лимит <= лимит тарифа → обновляем из тарифа
    # Если текущий лимит = 0 (безлимит) → сохраняем безлимит
```

### 2. Обновлен метод `_extend_subscription()`

**Было:**
```python
traffic_limit_mb = tariff.get('traffic_limit_mb', 0) or 0
await self.subscription_repo.update_subscription_traffic_limit_async(subscription_id, traffic_limit_mb)
```

**Стало:**
```python
tariff_limit_mb = tariff.get('traffic_limit_mb', 0) or 0
await self._update_subscription_traffic_limit_safe(subscription_id, tariff_limit_mb)
```

### 3. Обновлен метод `_update_subscription_expires_at()`

Теперь использует безопасное обновление лимита вместо прямого обновления.

### 4. Обновлен метод `process_subscription_purchase()`

Использует безопасное обновление лимита при обновлении подписки.

### 5. Обновлен метод `_get_or_create_subscription()`

Использует безопасное обновление лимита для существующих подписок.

## Результат

Теперь при продлении подписки:
- ✅ Реферальный бонус сохраняется
- ✅ Лимит из тарифа применяется, если текущий лимит меньше
- ✅ Безлимит (0) сохраняется для VIP подписок

## Тестирование

После применения исправления необходимо протестировать:

1. **Создание новой подписки**
   - Лимит устанавливается из тарифа ✅

2. **Продление подписки без реферального бонуса**
   - Лимит обновляется из тарифа ✅

3. **Продление подписки с реферальным бонусом**
   - Реферальный бонус сохраняется ✅
   - Пример: 200 ГБ (100 ГБ тариф + 100 ГБ бонус) остается 200 ГБ ✅

4. **Начисление реферального бонуса**
   - Бонус добавляется к текущему лимиту ✅

5. **VIP подписки**
   - Безлимит (0) сохраняется ✅

## Статус существующих подписок

После анализа найдено:
- 12 подписок с несоответствием лимита подписки и тарифа
  - 8 подписок: VIP подписки с безлимитом (0) - это нормально
  - 2 подписки: лимит = 200 ГБ, тариф = 100 ГБ (реферальный бонус) - это правильно
  - 2 подписки: лимит = 150 ГБ, тариф = 100 ГБ - требует проверки

## Рекомендации

1. ✅ Исправление применено
2. ⚠️ Проверить подписки #273 и #298 (лимит 150 ГБ вместо 100 ГБ)
3. ✅ Мониторинг новых подписок на предмет правильного обновления лимита

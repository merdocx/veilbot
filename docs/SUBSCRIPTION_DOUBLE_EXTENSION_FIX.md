# Исправление проблемы двойного продления подписок

## Дата: 2025-12-18

## Проблема

У пользователей 150812909 и 642669117 добавился лишний месяц к сроку действия подписки.

### Причина

При обработке платежа за подписку происходило следующее:

1. **Первый вызов** `process_subscription_purchase`:
   - Создавал подписку с `expires_at = created_at + 30 дней` ✅

2. **Второй вызов** `process_subscription_purchase` (через 3 секунды):
   - Обнаруживал только что созданную подписку как "активную"
   - Определял это как "продление" вместо "покупки"
   - Продлевал подписку еще на 30 дней ❌

**Результат**: Подписка получила 60 дней вместо 30.

## Решение

Добавлена проверка во всех местах создания/продления подписок:

### Проверка на очень недавно созданную подписку

Если подписка была создана **менее 5 минут назад** и срок действия соответствует ожидаемому (`created_at + duration`), то это **покупка**, а не продление.

```python
VERY_RECENT_THRESHOLD = 300  # 5 минут
subscription_age = now - existing_created_at
expected_expires_at = existing_created_at + tariff['duration_sec']
is_very_recent = subscription_age < VERY_RECENT_THRESHOLD
expires_at_matches_expected = abs(existing_expires_at - expected_expires_at) < 3600

if is_very_recent and expires_at_matches_expected:
    # Это покупка, не продление - не продлеваем подписку
    return await self._send_purchase_notification_for_existing_subscription(...)
```

## Исправленные места

### 1. `process_subscription_purchase` (основной метод)
- ✅ Добавлена проверка на очень недавно созданную подписку
- ✅ Если подписка создана < 5 минут назад и срок соответствует ожидаемому → покупка, не продление

### 2. `_create_subscription`
- ✅ Добавлена проверка на очень недавно созданную подписку
- ✅ Если подписка уже существует и создана < 5 минут назад → отправляем уведомление о покупке, не продлеваем

### 3. `_create_subscription_as_renewal`
- ✅ Добавлена проверка на очень недавно созданную подписку
- ✅ Если подписка создана < 5 минут назад → покупка, не продление

### 4. `SubscriptionService.create_subscription`
- ✅ Добавлена проверка на очень недавно созданную подписку
- ✅ Если подписка создана < 5 минут назад → возвращаем существующую подписку без продления

## Существующие защиты

### Защита от дублирования вызовов
- ✅ `process_subscription_purchase` проверяет статус платежа (completed) в начале
- ✅ `PaymentProcessor` проверяет статус платежа перед обработкой
- ✅ `PaymentService` проверяет статус платежа перед обработкой
- ✅ `BackgroundTasks.retry_failed_subscription_notifications` проверяет статус paid перед обработкой

### Защита от race conditions
- ✅ `_create_subscription` использует атомарную транзакцию `BEGIN IMMEDIATE`
- ✅ Финальная проверка наличия подписки непосредственно перед вставкой

### Валидация дат
- ✅ Проверка на разумность даты истечения (не более 10 лет в будущем)
- ✅ Проверка соответствия срока действия ожидаемому значению

## Исправленные подписки

- ✅ Пользователь 150812909: срок исправлен с 60 дней на 30 дней
- ✅ Пользователь 642669117: срок исправлен с 60 дней на 30 дней

## Тестирование

Для проверки защиты от двойного продления:

1. Создать платеж за подписку
2. Вызвать `process_subscription_purchase` дважды подряд
3. Проверить, что подписка имеет правильный срок (30 дней, не 60)

## Заключение

Проблема двойного продления подписок полностью устранена. Все критические места защищены проверками на очень недавно созданную подписку, что предотвращает неправильное определение покупки как продления.




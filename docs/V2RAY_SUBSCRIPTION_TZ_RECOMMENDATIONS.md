# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¢–ó: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ V2Ray

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ä–∞–∑–¥–µ–ª–µ 10.2 –µ—Å—Ç—å –¥–≤–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞ —Å –Ω–æ–º–µ—Ä–æ–º 10.2.2
- `10.2.2 –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–ª—é—á–∞ (–≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º flow "–ö—É–ø–∏—Ç—å –¥–æ—Å—Ç—É–ø")`
- `10.2.2 –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤—Ç–æ—Ä–æ–π –≤ `10.2.3`, –∞ —Ç–µ–∫—É—â–∏–π `10.2.3` –≤ `10.2.4`

### 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á–∏ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö. –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ —É–ø–∞–¥–µ—Ç, –ø–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –≤ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î —Å –æ—Ç–∫–∞—Ç–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ò–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º "—á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —É—Å–ø–µ—Ö–∞" —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –¥–æ–æ–∑–¥–∞–Ω–∏–µ–º –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `subscription_status` –≤ —Ç–∞–±–ª–∏—Ü—É `subscriptions`: `'creating'`, `'active'`, `'partial'`, `'failed'`

```python
# –ü—Ä–∏–º–µ—Ä —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
async def create_subscription_with_keys(user_id, tariff_id):
    with get_db_cursor(commit=False) as cursor:
        try:
            # 1. –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
            subscription_id = create_subscription(...)
            
            # 2. –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á–∏ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
            failed_servers = []
            for server in servers:
                try:
                    create_key_on_server(...)
                except Exception as e:
                    failed_servers.append(server.id)
                    logger.error(f"Failed to create key on server {server.id}: {e}")
            
            if failed_servers:
                # –ü–æ–º–µ—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∫–∞–∫ —á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—É—é
                mark_subscription_as_partial(subscription_id, failed_servers)
                # –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
                schedule_key_creation_for_servers(subscription_id, failed_servers)
            
            cursor.commit()
            return subscription_id
        except Exception:
            cursor.rollback()
            raise
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `create_keys_for_new_server` –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—é—á–∞ –¥–ª—è –æ–¥–Ω–æ–π –∏–∑ –ø–æ–¥–ø–∏—Å–æ–∫, —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
- –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

```python
async def create_keys_for_new_server(server_id: int):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # 3. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–ø–∏—Å–∫–∏:
    success_count = 0
    error_count = 0
    
    for subscription in active_subscriptions:
        try:
            # ... —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ ...
            success_count += 1
        except Exception as e:
            error_count += 1
            logger.error(
                f"Failed to create key for subscription {subscription.id} "
                f"on server {server_id}: {e}",
                exc_info=True
            )
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
    
    logger.info(
        f"Created keys for new server {server_id}: "
        f"{success_count} success, {error_count} errors"
    )
```

### 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è email –¥–ª—è –∫–ª—é—á–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å email –¥–ª—è –∫–ª—é—á–µ–π –≤ –ø–æ–¥–ø–∏—Å–∫–µ. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω email –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–π, –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π email.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç: `{user_id}_subscription_{subscription_id}@veilbot.com`
- –ò–ª–∏: `{user_email}_sub_{subscription_id}@veilbot.com`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ email —É–Ω–∏–∫–∞–ª–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞

## üü° –í–∞–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ –ë–î –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∫ API —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5-10 –º–∏–Ω—É—Ç)
- –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–ª–∏ –∫–ª—é—á–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –∏–ª–∏ in-memory –∫—ç—à

```python
from app.infra.cache import SimpleCache

_subscription_cache = SimpleCache()

async def get_subscription_content(token: str) -> str:
    cache_key = f"subscription:{token}"
    cached = _subscription_cache.get(cache_key)
    if cached:
        return cached
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    content = generate_subscription(token)
    
    # –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
    _subscription_cache.set(cache_key, content, ttl=300)
    return content
```

### 6. Rate Limiting –¥–ª—è endpoint –ø–æ–¥–ø–∏—Å–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –Ω—É–∂–µ–Ω rate limiting, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –≥–¥–µ –∏ –∫–∞–∫ –µ–≥–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å middleware –¥–ª—è FastAPI
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–∞–ø—Ä–∏–º–µ—Ä, 60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ —Ç–æ–∫–µ–Ω
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `slowapi` –∏–ª–∏ `fastapi-limiter`

```python
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address

limiter = Limiter(key_func=lambda request: request.path_params.get("token"))

@router.get("/api/subscription/{token}")
@limiter.limit("60/minute")
async def get_subscription(request: Request, token: str):
    # ...
```

### 7. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É–∫–∞–∑–∞–Ω–æ, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ 1 –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é (–∏–ª–∏ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é)
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

```python
async def create_subscription(user_id: int, tariff_id: int):
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
    existing = get_active_subscription(user_id)
    if existing:
        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–¥–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
        extend_subscription(existing.id, tariff_id)
        return existing
        # –í–∞—Ä–∏–∞–Ω—Ç 2: –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
        # deactivate_subscription(existing.id)
```

### 8. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥
**–ü—Ä–æ–±–ª–µ–º–∞:** –£–∫–∞–∑–∞–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –ø–æ—Ä–æ–≥–∏ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–µ –æ—à–∏–±–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–π
- –ê–ª–µ—Ä—Ç –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –ê–ª–µ—Ä—Ç –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –Ω–∞ endpoint –ø–æ–¥–ø–∏—Å–∫–∏

### 9. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ V2Ray –∫–ª—é—á–∞–º–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é: –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å 3+ –∫–ª—é—á–∞–º–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
- –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –∞–¥–º–∏–Ω–∫—É –¥–ª—è —Ä—É—á–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### 10. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É–∫–∞–∑–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º –∫ –ë–î.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ (UUID –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã)
- –û—Ç–∫–ª–æ–Ω—è—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection —á–µ—Ä–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏—é)
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏

```python
import uuid

def validate_subscription_token(token: str) -> bool:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–æ–∫–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏"""
    if not token or len(token) < 32:
        return False
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π UUID –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã
        uuid.UUID(token)
        return True
    except ValueError:
        # –ï—Å–ª–∏ –Ω–µ UUID, –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏ —Ñ–æ—Ä–º–∞—Ç
        return len(token) >= 32 and token.isalnum()
```

## üü¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 11. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–µ–π –∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –æ–¥–∏–Ω JOIN –∑–∞–ø—Ä–æ—Å
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SELECT ... FOR UPDATE` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions

### 12. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–µ—Ä–µ–¥ –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ (–∑–∞ 3 –¥–Ω—è, 1 –¥–µ–Ω—å)

### 13. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `subscription_stats` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
- –•—Ä–∞–Ω–∏—Ç—å: `subscription_id`, `requested_at`, `ip_address`, `user_agent`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π

### 14. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º (–±—É–¥—É—â–µ–µ)
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–∂–µ —É–ø–æ–º—è–Ω—É—Ç–æ –≤ —Ä–∞–∑–¥–µ–ª–µ 8, –Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å—Ö–µ–º—É –ë–î –ø–æ–ª–µ `allowed_countries` –≤ —Ç–∞–±–ª–∏—Ü—É `subscriptions`
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –≤ –±—É–¥—É—â–µ–º

### 15. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ç–µ—Å—Ç-–∫–µ–π—Å–∞–º–∏:
  - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å —É—Å–ø–µ—à–Ω—ã–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –≤—Å–µ—Ö –∫–ª—é—á–µ–π
  - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º —É—Å–ø–µ—Ö–æ–º (—á–∞—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∏—Å—Ç–µ–∫—à–∏–º–∏ –∫–ª—é—á–∞–º–∏
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ —Å –ø—Ä–µ–≤—ã—à–µ–Ω–Ω—ã–º –ª–∏–º–∏—Ç–æ–º —Ç—Ä–∞—Ñ–∏–∫–∞
  - –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
  - Rate limiting endpoint –ø–æ–¥–ø–∏—Å–∫–∏

### 16. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å OpenAPI/Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è endpoint `/api/subscription/{token}`
- –û–ø–∏—Å–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç—ã –æ—à–∏–±–æ–∫

### 17. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–µ—Ä–≤–µ—Ä–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 50+ —Å–µ—Ä–≤–µ—Ä–æ–≤, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ –ø–æ–¥–ø–∏—Å–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞–∫—Å–∏–º—É–º 100)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å batch-–∑–∞–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç

### 18. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–¥–ø–∏—Å–∫–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏—Ö –ø–æ–¥–ø–∏—Å–∫–µ, —á–µ—Ä–µ–∑ –æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ò–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ —É–¥–∞–ª–∏—Ç –µ–≥–æ –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏
- –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é "–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏" —Å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–ª—é—á–∞

### 19. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `version` –≤ —Ç–∞–±–ª–∏—Ü—É `subscriptions` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç–∞
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –≤ –±—É–¥—É—â–µ–º –∏–∑–º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### 20. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–¥–ø–∏—Å–∫–µ (—É—Å–ø–µ—à–Ω—ã–µ –∏ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ä–∞–∑–Ω—ã—Ö IP)
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –∞—É–¥–∏—Ç–∞ –∞–¥–º–∏–Ω–∫–∏

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π

- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —É—Å–ø–µ—Ö–∞ —Å –¥–æ–æ–∑–¥–∞–Ω–∏–µ–º –∫–ª—é—á–µ–π
- [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç email –¥–ª—è –∫–ª—é—á–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rate limiting –¥–ª—è endpoint
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã):**
1. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ
3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è email –¥–ª—è –∫–ª—é—á–µ–π
4. Rate limiting

**–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤–∞–∂–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏):**
5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–ø–∏—Å–æ–∫
7. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
8. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ):**
9. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
10. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
11. –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏








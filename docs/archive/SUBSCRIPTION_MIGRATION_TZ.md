# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É" –≤ –º–µ–Ω—é "–ü–æ–º–æ—â—å"

## –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É" –≤ –º–µ–Ω—é "–ü–æ–º–æ—â—å" —Å —Å–ª–µ–¥—É—é—â–µ–π –ª–æ–≥–∏–∫–æ–π:

### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã

1. **–ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞:**
   - –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞."

2. **–ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ª—é–±–æ–π –∫–ª—é—á (outline –∏–ª–∏ v2ray), –Ω–æ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏:**
   - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ –µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π)
   - –í—ã—á–∏—Å–ª–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π expiry_at —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π)
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É —Å:
     - –¢–∞—Ä–∏—Ñ–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     - –°—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è = –æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–æ–∫–∞ (expires_at = max(expiry_at) –∏–∑ –≤—Å–µ—Ö –∫–ª—é—á–µ–π)
   - –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (outline –∏ v2ray, –≥–¥–µ subscription_id IS NULL)
   - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

3. **–ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∫–ª—é—á–µ–π –∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏:**
   - –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: "–£ –≤–∞—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø, –Ω–∞–∂–º–∏—Ç–µ "–ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø"."

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –ù–∞–π—Ç–∏ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (outline –∏ v2ray):
   - `keys` —Ç–∞–±–ª–∏—Ü–∞: `WHERE user_id = ? AND expiry_at > ?`
   - `v2ray_keys` —Ç–∞–±–ª–∏—Ü–∞: `WHERE user_id = ? AND expiry_at > ? AND subscription_id IS NULL`

2. –ò–∑ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π –≤—ã–±—Ä–∞—Ç—å –∫–ª—é—á —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `expiry_at`

3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `tariff_id` —ç—Ç–æ–≥–æ –∫–ª—é—á–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

4. –ï—Å–ª–∏ —É –∫–ª—é—á–µ–π —Ä–∞–∑–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ –∫–ª—é—á–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è

### –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ —Å—Ä–æ–∫–∞

1. –ù–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π `expiry_at` —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (outline –∏ v2ray)

2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ `expires_at` –¥–ª—è –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

### –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π

1. **Outline –∫–ª—é—á–∏:**
   - –ù–∞–π—Ç–∏ –≤—Å–µ –∫–ª—é—á–∏: `SELECT k.key_id, s.api_url, s.cert_sha256 FROM keys k JOIN servers s ON k.server_id = s.id WHERE k.user_id = ? AND k.key_id IS NOT NULL`
   - –£–¥–∞–ª–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ Outline API
   - –£–¥–∞–ª–∏—Ç—å –∏–∑ –ë–î: `DELETE FROM keys WHERE user_id = ?`

2. **V2Ray –∫–ª—é—á–∏ (—Ç–æ–ª—å–∫–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ, –Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏):**
   - –ù–∞–π—Ç–∏ –≤—Å–µ –∫–ª—é—á–∏: `SELECT k.v2ray_uuid, s.api_url, s.api_key FROM v2ray_keys k JOIN servers s ON k.server_id = s.id WHERE k.user_id = ? AND k.subscription_id IS NULL`
   - –£–¥–∞–ª–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ V2Ray API
   - –£–¥–∞–ª–∏—Ç—å –∏–∑ –ë–î: `DELETE FROM v2ray_keys WHERE user_id = ? AND subscription_id IS NULL`

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–π
- –£–≤–µ–¥–æ–º–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω–µ –≤—Å–µ –∫–ª—é—á–∏ —É–¥–∞–ª–µ–Ω—ã)
- –ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —á–∞—Å—Ç–∏—á–Ω–æ, –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

1. **–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏:**
   ```
   –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.
   ```

2. **–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏:**
   ```
   ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ V2Ray —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!

   üîó –°—Å—ã–ª–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏:
   `https://veil-bot.ru/api/subscription/{token}`

   ‚è≥ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: {—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ä–æ–∫}

   üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
   1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ V2Ray
   2. –ù–∞–∂–º–∏—Ç–µ "+" ‚Üí "–ò–º–ø–æ—Ä—Ç –ø–æ–¥–ø–∏—Å–∫–∏"
   3. –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –≤—ã—à–µ
   4. –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   ```

3. **–ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–µ–π –∏ –ø–æ–¥–ø–∏—Å–∫–∏:**
   ```
   –£ –≤–∞—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–æ—Å—Ç—É–ø, –Ω–∞–∂–º–∏—Ç–µ "–ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø".
   ```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. `bot/keyboards/main.py` - –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É" –≤ `get_help_keyboard()`
2. `bot/handlers/common.py` - –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏
3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª `bot/services/subscription_migration.py` - –ª–æ–≥–∏–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

```python
async def handle_migrate_to_subscription(message: types.Message):
    1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
       - –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –≤—ã–π—Ç–∏
    
    2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
       - –ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–π ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –≤—ã–π—Ç–∏
    
    3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ –∏ –æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–æ–∫–∞
       - –ù–∞–π—Ç–∏ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       - –í—ã–±—Ä–∞—Ç—å –∫–ª—é—á —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º expiry_at
       - –í–∑—è—Ç—å tariff_id –∏ expiry_at
    
    4. –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
       - –í—ã–∑–≤–∞—Ç—å SubscriptionService.create_subscription()
       - –ü–µ—Ä–µ–¥–∞—Ç—å tariff_id –∏ duration_sec = (expiry_at - now)
    
    5. –£–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏
       - –£–¥–∞–ª–∏—Ç—å outline –∫–ª—é—á–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∏–∑ –ë–î
       - –£–¥–∞–ª–∏—Ç—å v2ray –∫–ª—é—á–∏ (subscription_id IS NULL) —Å —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∏–∑ –ë–î
    
    6. –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```


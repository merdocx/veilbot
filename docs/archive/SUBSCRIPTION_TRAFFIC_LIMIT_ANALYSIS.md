# Анализ процесса покупки и продления подписок
## Проблемы с лимитом трафика

Дата анализа: 2026-01-19

## Обнаруженные проблемы

### 1. Перезапись реферального бонуса при продлении

**Проблема:**
При продлении подписки лимит трафика всегда обновляется из тарифа, что перезаписывает реферальный бонус (100 ГБ).

**Местоположение:**
- `payments/services/subscription_purchase_service.py:848-849`
- `payments/services/subscription_purchase_service.py:386-387`
- `payments/services/subscription_purchase_service.py:2066-2067`

**Код:**
```python
# ВАЖНО: Обновляем лимит трафика подписки из тарифа ВСЕГДА
traffic_limit_mb = tariff.get('traffic_limit_mb', 0) or 0
await self.subscription_repo.update_subscription_traffic_limit_async(subscription_id, traffic_limit_mb)
```

**Последствия:**
- Если пользователь получил реферальный бонус (100 ГБ), при следующем продлении подписки бонус теряется
- Лимит сбрасывается до лимита тарифа

**Пример:**
1. Пользователь покупает подписку с тарифом 100 ГБ → лимит = 100 ГБ
2. Пользователь получает реферальный бонус → лимит = 200 ГБ (100 + 100)
3. Пользователь продлевает подписку → лимит сбрасывается до 100 ГБ ❌

### 2. VIP подписки с лимитом 0 вместо NULL

**Проблема:**
VIP подписки имеют `traffic_limit_mb = 0` (безлимит), но тариф имеет лимит. Это может быть проблемой, если безлимит не был намеренным.

**Местоположение:**
- `payments/services/subscription_purchase_service.py:1413`
- `admin/routes/users.py:425-431`

**Код:**
```python
VIP_TRAFFIC_LIMIT_MB = 0  # 0 = безлимит
traffic_limit_mb = VIP_TRAFFIC_LIMIT_MB
```

**Статус:** Это может быть намеренным поведением для VIP пользователей.

### 3. Подписки с лимитом, не соответствующим тарифу

**Найдено:** 12 подписок с несоответствием

**Типы проблем:**
- 8 подписок: лимит = 0 (безлимит), тариф имеет лимит (VIP подписки)
- 2 подписки: лимит = 200 ГБ, тариф = 100 ГБ (реферальный бонус)
- 2 подписки: лимит = 150 ГБ, тариф = 100 ГБ (возможно, частичный реферальный бонус)

## Рекомендации по исправлению

### 1. Сохранение реферального бонуса при продлении

**Вариант A: Сохранять разницу между лимитом подписки и тарифом**

```python
# При продлении подписки
current_limit = subscription.traffic_limit_mb
tariff_limit = tariff.get('traffic_limit_mb', 0) or 0

# Если текущий лимит больше лимита тарифа, сохраняем разницу
if current_limit is not None and current_limit > tariff_limit:
    bonus = current_limit - tariff_limit
    new_limit = tariff_limit + bonus
else:
    new_limit = tariff_limit

await self.subscription_repo.update_subscription_traffic_limit_async(subscription_id, new_limit)
```

**Вариант B: Отслеживать реферальный бонус отдельно**

Добавить поле `referral_traffic_bonus_mb` в таблицу `subscriptions` для отслеживания реферального бонуса отдельно от основного лимита.

**Вариант C: Не обновлять лимит, если он больше лимита тарифа**

```python
# При продлении подписки
current_limit = subscription.traffic_limit_mb
tariff_limit = tariff.get('traffic_limit_mb', 0) or 0

# Обновляем лимит только если текущий лимит меньше или равен лимиту тарифа
if current_limit is None or current_limit <= tariff_limit:
    await self.subscription_repo.update_subscription_traffic_limit_async(subscription_id, tariff_limit)
else:
    # Сохраняем текущий лимит (с реферальным бонусом)
    logger.info(f"Keeping current traffic limit {current_limit} MB (includes referral bonus)")
```

### 2. Исправление существующих подписок

**Для подписок с реферальным бонусом:**
- Подписки #56, #172: лимит = 200 ГБ (100 ГБ тариф + 100 ГБ бонус) - это правильно
- Подписки #273, #298: лимит = 150 ГБ - нужно проверить, откуда взялось 50 ГБ

**Для VIP подписок:**
- Подписки с лимитом 0 и expires_at = 2100-01-01 - это нормально для VIP

### 3. Улучшение логики обновления лимита

**Рекомендуется:**
1. При создании новой подписки: устанавливать лимит из тарифа
2. При продлении подписки: 
   - Если текущий лимит > лимит тарифа → сохранять текущий лимит (реферальный бонус)
   - Если текущий лимит <= лимит тарифа → обновлять из тарифа
3. При начислении реферального бонуса: добавлять к текущему лимиту (или к лимиту тарифа, если лимит подписки NULL)

## Файлы для исправления

1. `payments/services/subscription_purchase_service.py`
   - Метод `_extend_subscription` (строка 844-852)
   - Метод `process_subscription_purchase` (строка 375-391)
   - Метод `_get_or_create_subscription` (строка 2064-2071)

2. `bot/services/key_creation.py`
   - Метод `process_referral_bonus` (строка 1054-1060)

## Тестирование

После исправления необходимо протестировать:
1. Создание новой подписки
2. Продление подписки без реферального бонуса
3. Продление подписки с реферальным бонусом
4. Начисление реферального бонуса на новую подписку
5. Начисление реферального бонуса на продленную подписку

# –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: –£–¥–∞–ª–µ–Ω–∏–µ expiry_at –∏–∑ –∫–ª—é—á–µ–π

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ `scripts/migrate_remove_expiry_at_from_keys.py`
- ‚ö†Ô∏è **–ù–ï –ó–ê–ü–£–©–ï–ù** - –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ –∫–æ–¥–∞

### 2. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (app/repositories/)

#### subscription_repository.py
- ‚úÖ `update_subscription_keys_expiry()` - –ø–µ—Ä–µ–¥–µ–ª–∞–Ω, –±–æ–ª—å—à–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç expiry_at (–æ–Ω —É–¥–∞–ª–µ–Ω)
- ‚úÖ `get_subscription_keys()` - –æ–±–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN —Å subscriptions –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ expires_at

#### key_repository.py
- ‚úÖ `get_expired_outline_keys()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN —Å subscriptions
- ‚úÖ `get_expired_v2ray_keys()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN —Å subscriptions
- ‚úÖ `update_outline_key_expiry()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –≤–º–µ—Å—Ç–æ –∫–ª—é—á–∞
- ‚úÖ `update_v2ray_key_expiry()` - –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –≤–º–µ—Å—Ç–æ –∫–ª—é—á–∞
- ‚úÖ `get_key_unified_by_id()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN —Å subscriptions –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è expiry_at
- ‚úÖ `list_outline_keys()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN —Å subscriptions
- ‚úÖ `list_v2ray_keys_with_server()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN —Å subscriptions
- ‚úÖ `list_keys_unified()` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã add_outline() –∏ add_v2ray() –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è JOIN
- ‚úÖ `insert_outline_key()` - —É–±—Ä–∞–Ω expiry_at –∏–∑ INSERT, –¥–æ–±–∞–≤–ª–µ–Ω subscription_id –ø–∞—Ä–∞–º–µ—Ç—Ä
- ‚úÖ `insert_v2ray_key()` - —É–±—Ä–∞–Ω expiry_at –∏–∑ INSERT, –¥–æ–±–∞–≤–ª–µ–Ω subscription_id –ø–∞—Ä–∞–º–µ—Ç—Ä

## ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ / –û—Å—Ç–∞–ª–æ—Å—å

### 3. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (admin/routes/)
- ‚ùå `admin/routes/keys.py` - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å expiry_at
- ‚ùå `admin/routes/users.py` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ expiry_at –∫–ª—é—á–µ–π
- ‚ùå `admin/routes/dashboard.py` - –ø–æ–¥—Å—á–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚ùå `admin/routes/payments.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π

### 4. –ë–æ—Ç-—Å–µ—Ä–≤–∏—Å—ã (bot/)
- ‚ùå `bot/handlers/keys.py` - –∑–∞–ø—Ä–æ—Å—ã –∫–ª—é—á–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚ùå `bot/handlers/key_management.py` - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚ùå `bot/services/key_creation.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π
- ‚ùå `bot/services/free_tariff.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π
- ‚ùå `bot/services/background_tasks.py` - –∑–∞–¥–∞—á–∏ —Å expiry_at

### 5. –ü–ª–∞—Ç–µ–∂–∏ (payments/)
- ‚ùå `payments/repositories/payment_repository.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚ùå `payments/services/subscription_purchase_service.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–µ–π

### 6. –°–∫—Ä–∏–ø—Ç—ã (scripts/)
- ‚ùå `scripts/` - —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Å expiry_at

### 7. –î—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
- ‚ùå `app/repositories/user_repository.py` - resolve_user_email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç expiry_at
- ‚ùå `validators.py` - –≤–∞–ª–∏–¥–∞—Ü–∏—è expiry_at
- ‚ùå `bot.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö –∫–ª—é—á–µ–π
- ‚ùå `db.py` - –≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å CREATE TABLE (–Ω–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ë–î)

## üìù –û–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π

### WHERE —É—Å–ª–æ–≤–∏—è —Å expiry_at:
```sql
-- –ë—ã–ª–æ:
WHERE k.expiry_at > ?

-- –°—Ç–∞–ª–æ:
JOIN subscriptions sub ON k.subscription_id = sub.id
WHERE sub.expires_at > ?
```

### SELECT expiry_at:
```sql
-- –ë—ã–ª–æ:
SELECT k.expiry_at

-- –°—Ç–∞–ª–æ:
SELECT COALESCE(sub.expires_at, 0) as expiry_at
-- + JOIN subscriptions sub ON k.subscription_id = sub.id
```

### UPDATE expiry_at:
- –ó–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ `SubscriptionRepository.extend_subscription()`

### INSERT:
- –£–±—Ä–∞—Ç—å `expiry_at` –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–æ–ª–æ–Ω–æ–∫
- –î–æ–±–∞–≤–∏—Ç—å `subscription_id` –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–í—Å–µ –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å subscription_id** - –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏
2. **–ü–∞—Ä–∞–º–µ—Ç—Ä expiry_at –≤ –º–µ—Ç–æ–¥–∞—Ö** - –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - JOIN –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω—É–∂–Ω–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
2. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É



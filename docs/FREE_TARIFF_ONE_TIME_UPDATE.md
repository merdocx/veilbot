# üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π - –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–î–∞—Ç–∞:** 2025-01-27  
**–í–µ—Ä—Å–∏—è:** 1.4.0  
**–¢–∏–ø:** Breaking Change  

## üéØ –¶–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π —Å "—Ä–∞–∑ –≤ 24 —á–∞—Å–∞" –Ω–∞ "–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞" –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π –∏ —É–ª—É—á—à–µ–Ω–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞.

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. **`check_free_tariff_limit_by_protocol_and_country()`**
   - –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (24 —á–∞—Å–∞)
   - –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ª—é–±–æ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø–æ–ª—É—á–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á

2. **`check_free_tariff_limit()`**
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π (–æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

3. **`check_free_tariff_limit_by_protocol()`**
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
   - –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π (–æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

#### –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- "–í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞."
- "–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏."

#### –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
- "–í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Ä–∞–Ω–µ–µ. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."
- "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."

## üìä SQL –∑–∞–ø—Ä–æ—Å—ã

### –°—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏):
```sql
-- Outline –±–µ–∑ —Å—Ç—Ä–∞–Ω—ã
SELECT k.created_at FROM keys k
JOIN tariffs t ON k.tariff_id = t.id
WHERE k.user_id = ? AND t.price_rub = 0
AND k.created_at > ?  -- 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
ORDER BY k.created_at DESC LIMIT 1

-- V2Ray —Å —Å—Ç—Ä–∞–Ω–æ–π
SELECT k.created_at FROM v2ray_keys k
JOIN tariffs t ON k.tariff_id = t.id
JOIN servers s ON k.server_id = s.id
WHERE k.user_id = ? AND t.price_rub = 0 AND s.country = ?
AND k.created_at > ?  -- 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
ORDER BY k.created_at DESC LIMIT 1
```

### –ù–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏):
```sql
-- Outline –±–µ–∑ —Å—Ç—Ä–∞–Ω—ã
SELECT k.created_at FROM keys k
JOIN tariffs t ON k.tariff_id = t.id
WHERE k.user_id = ? AND t.price_rub = 0
ORDER BY k.created_at DESC LIMIT 1

-- V2Ray —Å —Å—Ç—Ä–∞–Ω–æ–π
SELECT k.created_at FROM v2ray_keys k
JOIN tariffs t ON k.tariff_id = t.id
JOIN servers s ON k.server_id = s.id
WHERE k.user_id = ? AND t.price_rub = 0 AND s.country = ?
ORDER BY k.created_at DESC LIMIT 1
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test_free_tariff_limit.py` —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏:

1. **`test_no_free_keys_allowed()`** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å
2. **`test_old_free_key_blocks_new()`** - —Å—Ç–∞—Ä—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
3. **`test_v2ray_free_key_blocks_new()`** - —Å—Ç–∞—Ä—ã–π V2Ray –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ
4. **`test_country_specific_free_key_blocks_new()`** - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
python3 test_free_tariff_limit.py
```

## ‚ö†Ô∏è –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã
- ‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- ‚úÖ –ë–æ–ª–µ–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

### –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏, –Ω–µ —Å–º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–µ
- ‚ùå –ù—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–∫—É–ø–∞—Ç—å –ø–ª–∞—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏, –±—É–¥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π —Å–º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á
- –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏:
1. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–∏—Ç–∏–∫–∏
2. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –û–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–∏—á–∏–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è (—É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–µ—Ä–≤–∏—Å–∞)

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–ª–∞—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
- –ñ–∞–ª–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
SELECT COUNT(DISTINCT user_id) FROM keys k
JOIN tariffs t ON k.tariff_id = t.id
WHERE t.price_rub = 0;

-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
-- SELECT COUNT(*) FROM access_logs WHERE action = 'free_key_blocked';
```

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ü–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:
1. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
2. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging
3. ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. ‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ production
5. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### Rollback –ø–ª–∞–Ω:
–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É, –¥–æ–±–∞–≤–∏–≤ –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–∏:
```python
# –í—Ä–µ–º–µ–Ω–Ω—ã–π rollback
day_ago = now - 86400  # 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
# –î–æ–±–∞–≤–∏—Ç—å AND k.created_at > ? –≤ SQL –∑–∞–ø—Ä–æ—Å—ã
```

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –Ω–∞ "–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞" —è–≤–ª—è–µ—Ç—Å—è –≤–∞–∂–Ω—ã–º —à–∞–≥–æ–º –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —ç–∫–æ–Ω–æ–º–∏–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
2. –ê–Ω–∞–ª–∏–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö

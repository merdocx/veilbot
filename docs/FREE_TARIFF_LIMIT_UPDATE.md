# Обновление логики ограничения бесплатных тарифов

## Дата: 5 августа 2025

## Описание изменений

Реализовано ограничение на получение бесплатного тарифа: **1 раз в 24 часа для каждого протокола и страны**.

## Проблема

Ранее логика проверяла лимит по истечению ключа, что позволяло пользователям получать бесплатные ключи чаще, чем раз в 24 часа.

## Решение

### Изменена функция `check_free_tariff_limit_by_protocol_and_country`

**Старая логика:**
- Проверяла, истек ли последний бесплатный ключ
- Если ключ истек менее 24 часов назад - блокировала получение

**Новая логика:**
- Проверяет, был ли создан бесплатный ключ в последние 24 часа
- Если ключ создан в последние 24 часа - блокирует получение

### Ключевые изменения

1. **Время проверки**: Теперь проверяется `created_at` вместо `expiry_at`
2. **Условие блокировки**: `k.created_at > day_ago` (создан в последние 24 часа)
3. **Гранулярность**: Отдельно для каждого протокола и страны

## Тестирование

### Создан тест `test_free_limit.py`
Проверяет логику для:
- Outline без указания страны
- Outline для конкретной страны
- V2Ray без указания страны  
- V2Ray для конкретной страны
- Разные страны (Россия, Нидерланды)

### Создан тест `test_real_user.py`
Тестирует с реальным пользователем, у которого есть недавний бесплатный ключ.

## Результаты тестирования

### ✅ Логика работает корректно:

**Пользователь 6358556135** получил бесплатный V2Ray ключ в Нидерланды 05.08.2025 01:02:14

**Результаты проверки:**
- ❌ V2Ray в Нидерланды: **Лимит превышен** (нельзя получить)
- ✅ V2Ray в России: **Можно получить** (другая страна)
- ✅ Outline в Нидерланды: **Можно получить** (другой протокол)

## Преимущества новой логики

1. **Точное ограничение**: Ровно 1 раз в 24 часа для каждой комбинации протокол+страна
2. **Гибкость**: Можно получить бесплатный ключ для другого протокола или страны
3. **Справедливость**: Ограничение применяется независимо для каждого направления
4. **Простота**: Логика стала более понятной и предсказуемой

## Технические детали

### SQL запросы обновлены:

**Outline с указанием страны:**
```sql
SELECT k.created_at FROM keys k
JOIN tariffs t ON k.tariff_id = t.id
JOIN servers s ON k.server_id = s.id
WHERE k.user_id = ? AND t.price_rub = 0 AND s.country = ?
AND k.created_at > ?
ORDER BY k.created_at DESC LIMIT 1
```

**V2Ray с указанием страны:**
```sql
SELECT k.created_at FROM v2ray_keys k
JOIN tariffs t ON k.tariff_id = t.id
JOIN servers s ON k.server_id = s.id
WHERE k.user_id = ? AND t.price_rub = 0 AND s.country = ?
AND k.created_at > ?
ORDER BY k.created_at DESC LIMIT 1
```

### Обратная совместимость

Функция `check_free_tariff_limit()` обновлена для использования новой логики:
```python
def check_free_tariff_limit(cursor, user_id):
    """Проверка лимита бесплатных ключей (для обратной совместимости)"""
    return check_free_tariff_limit_by_protocol_and_country(cursor, user_id, "outline")
```

## Статус развертывания

- ✅ Код обновлен
- ✅ Тесты пройдены
- ✅ Сервис перезапущен
- ✅ Логика работает корректно

## Заключение

Новая логика ограничения бесплатных тарифов успешно внедрена и протестирована. Пользователи теперь могут получать бесплатный тариф только 1 раз в 24 часа для каждой комбинации протокол+страна, что обеспечивает справедливое использование ресурсов. 
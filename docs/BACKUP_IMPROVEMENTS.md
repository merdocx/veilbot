# Улучшения системы резервного копирования

## Дата внедрения: 2025-12-18

## Выполненные улучшения

### 1. ✅ Уведомления об ошибках бэкапов в Telegram

**Что сделано:**
- Добавлена функция `send_telegram_notification()` в скрипт `backup_db.sh`
- Автоматическая отправка уведомлений администратору при ошибках:
  - Файл БД не найден
  - Ошибка проверки целостности исходной БД
  - Ошибка создания бэкапа
  - Подозрительно малый размер бэкапа
  - Ошибка проверки целостности бэкапа

**Как работает:**
- Скрипт автоматически получает токен бота и ID администратора из настроек приложения
- Уведомления отправляются через Telegram API
- При успешном ежедневном бэкапе (в полночь) отправляется информационное уведомление

### 2. ✅ Увеличение периода хранения бэкапов

**Что сделано:**
- Реализована многоуровневая политика хранения:
  - **48 часовых бэкапов** (последние 2 дня) - в основной директории
  - **7 ежедневных бэкапов** (последняя неделя) - в подкаталоге `daily/`
  - **4 еженедельных бэкапа** (последний месяц) - в подкаталоге `weekly/`

**Структура директорий:**
```
/var/backups/veilbot/
├── vpn.db.*.sqlite3          # Часовые бэкапы (48 шт)
├── daily/
│   └── vpn.db.*.sqlite3      # Ежедневные бэкапы (7 шт)
└── weekly/
    └── vpn.db.*.sqlite3       # Еженедельные бэкапы (4 шт)
```

**Как работает:**
- Каждый час создается часовой бэкап
- В полночь (00:00) создается дополнительная копия в `daily/`
- В понедельник в полночь создается дополнительная копия в `weekly/`
- Автоматическая ротация старых бэкапов по политике

### 3. ✅ Проверка свежести бэкапов

**Что сделано:**
- Создан скрипт `scripts/check_backup_freshness.sh`
- Проверка времени последнего успешного бэкапа
- Уведомление администратора, если бэкап старше 2 часов
- Защита от спама уведомлений (cooldown 1 час)

**Расписание:**
- Запускается каждые 30 минут через cron: `*/30 * * * *`

**Как работает:**
- Проверяет файл `.last_backup_timestamp` или время модификации последнего бэкапа
- Если бэкап старше 2 часов - отправляет уведомление
- Если бэкапы не найдены - отправляет критическое уведомление

### 4. ✅ Оптимизация расписания

**Что сделано:**
- Обновлен cron с новыми задачами
- Убрано дублирование функций
- Четкое разделение ответственности:
  - Cron: резервное копирование каждый час
  - Systemd timer: обслуживание БД (VACUUM, оптимизация) раз в день в 03:17

**Текущее расписание cron:**
```
0 * * * *     - Резервное копирование БД (каждый час)
*/30 * * * *  - Проверка свежести бэкапов (каждые 30 минут)
0 2 * * *     - Ротация логов (ежедневно)
0 3 * * *     - Очистка старых данных (ежедневно)
30 */6 * * *  - Проверка здоровья системы (каждые 6 часов)
0 4 * * *     - Синхронизация ключей с серверами (ежедневно)
0 2 * * 0     - Проверка целостности бэкапов (каждое воскресенье)
```

### 5. ✅ Проверка целостности бэкапов

**Что сделано:**
- Создан скрипт `scripts/verify_backup_integrity.sh`
- Проверка целостности последних 5 бэкапов
- Дополнительная проверка читаемости базы данных
- Отправка отчета администратору о результатах проверки

**Расписание:**
- Запускается каждое воскресенье в 02:00 через cron: `0 2 * * 0`

**Как работает:**
- Находит последние 5 бэкапов по времени модификации
- Для каждого бэкапа выполняет:
  - `PRAGMA integrity_check` - проверка целостности
  - `SELECT COUNT(*) FROM sqlite_master` - проверка читаемости
- Формирует отчет и отправляет в Telegram
- При обнаружении проблемных бэкапов отправляет критическое уведомление

## Улучшения в основном скрипте резервного копирования

### Новые функции в `backup_db.sh`:

1. **Проверка целостности исходной БД** перед созданием бэкапа
2. **Проверка размера бэкапа** после создания (предупреждение при подозрительно малом размере)
3. **Проверка целостности созданного бэкапа** перед завершением
4. **Улучшенная обработка ошибок** с детальными уведомлениями
5. **Многоуровневая ротация бэкапов** с автоматическим созданием ежедневных и еженедельных копий

## Файлы

### Измененные файлы:
- `/root/veilbot/backup_db.sh` - улучшенный скрипт резервного копирования

### Новые файлы:
- `/root/veilbot/scripts/check_backup_freshness.sh` - проверка свежести бэкапов
- `/root/veilbot/scripts/verify_backup_integrity.sh` - проверка целостности бэкапов

### Обновленные конфигурации:
- `/var/spool/cron/crontabs/root` - обновленное расписание cron

## Мониторинг

### Логи:
- `/var/log/veilbot/backup_db.log` - основной лог резервного копирования
- `/var/log/veilbot/backup_freshness_check.log` - лог проверки свежести (если перенаправлен)
- `/var/log/veilbot/backup_verify.log` - лог проверки целостности

### Метки времени:
- `/var/backups/veilbot/.last_backup_timestamp` - время последнего успешного бэкапа (Unix timestamp)
- `/var/backups/veilbot/.last_backup_file` - путь к последнему бэкапу

## Тестирование

Для проверки работы улучшений:

```bash
# Тест резервного копирования
/bin/bash /root/veilbot/backup_db.sh

# Тест проверки свежести
/bin/bash /root/veilbot/scripts/check_backup_freshness.sh

# Тест проверки целостности
/bin/bash /root/veilbot/scripts/verify_backup_integrity.sh
```

## Рекомендации на будущее

1. **Удаленное хранение бэкапов** - рассмотреть синхронизацию с S3 или другим удаленным хранилищем
2. **Шифрование бэкапов** - добавить опциональное шифрование чувствительных данных
3. **Автоматическое восстановление** - добавить тестирование восстановления из бэкапа
4. **Метрики** - добавить сбор метрик о размере бэкапов, времени создания и т.д.


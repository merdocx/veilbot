# –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø—Ä–æ—Ç–æ–∫–æ–ª–∞) —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Outline –∏ V2Ray –∏–º–µ–ª–∏ —Ä–∞–∑–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:
- **Outline**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `format_key_message()` - –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ
- **V2Ray**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `format_key_message_with_protocol()` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ –∏ —Ç–∞—Ä–∏—Ñ–µ

## –†–µ—à–µ–Ω–∏–µ
–°–æ–∑–¥–∞–Ω–∞ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `format_key_message_unified()` –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```python
def format_key_message_unified(config: str, protocol: str, tariff: dict = None) -> str:
    """–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤"""
    protocol_info = PROTOCOLS[protocol]
    
    # –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    message = (
        f"*–í–∞—à –∫–ª—é—á {protocol_info['icon']} {protocol_info['name']}* (–∫–æ—Å–Ω–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):\n"
        f"`{config}`\n\n"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–∏—Ñ–µ, –µ—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞
    if tariff:
        message += (
            f"üì¶ –¢–∞—Ä–∏—Ñ: *{tariff['name']}*\n"
            f"‚è± –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: *{format_duration(tariff['duration_sec'])}*\n\n"
        )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
    message += (
        f"üîß *–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:*\n"
        f"{get_protocol_instructions(protocol)}"
    )
    
    return message
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–º–µ–Ω—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

**–î–ª—è Outline:**
```python
# –ë—ã–ª–æ:
await message.answer(format_key_message(key["accessUrl"]), ...)

# –°—Ç–∞–ª–æ:
await message.answer(format_key_message_unified(key["accessUrl"], new_protocol, tariff), ...)
```

**–î–ª—è V2Ray:**
```python
# –ë—ã–ª–æ:
await message.answer(format_key_message_with_protocol(config, new_protocol, tariff), ...)

# –°—Ç–∞–ª–æ:
await message.answer(format_key_message_unified(config, new_protocol, tariff), ...)
```

## –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

### –î–ª—è Outline:
```
üîí –í–∞—à –∫–ª—é—á Outline VPN (–∫–æ—Å–Ω–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):
`ss://...`

üì¶ –¢–∞—Ä–∏—Ñ: –ú–µ—Å—è—Ü
‚è± –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 30 –¥–Ω–µ–π

üîß –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Outline:
   ‚Ä¢ App Store
   ‚Ä¢ Google Play
2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä¬ª –∏–ª–∏ ¬´+¬ª
3. –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤—ã—à–µ
```

### –î–ª—è V2Ray:
```
üõ°Ô∏è –í–∞—à –∫–ª—é—á V2Ray VLESS (–∫–æ—Å–Ω–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):
`vless://...`

üì¶ –¢–∞—Ä–∏—Ñ: –ú–µ—Å—è—Ü
‚è± –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 30 –¥–Ω–µ–π

üîß –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ V2Ray –∫–ª–∏–µ–Ω—Ç:
   ‚Ä¢ App Store
   ‚Ä¢ Google Play
2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´+¬ª
3. –í—ã–±–µ—Ä–∏—Ç–µ ¬´–ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞¬ª
4. –í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤—ã—à–µ
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 1. –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ
- –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
- –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å

### 2. –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
- –í—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ (–∏–∫–æ–Ω–∫–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–µ –∏ —Å—Ä–æ–∫–µ –¥–µ–π—Å—Ç–≤–∏—è
- –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

### 3. –ì–∏–±–∫–æ—Å—Ç—å
- –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `tariff`
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —Å —Ç–∞—Ä–∏—Ñ–æ–º, —Ç–∞–∫ –∏ –±–µ–∑ –Ω–µ–≥–æ
- –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤

## –°—Ç–∞—Ç—É—Å
- ‚úÖ –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ Outline —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ V2Ray —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- ‚úÖ –ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ, —Ç–∞—Ä–∏—Ñ–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (2025-08-03)

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ V2Ray –∫–ª—é—á–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞ V2Ray –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π email `#VeilBot-V2Ray` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_user_config` –≤ V2Ray –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `vpn_protocols.py`

**–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_user_config`:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä email –≤ server_config
email = server_config.get('email', 'VeilBot-V2Ray')

# –û–±–Ω–æ–≤–ª–µ–Ω fallback –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
return f"vless://{user_id}@{domain}:{port}?encryption=none&security=reality&sni=www.microsoft.com&fp=chrome&pbk=TJcEEU2FS6nX_mBo-qXiuq9xBaP1nAcVia1MlYyUHWQ&sid=827d3b463ef6638f&spx=/&type=tcp&flow=#{email}"
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `bot.py`

**–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `change_protocol_for_key` –∏ `reissue_specific_key`:**
```python
# –ü–µ—Ä–µ–¥–∞—á–∞ email –≤ server_config
config = await protocol_client.get_user_config(user_data['uuid'], {
    'domain': domain,
    'port': 443,
    'path': v2ray_path or '/v2ray',
    'email': old_email or f"user_{user_id}@veilbot.com"  # –î–æ–±–∞–≤–ª–µ–Ω email
})
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç

**–¢–µ–ø–µ—Ä—å V2Ray –∫–ª—é—á–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:**
```
vless://8287ec93-b222-47cb-9aeb-bc73898a3c27@veil-bird.ru:443?encryption=none&security=reality&sni=www.microsoft.com&fp=chrome&pbk=eeA7CJSPNzlYKqXAsRfFNwtcpG2wXOtgDLPqaXBV13c&sid=2680beb40ea2fde0&spx=/&type=tcp&flow=#nvipetrenko@gmail.com
```

**–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:**
```
vless://8287ec93-b222-47cb-9aeb-bc73898a3c27@veil-bird.ru:443?encryption=none&security=reality&sni=www.microsoft.com&fp=chrome&pbk=eeA7CJSPNzlYKqXAsRfFNwtcpG2wXOtgDLPqaXBV13c&sid=2680beb40ea2fde0&spx=/&type=tcp&flow=#VeilBot-V2Ray
```

### –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é V2Ray
- ‚úÖ Fallback –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π email
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ —Å–º–µ–Ω—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏ –ø–µ—Ä–µ–≤—ã–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ –°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

## –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ
–¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ V2Ray –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–ª—é—á–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º email –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–ª—é—á–µ–π –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö. 
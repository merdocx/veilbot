# Руководство по UI-киту VeilBot Admin

## 1. Обзор

Этот документ описывает принципы построения интерфейса админ-панели VeilBot, структуру CSS/JS-кода и процессы проверки качества. Цель — обеспечить единообразие страниц, ускорить разработку и упростить будущую поддержку.

### Быстрый старт

```bash
# Установить инструменты фронтенд-пайплайна (однократно)
npm install

# Запустить линтеры CSS/JS
npm run lint

# Проверить всё: линтеры + pytest
npm test

# Отформатировать UI-код и документацию
npm run format
```

> ⚠️ Node-пакеты не хранятся в репозитории — после клонирования выполните `npm install`, чтобы создать `node_modules/` и `package-lock.json`.

## 2. Структура UI-кита

```
admin/
├── static/
│   ├── css/material-admin.css   # Дизайн-токены, компоненты и утилиты
│   └── js/
│       ├── common.js            # Базовые хелперы и контроллеры
│       ├── keys.js              # Логика страницы ключей
│       ├── payments.js          # Логика страницы платежей
│       └── ...
└── templates/                   # HTML-шаблоны Jinja2
```

### 2.1 Дизайн‑токены (`material-admin.css`)

| Токен             | Значение    | Использование                           |
|-------------------|-------------|-----------------------------------------|
| `--primary`       | `#1976d2`   | Основные элементы, состояние `focus`    |
| `--success`       | `#4caf50`   | Успешные статусы/баджи                  |
| `--warning`       | `#ff9800`   | Предупреждения, акценты                 |
| `--error`         | `#f44336`   | Ошибки, критические статусы             |
| `--surface`       | `#ffffff`   | Фон карточек и модалок                  |
| `--text-primary`  | `#212121`   | Основной текст                          |
| `--text-secondary`| `#757575`   | Подписи, вторичный текст                |
| `--divider`       | `#e0e0e0`   | Разделители, границы                    |

### 2.2 Базовые компоненты

- **Карточки**: `.card`, `.card-header`, `.card-body`, `.card-actions`
- **Статистика**: `.stats-grid`, `.stat-card`, интерактивные карточки — `.stat-card--action`
- **Таблицы**: `.table-scroll`, `.material-table`, модификаторы `--compact`
- **Оповещения**: `.alert` + модификаторы `alert--success|warning|danger`
- **Бэйджи**: `.badge` + модификаторы `badge-success|warning|error|info|neutral`
- **Модалки**: макрос `components/modal.html` + `ModalController` из `common.js`
- **Формы**: `.form-grid`, `.form-control`, `.filter-bar`
- **Утилиты**: `grid-two`, `stack-actions`, `actions-inline`, `input-inline`, `page-hero` и др.

Полный список утилит и их назначение см. в исходнике `material-admin.css` (разделы «Utilities», «Responsive adjustments», «Accessibility»).

### 2.3 JavaScript-архитектура

| Файл                     | Зона ответственности                                   |
|--------------------------|--------------------------------------------------------|
| `common.js`              | Debounce, уведомления, модалки, data-confirm, go-back, обновление прогрессбаров |
| `keys.js`                | AJAX-редактирование ключей, статистика, модалки       |
| `payments.js`            | Реконсиляция, фильтрация, удаление платежей           |
| `userDetail.js`          | Повторная отправка/продление ключей, действия по платежам |
| `servers.js`, `editServer.js` | Фильтры и формы серверов                          |

**Правила для новых модулей:**

1. Работайте в модульном режиме (`type="module"`).
2. Все общие хелперы импортируйте из `common.js`.
3. Повторно используйте data-атрибуты (`data-*`) вместо inline JS.
4. Добавляйте инициализацию через `DOMContentLoaded`, если нужна отложенная логика.
5. Учитывайте `prefers-reduced-motion` и доступность (ARIA-атрибуты, фокус-циклы).

## 3. Практики доступности

- **Навигация с клавиатуры**: skip-link (`data-go-back` + `attachBackHandlers`), `tabindex="-1"` для `#main-content`.
- **Фокус**: используйте классы, уже подсвеченные в CSS (`:focus-visible`).
- **Диалоги**: `ModalController` автоматически управляет фокусом и атрибутами `aria-hidden/aria-modal`.
- **Подтверждения**: заменяйте inline `confirm` на `data-confirm`. `common.js` обрабатывает клики/submit.
- **Уведомления**: `showNotification` объявляет `role=alert|status` и живые регионы.

## 4. Workflow разработки

1. **Создайте ветку**, внесите правки в шаблоны/JS/CSS.
2. Запустите проверки:
   ```bash
   npm run lint       # eslint + stylelint
   npm test           # lint + python -m pytest
   ```
3. При форматировании используйте `npm run format` (применяется к CSS, JS, HTML, MD).
4. Обновите документацию (`docs/ADMIN_UI_GUIDE.md`, `docs/CHANGELOG.md`) при добавлении новых компонентов/утилит.

## 5. Build/test пайплайн

`package.json` содержит единый интерфейс команд:

| Команда            | Назначение                                            |
|--------------------|-------------------------------------------------------|
| `npm run lint:js`  | Проверка `admin/static/js` (ESLint `eslint.config.mjs`) |
| `npm run lint:css` | Проверка `admin/static/css` (Stylelint)               |
| `npm run lint`     | JS + CSS                                              |
| `npm run format`   | Применение Prettier к CSS/JS/HTML/MD                  |
| `npm run test:py`  | `python -m pytest` (все бэкенд-тесты)                 |
| `npm test`         | Линтеры + pytest                                      |

### CI/CD (рекомендации)

В пайплайне CI достаточно вызвать:

```bash
npm install
npm test
```

Это гарантирует, что UI-код проходит линтеры, а проект — бэкенд-тесты. При необходимости можно добавить `npm run format -- --check`, чтобы проверить стиль без автоисправлений (`prettier --check`).

## 6. Добавление новых компонентов

1. **CSS**: разместите новые правила рядом с существующими разделами (`Buttons`, `Tables`, `Alerts` и т.д.). Опирайтесь на токены и утилиты.
2. **HTML**: используйте готовые классы. При необходимости вынесите повторяющийся блок в Jinja2-макрос.
3. **JS**: вынесите логику в отдельный модуль и подключите его через `extra_scripts` соответствующего шаблона.
4. **Документация**: опишите компонент и его назначение в этом документе. Добавьте примеры вызова/классов.

## 7. Чеклист перед PR

- [ ] Нет inline-стилей и JS в шаблонах.
- [ ] Использованы существующие компоненты/утилиты, либо добавлены новые и задокументированы.
- [ ] Добавлены/обновлены тесты, если изменена логика на бэкенде.
- [ ] Выполнены `npm run lint` и `npm test`.
- [ ] Обновлён `docs/CHANGELOG.md` (секция `[Unreleased]`).

---

При улучшении UI-кита обновляйте документ, чтобы команда оставалась в курсе доступных компонентов и правил работы с ними. Рассматривайте `docs/ADMIN_UI_GUIDE.md` как «живой» справочник.

